<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Parroquial</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⛪</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- Base y Diseño Neumorfista --- */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #eef0f4;
            color: #4b5563;
            transition: background-color 0.5s ease, color 0.5s ease;
        }
        .fade-out {
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease-out;
        }
        #app-loading {
            position: fixed; inset: 0; display: flex; align-items: center; justify-content: center;
            background-color: #eef0f4; z-index: 100; font-size: 1.25rem; color: #4b5563;
        }
        #app-container { opacity: 0; transition: opacity 0.3s ease-in-out; }
        #app-container.loaded { opacity: 1; }
        .page { display: none; }
        .page.active { display: block; }

        /* --- Visibilidad del Administrador --- */
        .admin-only, .admin-only-table-cell { display: none !important; }
        .admin-mode .admin-only { display: inline-flex !important; }
        .admin-mode .admin-only-block { display: block !important; }
        .admin-mode .admin-only-table-cell { display: table-cell !important; }
        .super-admin-only { display: none !important; }
        .super-admin-mode .super-admin-only { display: flex !important; }
        .super-admin-mode .super-admin-only-table-cell { display: table-cell !important; }

        /* Tarjeta Neumorfista (Extruida) */
        .neumorphic-card {
            background: #eef0f4;
            border-radius: 20px;
            box-shadow: 8px 8px 16px #d1d9e6, -8px -8px 16px #ffffff;
            transition: background-color 0.5s ease, box-shadow 0.5s ease;
        }

        /* Estilo Presionado (Intruido) */
        .neumorphic-inset {
            box-shadow: inset 6px 6px 12px #d1d9e6, inset -6px -6px 12px #ffffff;
             transition: box-shadow 0.5s ease;
        }

        /* Botones Neumorfistas */
        .neumorphic-btn {
            padding: 0.5rem 1rem; border-radius: 10px; border: none; background: #eef0f4;
            box-shadow: 4px 4px 8px #d1d9e6, -4px -4px 8px #ffffff; color: #4b5563;
            font-weight: 500; transition: all 0.2s ease-in-out; cursor: pointer;
            display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;
        }
        .neumorphic-btn:hover { box-shadow: 2px 2px 4px #d1d9e6, -2px -2px 4px #ffffff; }
        .neumorphic-btn:active, .neumorphic-btn.active {
            box-shadow: inset 4px 4px 8px #d1d9e6, inset -4px -4px 8px #ffffff; color: #3b82f6;
        }
        .neumorphic-btn.primary { color: #3b82f6; font-weight: 600; }
        .neumorphic-btn.danger { color: #ef4444; }
        .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.875rem; }
        .neumorphic-btn:disabled {
            cursor: not-allowed; opacity: 0.7;
            box-shadow: inset 2px 2px 4px #d1d9e6, inset -2px -2px 4px #ffffff;
        }

        /* --- Icon Navigation Buttons (From Uiverse.io by Github-Suriya, adapted) --- */
        .icon-nav-btn {
            display: grid;
            place-items: center;
            background: #e3edf7;
            padding: 1em;
            border-radius: 10px;
            box-shadow: 6px 6px 10px -1px rgba(0, 0, 0, 0.15),
                        -6px -6px 10px -1px rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(0, 0, 0, 0);
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
            color: #4b5563;
        }
        .icon-nav-btn:hover {
            box-shadow: inset 4px 4px 6px -1px rgba(0, 0, 0, 0.2),
                        inset -4px -4px 6px -1px rgba(255, 255, 255, 0.7),
                        -0.5px -0.5px 0px rgba(255, 255, 255, 1),
                        0.5px 0.5px 0px rgba(0, 0, 0, 0.15), 0px 12px 10px -10px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(0, 0, 0, 0.1);
            transform: translateY(0.25em);
        }
        .icon-nav-btn svg {
            width: 28px;
            height: 28px;
            transition: transform 0.3s, fill 0.3s;
            fill: currentColor;
        }
        .icon-nav-btn:hover svg {
            transform: scale(0.9);
            fill: #3b82f6;
        }
        .icon-nav-btn.active {
            box-shadow: inset 4px 4px 8px #d1d9e6, inset -4px -4px 8px #ffffff;
            color: #3b82f6;
            transform: none;
        }
        .icon-nav-btn.active svg { transform: scale(0.9); }

        /* --- Social Media Buttons --- */
        .social-btn { padding: 0.8em; }
        .social-btn svg { width: 24px; height: 24px; }
        .social-btn:hover.facebook svg { fill: #1877F2; }
        .social-btn:hover.instagram svg { fill: #E4405F; }
        .social-btn:hover.youtube svg { fill: #FF0000; }
        .social-btn:hover.whatsapp svg { fill: #25D366; }
        body.dark-theme .social-btn:hover.facebook svg { fill: #1877F2; }
        body.dark-theme .social-btn:hover.instagram svg { fill: #E4405F; }
        body.dark-theme .social-btn:hover.youtube svg { fill: #FF0000; }
        body.dark-theme .social-btn:hover.whatsapp svg { fill: #25D366; }

        /* --- Mobile Nav Button --- */
        .mobile-nav-btn {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem 1rem;
            border-radius: 10px;
            font-size: 1.125rem;
            font-weight: 500;
            width: 100%;
            color: #4b5563;
            transition: all 0.2s ease-in-out;
            border: none;
            background: transparent;
        }
        .mobile-nav-btn.active {
            box-shadow: inset 4px 4px 8px #d1d9e6, inset -4px -4px 8px #ffffff;
            color: #3b82f6;
        }
        .mobile-nav-btn svg {
            width: 24px;
            height: 24px;
            fill: currentColor;
            flex-shrink: 0;
        }
        
        /* Campos de Formulario */
        .neumorphic-input {
            width: 100%; background: #eef0f4; border: none; border-radius: 10px;
            padding: 0.75rem 1rem;
            box-shadow: inset 4px 4px 8px #d1d9e6, inset -4px -4px 8px #ffffff;
            transition: background-color 0.5s ease, box-shadow 0.5s ease, color 0.5s ease;
            color: #4b5563;
        }
        .neumorphic-input:focus { outline: none; }
        textarea.neumorphic-input { resize: none; }

        /* Estilos del Calendario */
        .calendar-cell {
            min-height: 100px; padding: 0.25rem; border-radius: 10px; background: #eef0f4;
            transition: all 0.2s ease-in-out; border: 1px solid transparent; display: flex; flex-direction: column;
        }
        @media (min-width: 768px) { .calendar-cell { min-height: 120px; padding: 0.5rem; } }
        .calendar-cell.is-today { box-shadow: inset 4px 4px 8px #d1d9e6, inset -4px -4px 8px #ffffff; border-color: #3b82f6; }
        .calendar-day-number { font-weight: 600; margin-bottom: 0.25rem; }
        .calendar-items-container { flex-grow: 1; overflow-y: auto; }
        .calendar-item {
            font-size: 0.75rem; padding: 2px 6px; border-radius: 6px; margin-bottom: 4px;
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap; cursor: default;
        }
        .event-item { background-color: #bfdbfe; color: #1e40af; }
        .birthday-item { background-color: #fef08a; color: #854d0e; }

        /* Estilos del Panel Edge Móvil */
        #mobile-sidenav-overlay {
            position: fixed; inset: 0; background-color: rgba(31, 41, 55, 0.5); z-index: 55;
            opacity: 0; transition: opacity 0.3s ease-in-out; pointer-events: none;
        }
        #mobile-sidenav {
            position: fixed; top: 0; left: 0; bottom: 0; width: 280px; background-color: #eef0f4;
            z-index: 60; transform: translateX(-100%); padding: 1.5rem; display: flex; flex-direction: column; will-change: transform;
            transition: transform 0.3s ease-in-out, background-color 0.5s ease;
        }
        #mobile-sidenav.active { transform: translateX(0); }
        #mobile-sidenav-overlay.active { opacity: 1; pointer-events: auto; }
        #edge-handle {
            position: fixed; top: 50%; left: 0; transform: translateY(-50%); width: 28px;
            height: 100px; border-top-right-radius: 0.5em; border-bottom-right-radius: 0.5em;
            background: #e3edf7;
            box-shadow: 4px 6px 10px -1px rgba(0, 0, 0, 0.15),
                        -4px -6px 10px -1px rgba(255, 255, 255, 0.7);
            cursor: pointer; transition: all 0.3s;
            z-index: 50; display: flex; align-items: center; justify-content: center;
            color: #4b5563;
        }
        #edge-handle:active {
             box-shadow: inset 2px 2px 4px rgba(0, 0, 0, 0.2),
                        inset -2px -2px 4px rgba(255, 255, 255, 0.7);
        }
        #edge-handle svg {
            width: 24px; height: 24px; fill: currentColor;
        }

        /* Estilos de la Galería de Noticias */
        .gallery-thumbnail {
            width: 80px; height: 60px; border-radius: 8px; cursor: pointer; object-fit: cover;
            opacity: 0.6; transition: all 0.2s ease-in-out; border: 2px solid transparent; flex-shrink: 0;
        }
        .gallery-thumbnail.active { opacity: 1; border-color: #3b82f6; box-shadow: 0 0 0 3px #eef0f4; }
        #news-gallery-thumbnails { -ms-overflow-style: none; scrollbar-width: none; }
        #news-gallery-thumbnails::-webkit-scrollbar { display: none; }

        /* Estilos de Acordeón */
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out; }
        .accordion-icon { transition: transform 0.3s ease-in-out; }
        .accordion-toggle.active .accordion-icon { transform: rotate(180deg); }

        /* --- Estilo de Interruptores Personalizados (From Uiverse.io by Cksunandh) --- */
        label.custom-switch {
          transform: scale(0.8); display: block; width: 100px; height: 50px;
          border-radius: 25px; background: linear-gradient(to bottom, #9e9e9e 30%, #f4f4f4);
          box-shadow: 0 1px 0 0 #fff, 0 -1px 0 0 #969494; position: relative;
          -webkit-tap-highlight-color: rgba(255, 255, 255, 0);
        }
        label.custom-switch input { display: none; }
        label.custom-switch div {
          display: block; width: 80px; height: 30px; position: absolute;
          left: 50%; top: 50%; transform: translate(-50%, -50%);
          background: linear-gradient(to bottom, #8b8c8e 20%, #f4f4f4);
          border-radius: 15px; transition: 0.2s;
        }
        label.custom-switch div:after {
          content: ""; position: absolute; display: block; height: 28px;
          width: 78px; left: 1px; top: 1px; border-radius: 14px;
          background: #828080; box-shadow: inset 0 0 15px 0 rgba(0, 0, 0, 0.8);
          transition: 0.2s;
        }
        label.custom-switch i {
          display: block; width: 40px; height: 40px; position: absolute;
          background: linear-gradient(to top, #9e9e9e 20%, #f4f4f4);
          border-radius: 50%; box-shadow: 0 3px 5px 0 rgba(0, 0, 0, 0.7);
          top: 5px; left: 5px; transition: 0.25s;
        }
        label.custom-switch i:after {
          content: ""; position: absolute; display: block; width: 34px;
          height: 34px; left: 3px; top: 3px; border-radius: 50%;
          background: #d5d4d4; z-index: 1;
        }
        label.custom-switch input:checked ~ i { top: 5px; left: 54px; }
        label.custom-switch input:checked + div:after { background: #0f0; box-shadow: inset 0 0 15px 0 rgba(0, 0, 0, 0.6); }
        label.custom-switch input:checked + div > .off { color: transparent; text-shadow: 0 1px 0 rgba(255, 255, 255, 0); }
        label.custom-switch input:checked + div > .on { color: hsl(24, 2%, 49%); text-shadow: 0 1px 0 rgba(255, 255, 255, 0.3); }
        label.custom-switch input:not(:checked) + div:after { background: #f00; box-shadow: inset 0 0 15px 0 rgba(0, 0, 0, 0.6); }
        label.custom-switch input:not(:checked) + div > .on { color: transparent; text-shadow: 0 1px 0 rgba(255, 255, 255, 0); }
        label.custom-switch input:not(:checked) + div > .off { color: #444; text-shadow: 0 1px 0 rgba(255, 255, 255, 0.2); }
        label.custom-switch:after {
          content: ""; position: absolute; display: block; width: 102px;
          height: 52px; border-radius: 26px; top: -1px; left: -1px; z-index: -1;
          background: linear-gradient(to bottom, #969494, #fff);
        }
        label.custom-switch:hover { cursor: pointer; }
        .on, .off {
          text-transform: uppercase; position: absolute; left: 12px;
          top: 50%; transform: translateY(-50%); font-size: 0.8em; font-weight: 600;
          z-index: 2; letter-spacing: 1px; transition: 0.25s;
        }
        .on { color: transparent; text-shadow: 0 1px 0 rgba(255, 255, 255, 0); }
        .off { left: initial; right: 12px; color: hsl(24, 2%, 49%); text-shadow: 0 1px 0 rgba(255, 255, 255, 0.2); }

        /* --- Pantalla de Bloqueo --- */
        #app-lockscreen {
             background-color: #eef0f4;
             transition: background-color 0.5s ease, opacity 0.5s ease-in-out;
        }

        /* --- Estilos del Interruptor de Desbloqueo (From Uiverse.io by chase2k25) --- */
        .unlock-switch-label.disabled { cursor: not-allowed; opacity: 0.5; }
        .switch-container {
          position: relative; width: 150px; height: 60px;
          background: #d6d6d6; border-radius: 50px;
          box-shadow: inset -8px -8px 16px #ffffff, inset 8px 8px 16px #b0b0b0;
        }
        .toggle-checkbox { display: none; }
        .switch {
          position: absolute; top: 50%; left: 0; width: 100%;
          height: 100%; transform: translateY(-50%);
          border-radius: 50px; overflow: hidden; cursor: pointer;
        }
        .toggle {
          position: absolute; width: 80px; height: 50px;
          background: linear-gradient(145deg, #d9d9d9, #bfbfbf); border-radius: 50px;
          top: 5px; left: 5px; box-shadow: -4px -4px 8px #ffffff, 4px 4px 8px #b0b0b0;
          transition: all 0.3s ease-in-out; display: flex; align-items: center;
          justify-content: flex-start; padding-left: 10px;
        }
        .led {
          width: 10px; height: 10px; background: grey; border-radius: 50%;
          box-shadow: 0 0 10px 2px rgba(0, 0, 0, 0.2); transition: all 0.3s ease-in-out;
        }
        .toggle-checkbox:checked + .switch .toggle {
          left: 65px; background: linear-gradient(145deg, #cfcfcf, #a9a9a9);
          box-shadow: -4px -4px 8px #ffffff, 4px 4px 8px #8a8a8a;
        }
        .toggle-checkbox:checked + .switch .led { background: yellow; box-shadow: 0 0 15px 4px yellow; }

        /* --- ESTILOS DEL INTERRUPTOR DE TEMA (UIVERSE.IO) --- */
        .theme-switch {
          --toggle-size: 24px; --container-width: 5.625em; --container-height: 2.5em;
          --container-radius: 6.25em; --container-light-bg: #3D7EAE; --container-night-bg: #1D1F2C;
          --circle-container-diameter: 3.375em; --sun-moon-diameter: 2.125em; --sun-bg: #ECCA2F;
          --moon-bg: #C4C9D1; --spot-color: #959DB1;
          --circle-container-offset: calc((var(--circle-container-diameter) - var(--container-height)) / 2 * -1);
          --stars-color: #fff; --clouds-color: #F3FDFF; --back-clouds-color: #AACADF;
          --transition: .5s cubic-bezier(0, -0.02, 0.4, 1.25);
          --circle-transition: .3s cubic-bezier(0, -0.02, 0.35, 1.17);
        }
        .theme-switch, .theme-switch *, .theme-switch *::before, .theme-switch *::after {
          box-sizing: border-box; margin: 0; padding: 0; font-size: var(--toggle-size);
        }
        .theme-switch__container {
          width: var(--container-width); height: var(--container-height);
          background-color: var(--container-light-bg); border-radius: var(--container-radius);
          overflow: hidden; cursor: pointer;
          box-shadow: 0em -0.062em 0.062em rgba(0, 0, 0, 0.25), 0em 0.062em 0.125em rgba(255, 255, 255, 0.94);
          transition: var(--transition); position: relative;
        }
        .theme-switch__checkbox { display: none; }
        .theme-switch__circle-container {
          width: var(--circle-container-diameter); height: var(--circle-container-diameter);
          background-color: rgba(255, 255, 255, 0.1); position: absolute;
          left: var(--circle-container-offset); top: var(--circle-container-offset);
          border-radius: var(--container-radius);
          box-shadow: inset 0 0 0 3.375em rgba(255, 255, 255, 0.1), inset 0 0 0 3.375em rgba(255, 255, 255, 0.1), 0 0 0 0.625em rgba(255, 255, 255, 0.1), 0 0 0 1.25em rgba(255, 255, 255, 0.1);
          display: flex; transition: var(--circle-transition); pointer-events: none;
        }
        .theme-switch__sun-moon-container {
          pointer-events: auto; position: relative; z-index: 2; width: var(--sun-moon-diameter);
          height: var(--sun-moon-diameter); margin: auto; border-radius: var(--container-radius);
          background-color: var(--sun-bg);
          box-shadow: 0.062em 0.062em 0.062em 0em rgba(254, 255, 239, 0.61) inset, 0em -0.062em 0.062em 0em #a1872a inset;
          filter: drop-shadow(0.062em 0.125em 0.125em rgba(0, 0, 0, 0.25)) drop-shadow(0em 0.062em 0.125em rgba(0, 0, 0, 0.25));
          overflow: hidden; transition: var(--transition);
        }
        .theme-switch__moon {
          transform: translateX(100%); width: 100%; height: 100%;
          background-color: var(--moon-bg); border-radius: inherit;
          box-shadow: 0.062em 0.062em 0.062em 0em rgba(254, 255, 239, 0.61) inset, 0em -0.062em 0.062em 0em #969696 inset;
          transition: var(--transition); position: relative;
        }
        .theme-switch__clouds {
          width: 1.25em; height: 1.25em; background-color: var(--clouds-color);
          border-radius: var(--container-radius); position: absolute; bottom: -0.625em;
          left: 0.312em;
          box-shadow: 0.937em 0.312em var(--clouds-color), -0.312em -0.312em var(--back-clouds-color), 1.437em 0.375em var(--clouds-color), 0.5em -0.125em var(--back-clouds-color), 2.187em 0 var(--clouds-color), 1.25em -0.062em var(--back-clouds-color), 2.937em 0.312em var(--clouds-color), 2em -0.312em var(--back-clouds-color), 3.625em -0.062em var(--clouds-color), 2.625em 0em var(--back-clouds-color), 4.5em -0.312em var(--clouds-color), 3.375em -0.437em var(--back-clouds-color), 4.625em -1.75em 0 0.437em var(--clouds-color), 4em -0.625em var(--back-clouds-color), 4.125em -2.125em 0 0.437em var(--back-clouds-color);
          transition: 0.5s cubic-bezier(0, -0.02, 0.4, 1.25);
        }
        .theme-switch__stars-container {
          position: absolute; color: var(--stars-color); top: -100%;
          left: 0.312em; width: 2.75em; height: auto; transition: var(--transition);
        }
        .theme-switch__checkbox:checked + .theme-switch__container { background-color: var(--container-night-bg); }
        .theme-switch__checkbox:checked + .theme-switch__container .theme-switch__circle-container { left: calc(100% - var(--circle-container-offset) - var(--circle-container-diameter)); }
        .theme-switch__checkbox:checked + .theme-switch__container .theme-switch__moon { transform: translate(0); }
        .theme-switch__checkbox:checked + .theme-switch__container .theme-switch__clouds { bottom: -4.062em; }
        .theme-switch__checkbox:checked + .theme-switch__container .theme-switch__stars-container { top: 50%; transform: translateY(-50%); }

        /* --- ESTILOS MODAL AUTH (UIVERSE.IO) --- */
        #user-auth-modal .content {
          width: 330px; padding: 40px 30px; background: #dde1e7;
          border-radius: 10px; box-shadow: -3px -3px 7px #ffffff73, 2px 2px 5px rgba(94,104,121,0.288);
        }
        #user-auth-modal .auth-tabs {
            display: flex; justify-content: space-around; margin-bottom: 25px;
            border-radius: 25px; background: #dde1e7;
            box-shadow: inset 2px 2px 5px #BABECC, inset -5px -5px 10px #ffffff73;
        }
        #user-auth-modal .auth-tab {
            width: 50%; padding: 10px; border: none; background: transparent;
            cursor: pointer; font-size: 18px; font-weight: 600;
            color: #595959; border-radius: 25px; transition: all 0.3s ease;
        }
        #user-auth-modal .auth-tab.active {
            color: #3498db; background: #dde1e7;
            box-shadow: 2px 2px 5px #BABECC, -5px -5px 10px #ffffff73;
        }
        #user-auth-modal .field {
          height: 50px; width: 100%; display: flex;
          position: relative; margin-top: 20px;
        }
        #user-auth-modal form .field:first-of-type { margin-top: 0; }
        #user-auth-modal .field .input {
          height: 100%; width: 100%; padding-left: 45px; outline: none; border: none;
          font-size: 18px; background: #dde1e7; color: #595959; border-radius: 25px;
          box-shadow: inset 2px 2px 5px #BABECC, inset -5px -5px 10px #ffffff73;
        }
        #user-auth-modal .field .input:focus { box-shadow: inset 1px 1px 2px #BABECC, inset -1px -1px 2px #ffffff73; }
        #user-auth-modal .field .input:focus ~ .label, #user-auth-modal .field .input:valid ~ .label { opacity: 0; }
        #user-auth-modal .field .span { position: absolute; color: #595959; width: 50px; line-height: 55px; }
        #user-auth-modal .field .label {
          position: absolute; top: 50%; transform: translateY(-50%);
          left: 45px; pointer-events: none; color: #666666; transition: opacity 0.2s ease;
        }
        #user-auth-modal .button {
          margin: 15px 0; width: 100%; height: 50px; font-size: 18px;
          line-height: 50px; font-weight: 600; background: #dde1e7; border-radius: 25px;
          border: none; outline: none; cursor: pointer; color: #595959;
          box-shadow: 2px 2px 5px #BABECC, -5px -5px 10px #ffffff73;
        }
        #user-auth-modal .button:focus {
          color: #3498db;
          box-shadow: inset 2px 2px 5px #BABECC, inset -5px -5px 10px #ffffff73;
        }
        
        /* --- ESTILOS DEL TEMA OSCURO --- */
        body.dark-theme { background-color: #1f2937; color: #d1d5db; }
        body.dark-theme .neumorphic-card { background: #374151; box-shadow: 8px 8px 16px #111827, -8px -8px 16px #4b5563; }
        body.dark-theme .neumorphic-inset { box-shadow: inset 6px 6px 12px #111827, inset -6px -6px 12px #4b5563; }
        body.dark-theme h1, body.dark-theme h2, body.dark-theme h3 { color: #f9fafb; }
        body.dark-theme p { color: #d1d5db; }
        body.dark-theme header p, body.dark-theme .text-gray-500 { color: #9ca3af; }
        body.dark-theme .neumorphic-btn {
            background: #374151; box-shadow: 4px 4px 8px #111827, -4px -4px 8px #4b5563; color: #d1d5db;
        }
        body.dark-theme .neumorphic-btn:hover { box-shadow: 2px 2px 4px #111827, -2px -2px 4px #4b5563; }
        body.dark-theme .neumorphic-btn:active, body.dark-theme .neumorphic-btn.active {
            box-shadow: inset 4px 4px 8px #111827, inset -4px -4px 8px #4b5563; color: #60a5fa;
        }
        body.dark-theme .neumorphic-btn.primary { color: #60a5fa; }
        body.dark-theme .neumorphic-btn.danger { color: #f87171; }
        
        body.dark-theme .icon-nav-btn {
            background: #374151;
            box-shadow: 6px 6px 10px -1px rgba(17, 24, 39, 0.7),
                        -6px -6px 10px -1px rgba(75, 85, 99, 0.5);
            border-color: rgba(0, 0, 0, 0);
            color: #d1d5db;
        }
        body.dark-theme .icon-nav-btn:hover {
            box-shadow: inset 4px 4px 6px -1px rgba(17, 24, 39, 0.8),
                        inset -4px -4px 6px -1px rgba(75, 85, 99, 0.5),
                        -0.5px -0.5px 0px rgba(75, 85, 99, 1),
                        0.5px 0.5px 0px rgba(17, 24, 39, 0.5),
                        0px 12px 10px -10px rgba(17, 24, 39, 0.2);
            border-color: rgba(75, 85, 99, 0.5);
        }
        body.dark-theme .icon-nav-btn:hover svg { fill: #60a5fa; }
        body.dark-theme .icon-nav-btn.active {
            box-shadow: inset 4px 4px 8px #111827, inset -4px -4px 8px #4b5563;
            color: #60a5fa;
        }

        body.dark-theme .mobile-nav-btn { color: #d1d5db; }
        body.dark-theme .mobile-nav-btn.active {
            box-shadow: inset 4px 4px 8px #111827, inset -4px -4px 8px #4b5563;
            color: #60a5fa;
        }
        
        body.dark-theme .neumorphic-input {
            background: #374151; box-shadow: inset 4px 4px 8px #111827, inset -4px -4px 8px #4b5563; color: #f9fafb;
        }
        body.dark-theme #mobile-sidenav { background-color: #374151; }

        /* Estilos Tema Oscuro para Interruptores Personalizados */
        body.dark-theme label.custom-switch { background: #2a3341; box-shadow: 0 1px 0 0 #4b5563, 0 -1px 0 0 #111827; }
        body.dark-theme label.custom-switch div { background: #2a3341; }
        body.dark-theme label.custom-switch i { background: #374151; }
        body.dark-theme label.custom-switch i:after { background: #4b5563; }
        body.dark-theme label.custom-switch:after { background: linear-gradient(to bottom, #111827, #4b5563); }
        body.dark-theme label.custom-switch input:not(:checked) + div > .off,
        body.dark-theme label.custom-switch input:checked + div > .on {
            color: #d1d5db; text-shadow: 0 1px 0 rgba(0, 0, 0, 0.3);
        }

        /* --- ESTILOS DEL WIDGET DEL CLIMA ANIMADO --- */
        #weather-widget { background: linear-gradient(to bottom, #87CEEB, #4682B4); transition: background 0.8s ease-in-out; }
        #weather-widget.night { background: linear-gradient(to bottom, #000033, #2c3e50); }
        #weather-widget .sun {
            position: absolute; top: 20%; left: 20%; width: 50px; height: 50px;
            background: #FFD700; border-radius: 50%; box-shadow: 0 0 25px rgba(255, 215, 0, 0.7);
            animation: spin 20s linear infinite;
        }
        #weather-widget .cloud {
            position: absolute; background: rgba(242, 249, 254, 0.8); border-radius: 20px;
            width: 100px; height: 30px; animation: move-cloud 25s linear infinite alternate;
            filter: drop-shadow(0 2px 5px rgba(0,0,0,0.2));
        }
        #weather-widget .cloud:before { content: ''; position: absolute; background: inherit; border-radius: 50%; width: 50px; height: 50px; top: -25px; left: 15px; }
        #weather-widget .cloud:after { content: ''; position: absolute; background: inherit; border-radius: 50%; width: 60px; height: 60px; top: -20px; right: 10px; }
        #weather-widget .cloud1 { top: 30%; left: -120px; animation-duration: 25s; }
        #weather-widget .cloud2 { top: 50%; left: -150px; animation-duration: 35s; animation-delay: -10s; }
        #weather-widget .rain .drop {
            position: absolute; bottom: 100%; width: 2px; height: 20px;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0.5));
            animation: drop 0.7s linear infinite;
        }
        #weather-widget .stars { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        #weather-widget .star {
            position: absolute; width: 2px; height: 2px; background-color: white;
            border-radius: 50%; animation: twinkle 1.5s infinite alternate;
        }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes move-cloud { from { transform: translateX(0px); } to { transform: translateX(350px); } }
        @keyframes drop { 0% { transform: translateY(0vh); } 75% { transform: translateY(20vh); } 100% { transform: translateY(20vh); opacity: 0; } }
        @keyframes twinkle { 0% { opacity: 0.5; box-shadow: 0 0 2px white; } 100% { opacity: 1; box-shadow: 0 0 5px white; } }

        body.dark-theme #edge-handle {
            background: #374151;
            box-shadow: 4px 6px 10px -1px rgba(17, 24, 39, 0.7),
                        -4px -6px 10px -1px rgba(75, 85, 99, 0.5);
            color: #d1d5db;
        }
        body.dark-theme #edge-handle:active {
            box-shadow: inset 2px 2px 4px rgba(17, 24, 39, 0.8),
                        inset -2px -2px 4px rgba(75, 85, 99, 0.5);
        }
        
        body.dark-theme .calendar-cell { background: #374151; }
        body.dark-theme .calendar-cell.is-today { box-shadow: inset 4px 4px 8px #111827, inset -4px -4px 8px #4b5563; border-color: #60a5fa; }
        body.dark-theme table thead { border-color: #4b5563; }
        body.dark-theme table tr { border-color: rgba(75, 85, 99, 0.5); }
        body.dark-theme #app-lockscreen { background-color: #1f2937; }
        body.dark-theme #lockscreen-time, body.dark-theme #lockscreen-date, body.dark-theme #app-lockscreen p { color: #d1d5db; }
        body.dark-theme #user-auth-modal .content { background: #374151; box-shadow: -3px -3px 7px #4b5563, 2px 2px 5px #111827; }
        body.dark-theme #user-auth-modal .text { color: #f9fafb; }
        body.dark-theme #user-auth-modal .field .input { background: #374151; color: #d1d5db; box-shadow: inset 2px 2px 5px #111827, inset -5px -5px 10px #4b5563; }
        body.dark-theme #user-auth-modal .field .span, body.dark-theme #user-auth-modal .field .label { color: #9ca3af; }
        body.dark-theme #user-auth-modal .button { background: #374151; color: #d1d5db; box-shadow: 2px 2px 5px #111827, -5px -5px 10px #4b5563; }
        body.dark-theme #user-auth-modal .button:focus { color: #60a5fa; box-shadow: inset 2px 2px 5px #111827, inset -5px -5px 10px #4b5563; }
        body.dark-theme #user-auth-modal .auth-tabs { background: #374151; box-shadow: inset 2px 2px 5px #111827, inset -5px -5px 10px #4b5563; }
        body.dark-theme #user-auth-modal .auth-tab { color: #d1d5db; }
        body.dark-theme #user-auth-modal .auth-tab.active { color: #60a5fa; background: #374151; box-shadow: 2px 2px 5px #111827, -5px -5px 10px #4b5563; }
    </style>
</head>
<body class="antialiased">

    <!-- Pantalla de Bloqueo -->
    <div id="app-lockscreen" class="fixed inset-0 z-[101] flex flex-col items-center justify-center">
        <div class="text-center">
            <p id="lockscreen-time" class="text-6xl sm:text-7xl font-bold text-gray-700"></p>
            <p id="lockscreen-date" class="text-lg sm:text-xl text-gray-500"></p>
        </div>
        <div class="mt-16 text-center">
             <div class="switch-container unlock-switch-label">
              <input type="checkbox" id="unlock-switch" class="toggle-checkbox" disabled>
              <label for="unlock-switch" class="switch">
                <div class="toggle"><div class="led"></div></div>
              </label>
            </div>
            <p class="mt-6 text-gray-500 font-medium">Desliza para desbloquear</p>
            <p id="lockscreen-message" class="text-red-500 text-sm mt-2 hidden">Debes iniciar sesión para desbloquear.</p>
        </div>
        <div class="mt-8">
            <button data-modal-target="user-auth-modal" class="neumorphic-btn primary">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>
                <span>Registrarse o Iniciar Sesión</span>
            </button>
        </div>
    </div>

    <!-- Menú Móvil -->
    <div id="mobile-nav-wrapper" class="md:hidden">
        <div id="mobile-sidenav-overlay"></div>
        <div id="mobile-sidenav">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-xl font-bold">Menú</h2>
                <button data-action="close-sidenav" class="neumorphic-btn p-2"><svg xmlns="http://www.w.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button>
            </div>
            <nav id="mobile-nav-links" class="flex flex-col gap-3 flex-grow"></nav>
            <div class="mt-auto pt-4 border-t">
                <h3 class="text-sm font-semibold text-gray-500 mb-3 text-center">Síguenos</h3>
                <div class="flex justify-center gap-3">
                    <a href="#" class="icon-nav-btn social-btn facebook" title="Facebook"><svg viewBox="0 0 24 24"><path d="M22.675 0h-21.35C.595 0 0 .595 0 1.325v21.351C0 23.405.595 24 1.325 24H12.82v-9.294H9.692v-3.622h3.128V8.411c0-3.1 1.893-4.785 4.658-4.785 1.325 0 2.462.099 2.795.143v3.24h-1.918c-1.505 0-1.796.717-1.796 1.767v2.318h3.588l-.467 3.622h-3.121V24h6.116c.73 0 1.324-.595 1.324-1.324V1.325C24 .595 23.405 0 22.675 0z"/></svg></a>
                    <a href="#" class="icon-nav-btn social-btn instagram" title="Instagram"><svg viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.85s-.011 3.585-.069 4.85c-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07s-3.585-.012-4.85-.07c-3.252-.148-4.771-1.691-4.919-4.919-.058-1.265-.069-1.645-.069-4.85s.011-3.585.069-4.85c.149-3.225 1.664-4.771 4.919-4.919C8.415 2.175 8.796 2.163 12 2.163zm0 1.441c-3.119 0-3.482.011-4.694.068-2.618.12-3.832 1.324-3.951 3.951-.057 1.212-.068 1.575-.068 4.694s.011 3.482.068 4.694c.119 2.627 1.333 3.832 3.951 3.951 1.212.057 1.575.068 4.694.068s3.482-.011 4.694-.068c2.618-.12 3.832-1.324 3.951-3.951.057-1.212.068-1.575.068-4.694s-.011-3.482-.068-4.694c-.119-2.627-1.333-3.832-3.951-3.951C15.482 3.614 15.119 3.604 12 3.604zm0 4.232c-2.459 0-4.444 1.985-4.444 4.444s1.985 4.444 4.444 4.444 4.444-1.985 4.444-4.444-1.985-4.444-4.444-4.444zm0 7.211c-1.529 0-2.767-1.238-2.767-2.767s1.238-2.767 2.767-2.767 2.767 1.238 2.767 2.767-1.238 2.767-2.767 2.767zm4.682-7.143c-.76 0-1.376-.615-1.376-1.376s.616-1.376 1.376-1.376 1.376.615 1.376 1.376-.616 1.376-1.376 1.376z"/></svg></a>
                    <a href="#" class="icon-nav-btn social-btn youtube" title="YouTube"><svg viewBox="0 0 24 24"><path d="M21.582,6.186c-0.23-0.86-0.908-1.538-1.768-1.768C18.254,4,12,4,12,4S5.746,4,4.186,4.418 c-0.86,0.23-1.538,0.908-1.768,1.768C2,7.746,2,12,2,12s0,4.254,0.418,5.814c0.23,0.86,0.908,1.538,1.768,1.768 C5.746,20,12,20,12,20s6.254,0,7.814-0.418c0.861-0.23,1.538-0.908,1.768-1.768C22,16.254,22,12,22,12S22,7.746,21.582,6.186z M10,15.464V8.536L16,12L10,15.464z"/></svg></a>
                    <a href="#" class="icon-nav-btn social-btn whatsapp" title="WhatsApp"><svg viewBox="0 0 24 24"><path d="M12.04 2c-5.46 0-9.91 4.45-9.91 9.91 0 1.75.46 3.38 1.25 4.82l-1.34 4.88 5-1.32c1.4.74 2.97 1.18 4.59 1.18 5.46 0 9.91-4.45 9.91-9.91s-4.45-9.9-9.91-9.9zm0 18.27c-1.48 0-2.91-.4-4.19-1.11l-.3-.18-3.11.82.83-3.04-.2-.32c-.8-1.32-1.28-2.84-1.28-4.44 0-4.6 3.73-8.33 8.33-8.33 4.6 0 8.33 3.73 8.33 8.33s-3.73 8.33-8.33 8.33zm4.51-6.15c-.25-.12-1.47-.72-1.7-.85-.23-.12-.39-.18-.56.18-.17.37-.64.85-.79 1.02-.14.18-.29.18-.53.06-.25-.12-1.05-.39-2-1.23-.74-.66-1.23-1.47-1.38-1.72-.14-.25-.02-.38.12-.51.12-.12.29-.3.43-.43.14-.14.18-.24.29-.42.09-.18.04-.34-.02-.48s-.56-1.34-.76-1.84c-.2-.48-.4-.42-.56-.42h-.48c-.17 0-.43.06-.66.3.22.24-.88 1.02-.88 2.48s.9 2.88 1.02 3.08c.12.2 1.77 2.69 4.29 3.78 2.52 1.08 2.52.72 2.97.66.45-.06 1.47-.6 1.68-1.18.2-.59.2-.9.14-1.18-.07-.22-.22-.34-.48-.48z"/></svg></a>
                </div>
            </div>
        </div>
        <div id="edge-handle">
             <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"></path></svg>
        </div>
    </div>

    <div id="app-loading">Cargando Portal...</div>

    <div id="app-container" class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="flex flex-col sm:flex-row justify-between sm:items-center mb-8 gap-4">
            <div class="text-center sm:text-left">
                <h1 class="text-3xl sm:text-4xl font-bold">Comunidad de Gracia</h1>
                <p class="text-gray-500 mt-2">Mi espacio Digital</p>
            </div>
             <div class="flex items-center justify-center sm:justify-end shrink-0 gap-4">
                 <label class="theme-switch">
                  <input type="checkbox" id="theme-switch-checkbox" class="theme-switch__checkbox">
                  <div class="theme-switch__container">
                    <div class="theme-switch__clouds"></div>
                    <div class="theme-switch__stars-container">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 144 55" fill="none"><path fill-rule="evenodd" clip-rule="evenodd" d="M135.831 3.00688C135.055 3.85027 134.111 4.29946 133 4.35447C134.111 4.40947 135.055 4.85867 135.831 5.71123C136.607 6.55462 136.996 7.56303 136.996 8.72727C136.996 7.95722 137.172 7.25134 137.525 6.59129C137.886 5.93124 138.372 5.39954 138.98 5.00535C139.598 4.60199 140.268 4.39114 141 4.35447C139.88 4.2903 138.936 3.85027 138.16 3.00688C137.384 2.16348 136.996 1.16425 136.996 0C136.996 1.16425 136.607 2.16348 135.831 3.00688ZM31 23.3545C32.1114 23.2995 33.0551 22.8503 33.8313 22.0069C34.6075 21.1635 34.9956 20.1642 34.9956 19C34.9956 20.1642 35.3837 21.1635 36.1599 22.0069C36.9361 22.8503 37.8798 23.2903 39 23.3545C38.2679 23.3911 37.5976 23.602 36.9802 24.0053C36.3716 24.3995 35.8864 24.9312 35.5248 25.5913C35.172 26.2513 34.9956 26.9572 34.9956 27.7273C34.9956 26.563 34.6075 25.5546 33.8313 24.7112C33.0551 23.8587 32.1114 23.4095 31 23.3545ZM0 36.3545C1.11136 36.2995 2.05513 35.8503 2.83131 35.0069C3.6075 34.1635 3.99559 33.1642 3.99559 32C3.99559 33.1642 4.38368 34.1635 5.15987 35.0069C5.93605 35.8503 6.87982 36.2903 8 36.3545C7.26792 36.3911 6.59757 36.602 5.98015 37.0053C5.37155 37.3995 4.88644 37.9312 4.52481 38.5913C4.172 39.2513 3.99559 39.9572 3.99559 40.7273C3.99559 39.563 3.6075 38.5546 2.83131 37.7112C2.05513 36.8587 1.11136 36.4095 0 36.3545ZM56.8313 24.0069C56.0551 24.8503 55.1114 25.2995 54 25.3545C55.1114 25.4095 56.0551 25.8587 56.8313 26.7112C57.6075 27.5546 57.9956 28.563 57.9956 29.7273C57.9956 28.9572 58.172 28.2513 58.5248 27.5913C58.8864 26.9312 59.3716 26.3995 59.9802 26.0053C60.5976 25.602 61.2679 25.3911 62 25.3545C60.8798 25.2903 59.9361 24.8503 59.1599 24.0069C58.3837 23.1635 57.9956 22.1642 57.9956 21C57.9956 22.1642 57.6075 23.1635 56.8313 24.0069ZM81 25.3545C82.1114 25.2995 83.0551 24.8503 83.8313 24.0069C84.6075 23.1635 84.9956 22.1642 84.9956 21C84.9956 22.1642 85.3837 23.1635 86.1599 24.0069C86.9361 24.8503 87.8798 25.2903 89 25.3545C88.2679 25.3911 87.5976 25.602 86.9802 26.0053C86.3716 26.3995 85.8864 26.9312 85.5248 27.5913C85.172 28.2513 84.9956 28.9572 84.9956 29.7273C84.9956 28.563 84.6075 27.5546 83.8313 26.7112C83.0551 25.8587 82.1114 25.4095 81 25.3545ZM136 36.3545C137.111 36.2995 138.055 35.8503 138.831 35.0069C139.607 34.1635 139.996 33.1642 139.996 32C139.996 33.1642 140.384 34.1635 141.16 35.0069C141.936 35.8503 142.88 36.2903 144 36.3545C143.268 36.3911 142.598 36.602 141.98 37.0053C141.372 37.3995 140.886 37.9312 140.525 38.5913C140.172 39.2513 139.996 39.9572 139.996 40.7273C139.996 39.563 139.607 38.5546 138.831 37.7112C138.055 36.8587 137.111 36.4095 136 36.3545ZM101.831 49.0069C101.055 49.8503 100.111 50.2995 99 50.3545C100.111 50.4095 101.055 50.8587 101.831 51.7112C102.607 52.5546 102.996 53.563 102.996 54.7273C102.9956 53.9572 103.172 53.2513 103.525 52.5913C103.886 51.9312 104.372 51.3995 104.98 51.0053C105.598 50.602 106.268 50.3911 107 50.3545C105.88 50.2903 104.936 49.8503 104.16 49.0069C103.384 48.1635 102.996 47.1642 102.996 46C102.996 47.1642 102.607 48.1635 101.831 49.0069Z" fill="currentColor"></path></svg>
                    </div>
                    <div class="theme-switch__circle-container">
                      <div class="theme-switch__sun-moon-container">
                        <div class="theme-switch__moon"></div>
                      </div>
                    </div>
                  </div>
                </label>
                <div id="admin-controls-container"></div>
            </div>
        </header>

        <!-- Navegación Principal (Desktop) -->
        <nav class="mb-8 hidden md:block">
            <div id="tabs-container" class="flex flex-wrap justify-center items-center gap-4">
                <button class="icon-nav-btn active" data-target="page-tablero" title="Tablero"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/></svg></button>
                <button class="icon-nav-btn" data-target="page-agenda" title="Eventos"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 12h-5v5h5v-5zM16 1v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2h-1V1h-2zm3 18H5V8h14v11z"/></svg></button>
                <button class="icon-nav-btn" data-target="page-directorio" title="Directorio"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 0H4v2h16V0zM4 24h16v-2H4v2zM20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm-8 6c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm6 12H6v-1.4c0-2 4-3.1 6-3.1s6 1.1 6 3.1V22z"/></svg></button>
                <button class="icon-nav-btn" data-target="page-noticias" title="Noticias"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M22 3H2v16h6v2h8v-2h6V3zm-2 14H4V5h16v12zM6 7h12v2H6zm0 4h12v2H6zm0 4h8v2H6z"/></svg></button>
                <button class="icon-nav-btn" data-target="page-manuales" title="Manuales"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 5c-1.11-.35-2.33-.5-3.5-.5-1.95 0-4.05.4-5.5 1.5-1.45-1.1-3.55-1.5-5.5-1.5S2.11 4.65 1 5v14c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1c1.11.35 2.33.5 3.5.5 1.95 0 4.05-.4 5.5-1.5 1.45 1.1 3.55 1.5 5.5 1.5s4.39-.65 5.5-1.5v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1V5zM5 18c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm14-1c-1.95 0-4.05-.4-5.5-1.5v- bilgi-4.5c1.45-1.1 3.55-1.5 5.5-1.5s4.39.65 5.5 1.5v4.5c-1.11.35-2.33.5-3.5.5z"/></svg></button>
                <button class="icon-nav-btn" data-target="page-recursos" title="Recursos"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg></button>
                <button class="icon-nav-btn" data-target="page-calendario" title="Calendario"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V10h14v10zM9 14H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2z"/></svg></button>
                <button class="icon-nav-btn super-admin-only" data-target="page-user-management" title="Usuarios"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg></button>
            </div>
        </nav>

        <main>
            <div id="pages-container">
                <!-- Páginas de Contenido -->
                <div id="page-tablero" class="page active">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="md:col-span-1">
                           <div class="neumorphic-card p-0 h-full flex flex-col justify-between overflow-hidden">
                                <div id="weather-widget" class="relative p-6 flex-grow flex flex-col justify-between text-white">
                                    <div id="animated-weather-icon" class="absolute top-0 left-0 w-full h-full overflow-hidden z-0"></div>
                                    <div class="relative z-10 flex justify-between items-start">
                                        <div>
                                            <h1 id="weather-location" class="text-xl font-bold">Cargando...</h1>
                                            <p id="weather-desc" class="capitalize">Cargando...</p>
                                        </div>
                                        <div class="text-right"><span id="weather-temp" class="font-bold text-6xl">--°</span></div>
                                    </div>
                                    <div class="relative z-10 flex justify-between items-end mt-4">
                                         <div></div>
                                         <div class="text-right">
                                            <p id="current-time" class="text-3xl font-semibold">--:--</p>
                                            <p id="current-date" class="text-sm">-- --/--</p>
                                        </div>
                                    </div>
                                </div>
                           </div>
                        </div>
                        <div class="md:col-span-2 space-y-6">
                            <div id="birthday-card" class="neumorphic-card p-6" style="display: none;">
                                <h2 class="text-xl font-bold mb-4">Cumpleaños de Hoy</h2>
                                <ul id="birthday-list" class="space-y-3"></ul>
                            </div>
                            <div class="neumorphic-card p-6">
                                <h2 class="text-xl font-bold mb-4">Próximos Eventos</h2>
                                <ul id="upcoming-events-list" class="space-y-3"><li class="text-gray-500">Cargando eventos...</li></ul>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="page-agenda" class="page">
                    <div class="neumorphic-card p-6">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                            <h2 class="text-2xl font-bold">Eventos</h2>
                            <button data-modal-target="event-modal" data-permission="agenda" class="neumorphic-btn primary w-full sm:w-auto admin-only"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" /></svg><span>Agregar Evento</span></button>
                        </div>
                        <div class="overflow-x-auto"><table class="w-full text-left"><thead class="border-b"><tr><th class="p-3 font-semibold">Fecha</th><th class="p-3 font-semibold hidden sm:table-cell">Hora</th><th class="p-3 font-semibold">Nombre del Evento</th><th class="p-3 font-semibold admin-only-table-cell" data-permission="agenda">Acciones</th></tr></thead><tbody id="agenda-table-body"></tbody></table></div>
                    </div>
                </div>
                <div id="page-directorio" class="page">
                    <div class="neumorphic-card p-6">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                            <h2 class="text-2xl font-bold">Directorio</h2>
                            <button data-modal-target="parroquiano-modal" data-permission="directorio" class="neumorphic-btn primary w-full sm:w-auto admin-only"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path d="M11 5a3 3 0 11-6 0 3 3 0 016 0zM12.73 10.21a5.002 5.002 0 016.536 6.536l.243.243a1 1 0 11-1.414 1.414l-.243-.243a5.002 5.002 0 01-7.95-7.95l-1.01-1.01A5.002 5.002 0 012.27 12.27l-1.01 1.01a1 1 0 11-1.414-1.414l1.01-1.01a5.002 5.002 0 017.95 7.95l.243.243a1 1 0 011.414 1.414l-.243-.243a5.002 5.002 0 01-6.536-6.536l1.01 1.01z" /></svg><span>Agregar Parroquiano</span></button>
                        </div>
                        <div class="overflow-x-auto"><table class="w-full text-left"><thead class="border-b"><tr><th class="p-3 font-semibold">Nombre</th><th class="p-3 font-semibold hidden md:table-cell">Teléfono</th><th class="p-3 font-semibold hidden lg:table-cell">Contacto Emergencia</th><th class="p-3 font-semibold admin-only-table-cell" data-permission="directorio">Acciones</th></tr></thead><tbody id="directorio-table-body"></tbody></table></div>
                    </div>
                </div>
                <div id="page-noticias" class="page">
                    <div class="neumorphic-card p-6">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                            <h2 class="text-2xl font-bold">Noticias Parroquiales</h2>
                            <button data-modal-target="news-modal" data-permission="noticias" class="neumorphic-btn primary w-full sm:w-auto admin-only"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" /></svg><span>Agregar Noticia</span></button>
                        </div>
                        <div id="news-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                    </div>
                </div>
                <div id="page-manuales" class="page">
                    <div class="neumorphic-card p-6">
                         <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                            <h2 class="text-2xl font-bold">Manuales y Guías</h2>
                            <button data-modal-target="bloque-manual-modal" data-permission="manuales" class="neumorphic-btn primary w-full sm:w-auto admin-only"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" /></svg><span>Agregar Bloque</span></button>
                        </div>
                        <div id="manuales-container" class="space-y-4"></div>
                    </div>
                </div>
                <div id="page-recursos" class="page">
                    <div class="neumorphic-card p-6">
                         <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                            <h2 class="text-2xl font-bold">Recursos y Documentos</h2>
                            <button data-modal-target="bloque-archivo-modal" data-permission="recursos" class="neumorphic-btn primary w-full sm:w-auto admin-only"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" /></svg><span>Agregar Bloque</span></button>
                        </div>
                        <div id="archivos-container" class="space-y-4"></div>
                    </div>
                </div>
                <div id="page-calendario" class="page">
                    <div class="neumorphic-card p-6">
                        <div id="calendar-header" class="flex justify-between items-center mb-6">
                            <button id="prev-month-btn" class="neumorphic-btn p-2 sm:p-auto"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" /></svg></button>
                            <h2 id="month-year-header" class="text-xl sm:text-2xl font-bold text-center"></h2>
                            <button id="next-month-btn" class="neumorphic-btn p-2 sm:p-auto"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" /></svg></button>
                        </div>
                        <div class="grid grid-cols-7 gap-1 sm:gap-2 text-center font-semibold mb-2 text-sm sm:text-base"><div>Do</div><div>Lu</div><div>Ma</div><div>Mi</div><div>Ju</div><div>Vi</div><div>Sá</div></div>
                        <div id="calendar-grid" class="grid grid-cols-7 gap-1 sm:gap-2"></div>
                    </div>
                </div>
                <div id="page-user-management" class="page">
                    <div class="neumorphic-card p-6">
                        <h2 class="text-2xl font-bold mb-6">Gestión de Usuarios</h2>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead class="border-b">
                                    <tr>
                                        <th class="p-3 font-semibold">Nombre</th>
                                        <th class="p-3 font-semibold">Correo</th>
                                        <th class="p-3 font-semibold">Rol</th>
                                        <th class="p-3 font-semibold">Permisos</th>
                                        <th class="p-3 font-semibold">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="user-management-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <footer class="mt-12">
            <div class="neumorphic-card p-6">
                <h3 class="text-lg font-bold text-center mb-4">Síguenos en Redes Sociales</h3>
                <div class="flex justify-center items-center gap-4">
                     <a href="#" class="icon-nav-btn social-btn facebook" title="Facebook"><svg viewBox="0 0 24 24"><path d="M22.675 0h-21.35C.595 0 0 .595 0 1.325v21.351C0 23.405.595 24 1.325 24H12.82v-9.294H9.692v-3.622h3.128V8.411c0-3.1 1.893-4.785 4.658-4.785 1.325 0 2.462.099 2.795.143v3.24h-1.918c-1.505 0-1.796.717-1.796 1.767v2.318h3.588l-.467 3.622h-3.121V24h6.116c.73 0 1.324-.595 1.324-1.324V1.325C24 .595 23.405 0 22.675 0z"/></svg></a>
                    <a href="#" class="icon-nav-btn social-btn instagram" title="Instagram"><svg viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.85s-.011 3.585-.069 4.85c-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07s-3.585-.012-4.85-.07c-3.252-.148-4.771-1.691-4.919-4.919-.058-1.265-.069-1.645-.069-4.85s.011-3.585.069-4.85c.149-3.225 1.664-4.771 4.919-4.919C8.415 2.175 8.796 2.163 12 2.163zm0 1.441c-3.119 0-3.482.011-4.694.068-2.618.12-3.832 1.324-3.951 3.951-.057 1.212-.068 1.575-.068 4.694s.011 3.482.068 4.694c.119 2.627 1.333 3.832 3.951 3.951 1.212.057 1.575.068 4.694.068s3.482-.011 4.694-.068c2.618-.12 3.832-1.324 3.951-3.951.057-1.212.068-1.575.068-4.694s-.011-3.482-.068-4.694c-.119-2.627-1.333-3.832-3.951-3.951C15.482 3.614 15.119 3.604 12 3.604zm0 4.232c-2.459 0-4.444 1.985-4.444 4.444s1.985 4.444 4.444 4.444 4.444-1.985 4.444-4.444-1.985-4.444-4.444-4.444zm0 7.211c-1.529 0-2.767-1.238-2.767-2.767s1.238-2.767 2.767-2.767 2.767 1.238 2.767 2.767-1.238 2.767-2.767 2.767zm4.682-7.143c-.76 0-1.376-.615-1.376-1.376s.616-1.376 1.376-1.376 1.376.615 1.376 1.376-.616 1.376-1.376 1.376z"/></svg></a>
                    <a href="#" class="icon-nav-btn social-btn youtube" title="YouTube"><svg viewBox="0 0 24 24"><path d="M21.582,6.186c-0.23-0.86-0.908-1.538-1.768-1.768C18.254,4,12,4,12,4S5.746,4,4.186,4.418 c-0.86,0.23-1.538,0.908-1.768,1.768C2,7.746,2,12,2,12s0,4.254,0.418,5.814c0.23,0.86,0.908,1.538,1.768,1.768 C5.746,20,12,20,12,20s6.254,0,7.814-0.418c0.861-0.23,1.538-0.908,1.768-1.768C22,16.254,22,12,22,12S22,7.746,21.582,6.186z M10,15.464V8.536L16,12L10,15.464z"/></svg></a>
                    <a href="#" class="icon-nav-btn social-btn whatsapp" title="WhatsApp"><svg viewBox="0 0 24 24"><path d="M12.04 2c-5.46 0-9.91 4.45-9.91 9.91 0 1.75.46 3.38 1.25 4.82l-1.34 4.88 5-1.32c1.4.74 2.97 1.18 4.59 1.18 5.46 0 9.91-4.45 9.91-9.91s-4.45-9.9-9.91-9.9zm0 18.27c-1.48 0-2.91-.4-4.19-1.11l-.3-.18-3.11.82.83-3.04-.2-.32c-.8-1.32-1.28-2.84-1.28-4.44 0-4.6 3.73-8.33 8.33-8.33 4.6 0 8.33 3.73 8.33 8.33s-3.73 8.33-8.33 8.33zm4.51-6.15c-.25-.12-1.47-.72-1.7-.85-.23-.12-.39-.18-.56.18-.17.37-.64.85-.79 1.02-.14.18-.29.18-.53.06-.25-.12-1.05-.39-2-1.23-.74-.66-1.23-1.47-1.38-1.72-.14-.25-.02-.38.12-.51.12-.12.29-.3.43-.43.14-.14.18-.24.29-.42.09-.18.04-.34-.02-.48s-.56-1.34-.76-1.84c-.2-.48-.4-.42-.56-.42h-.48c-.17 0-.43.06-.66.3.22.24-.88 1.02-.88 2.48s.9 2.88 1.02 3.08c.12.2 1.77 2.69 4.29 3.78 2.52 1.08 2.52.72 2.97.66.45-.06 1.47-.6 1.68-1.18.2-.59.2-.9.14-1.18-.07-.22-.22-.34-.48-.48z"/></svg></a>
                </div>
            </div>
        </footer>
    </div>

    <!-- Modales -->
     <div id="user-auth-modal" class="fixed inset-0 bg-gray-900 bg-opacity-25 backdrop-blur-sm flex items-center justify-center hidden z-[110] p-4">
        <div class="content relative">
             <button data-action="close-modal" class="absolute -top-6 -right-3 text-white hover:text-gray-300"><svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button>
            <div class="auth-tabs">
                <button id="show-login-btn" class="auth-tab active">Iniciar Sesión</button>
                <button id="show-register-btn" class="auth-tab">Registrarse</button>
            </div>
            <div id="login-view">
                <form id="login-form" action="#" class="mt-8">
                    <div class="field"><input required type="email" id="login-email" class="input" autocomplete="email"><span class="span"><svg viewBox="0 0 512 512" height="20" width="50"><g><path fill="#595959" d="m467 61h-422c-24.813 0-45 20.187-45 45v300c0 24.813 20.187 45 45 45h422c24.813 0 45-20.187 45-45v-300c0-24.813-20.187-45-45-45zm-21.086 42.229 18.172 15.143-207.086 172.583-207.086-172.583 18.172-15.143 188.914 157.417zm-403.914 329.771v-274.526l183.58 152.958c2.582 2.152 5.53 3.229 8.48 3.229s5.898-1.077 8.48-3.229l183.58-152.958v274.526z"></path></g></svg></span><label class="label">Correo</label></div>
                    <div class="field"><input required type="password" id="login-password" class="input" autocomplete="current-password"><span class="span"><svg viewBox="0 0 512 512" height="20" width="50"><g><path fill="#595959" d="M336 192h-16v-64C320 57.406 262.594 0 192 0S64 57.406 64 128v64H48c-26.453 0-48 21.523-48 48v224c0 26.477 21.547 48 48 48h288c26.453 0 48-21.523 48-48V240c0-26.477-21.547-48-48-48zm-229.332-64c0-47.063 38.27-85.332 85.332-85.332s85.332 38.27 85.332 85.332v64H106.668zm0 0"></path></g></svg></span><label class="label">Contraseña</label></div>
                    <p id="login-error-msg" class="text-red-500 text-sm my-4 text-center hidden">Credenciales incorrectas.</p>
                    <button class="button" type="submit">Ingresar</button>
                </form>
            </div>
            <div id="register-view" class="hidden">
                <form id="register-form" action="#" class="mt-8">
                    <div class="field"><input required type="text" id="register-name" class="input" autocomplete="name"><span class="span"><svg viewBox="0 0 512 512" height="20" width="50"><g><path fill="#595959" d="M256 0c-74.439 0-135 60.561-135 135s60.561 135 135 135 135-60.561 135-135S330.439 0 256 0zM423.966 358.195C387.006 320.667 338.009 300 286 300h-60c-52.008 0-101.006 20.667-137.966 58.195C51.255 395.539 31 444.833 31 497c0 8.284 6.716 15 15 15h420c8.284 0 15-6.716 15-15 0-52.167-20.255-101.461-57.034-138.805z"></path></g></svg></span><label class="label">Nombre</label></div>
                    <div class="field"><input required type="email" id="register-email" class="input" autocomplete="email"><span class="span"><svg viewBox="0 0 512 512" height="20" width="50"><g><path fill="#595959" d="m467 61h-422c-24.813 0-45 20.187-45 45v300c0 24.813 20.187 45 45 45h422c24.813 0 45-20.187 45-45v-300c0-24.813-20.187-45-45-45zm-21.086 42.229 18.172 15.143-207.086 172.583-207.086-172.583 18.172-15.143 188.914 157.417zm-403.914 329.771v-274.526l183.58 152.958c2.582 2.152 5.53 3.229 8.48 3.229s5.898-1.077 8.48-3.229l183.58-152.958v274.526z"></path></g></svg></span><label class="label">Correo</label></div>
                    <div class="field"><input required type="password" id="register-password" class="input" autocomplete="new-password"><span class="span"><svg viewBox="0 0 512 512" height="20" width="50"><g><path fill="#595959" d="M336 192h-16v-64C320 57.406 262.594 0 192 0S64 57.406 64 128v64H48c-26.453 0-48 21.523-48 48v224c0 26.477 21.547 48 48 48h288c26.453 0 48-21.523 48-48V240c0-26.477-21.547-48-48-48zm-229.332-64c0-47.063 38.27-85.332 85.332-85.332s85.332 38.27 85.332 85.332v64H106.668zm0 0"></path></g></svg></span><label class="label">Contraseña</label></div>
                    <p id="register-error-msg" class="text-red-500 text-sm my-4 text-center hidden"></p>
                    <button class="button" type="submit">Crear Cuenta</button>
                </form>
            </div>
        </div>
    </div>
    
    <div id="event-modal" class="fixed inset-0 bg-gray-900 bg-opacity-25 flex items-center justify-center hidden z-50 p-4">
        <div class="neumorphic-card p-8 w-full max-w-md">
            <h2 class="text-2xl font-bold mb-6"></h2>
            <form id="event-form" data-type="event" class="space-y-4">
                <input type="hidden" name="id">
                <div><label for="event-name" class="block text-sm font-medium mb-1">Nombre del Evento</label><input type="text" id="event-name" name="name" class="neumorphic-input" required></div>
                <div><label for="event-date" class="block text-sm font-medium mb-1">Fecha</label><input type="date" id="event-date" name="date" class="neumorphic-input" required></div>
                <div><label for="event-time" class="block text-sm font-medium mb-1">Hora</label><input type="time" id="event-time" name="time" class="neumorphic-input" required></div>
                <div><label for="event-imageUrl" class="block text-sm font-medium mb-1">URL de la Imagen (Opcional)</label><input type="url" id="event-imageUrl" name="imageUrl" class="neumorphic-input" placeholder="https://ejemplo.com/imagen.jpg"></div>
                <div class="flex justify-end gap-4 pt-4"><button type="button" data-action="close-modal" class="neumorphic-btn">Cancelar</button><button type="submit" class="neumorphic-btn primary">Guardar</button></div>
            </form>
        </div>
    </div>
    <div id="parroquiano-modal" class="fixed inset-0 bg-gray-900 bg-opacity-25 flex items-center justify-center hidden z-50 p-4">
        <div class="neumorphic-card p-8 w-full max-w-2xl flex flex-col">
            <h2 class="text-2xl font-bold mb-6 flex-shrink-0"></h2>
            <div class="flex-grow overflow-hidden">
                <form id="parroquiano-form" data-type="parroquiano" class="h-full flex flex-col">
                    <div class="flex-grow overflow-y-auto pr-4 -mr-4 space-y-4">
                        <input type="hidden" name="id">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label for="parroquiano-nombre" class="block text-sm font-medium mb-1">Nombre Completo</label><input type="text" id="parroquiano-nombre" name="nombre" class="neumorphic-input" required></div>
                            <div><label for="parroquiano-nacimiento" class="block text-sm font-medium mb-1">Fecha de Nacimiento</label><input type="date" id="parroquiano-nacimiento" name="nacimiento" class="neumorphic-input"></div>
                            <div><label for="parroquiano-telefono" class="block text-sm font-medium mb-1">Teléfono</label><input type="tel" id="parroquiano-telefono" name="telefono" class="neumorphic-input"></div>
                            <div><label for="parroquiano-email" class="block text-sm font-medium mb-1">Correo Electrónico</label><input type="email" id="parroquiano-email" name="email" class="neumorphic-input"></div>
                            <div class="md:col-span-2"><label for="parroquiano-direccion" class="block text-sm font-medium mb-1">Dirección</label><textarea id="parroquiano-direccion" name="direccion" rows="2" class="neumorphic-input"></textarea></div>
                        </div>
                        <div class="pt-4 mt-4 border-t"><h3 class="text-lg font-semibold mb-2">Contacto de Emergencia</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="parroquiano-emergencia-nombre" class="block text-sm font-medium mb-1">Nombre</label><input type="text" id="parroquiano-emergencia-nombre" name="emergencia_nombre" class="neumorphic-input"></div><div><label for="parroquiano-emergencia-telefono" class="block text-sm font-medium mb-1">Teléfono</label><input type="tel" id="parroquiano-emergencia-telefono" name="emergencia_telefono" class="neumorphic-input"></div></div></div>
                    </div>
                    <div class="flex justify-end gap-4 pt-4 flex-shrink-0"><button type="button" data-action="close-modal" class="neumorphic-btn">Cancelar</button><button type="submit" class="neumorphic-btn primary">Guardar</button></div>
                </form>
            </div>
        </div>
    </div>
    <div id="manual-modal" class="fixed inset-0 bg-gray-900 bg-opacity-25 flex items-center justify-center hidden z-50 p-4"><div class="neumorphic-card p-8 w-full max-w-md"><h2 class="text-2xl font-bold mb-6"></h2><form id="manual-form" data-type="manual"><input type="hidden" name="id"><input type="hidden" name="blockId"><div class="mb-4"><label for="manual-nombre" class="block text-sm font-medium mb-1">Nombre del Manual</label><input type="text" id="manual-nombre" name="nombre" class="neumorphic-input" required></div><div class="mb-6"><label for="manual-url" class="block text-sm font-medium mb-1">URL</label><input type="url" id="manual-url" name="url" class="neumorphic-input" placeholder="https://ejemplo.com/documento.pdf" required></div><div class="flex justify-end gap-4"><button type="button" data-action="close-modal" class="neumorphic-btn">Cancelar</button><button type="submit" class="neumorphic-btn primary">Guardar</button></div></form></div></div>
    <div id="archivo-modal" class="fixed inset-0 bg-gray-900 bg-opacity-25 flex items-center justify-center hidden z-50 p-4"><div class="neumorphic-card p-8 w-full max-w-md"><h2 class="text-2xl font-bold mb-6"></h2><form id="archivo-form" data-type="archivo"><input type="hidden" name="id"><input type="hidden" name="blockId"><div class="mb-4"><label for="archivo-nombre" class="block text-sm font-medium mb-1">Nombre del Archivo</label><input type="text" id="archivo-nombre" name="nombre" class="neumorphic-input" required></div><div class="mb-6"><label for="archivo-url" class="block text-sm font-medium mb-1">URL</label><input type="url" id="archivo-url" name="url" class="neumorphic-input" placeholder="https://ejemplo.com/recurso.zip" required></div><div class="flex justify-end gap-4"><button type="button" data-action="close-modal" class="neumorphic-btn">Cancelar</button><button type="submit" class="neumorphic-btn primary">Guardar</button></div></form></div></div>
    <div id="confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-25 flex items-center justify-center hidden z-50 p-4"><div class="neumorphic-card p-8 w-full max-w-sm"><h2 class="text-xl font-bold mb-4">Confirmar Eliminación</h2><p id="confirm-message" class="mb-6">¿Estás seguro?</p><div class="flex justify-end gap-4"><button type="button" data-action="close-modal" class="neumorphic-btn">Cancelar</button><button type="button" id="confirm-delete-btn" class="neumorphic-btn danger">Eliminar</button></div></div></div>
    <div id="calendar-day-modal" class="fixed inset-0 bg-gray-900 bg-opacity-25 flex items-center justify-center hidden z-50 p-4"><div class="neumorphic-card p-8 w-full max-w-md"><h2 id="calendar-day-modal-title" class="text-xl font-bold mb-6"></h2><div class="space-y-4 max-h-[60vh] overflow-y-auto pr-2"><div><h3 class="font-semibold mb-2">Eventos</h3><ul id="calendar-day-events-list" class="space-y-2"></ul></div><div id="calendar-day-birthdays-section" class="hidden"><h3 class="font-semibold mb-2">Cumpleaños</h3><ul id="calendar-day-birthdays-list" class="space-y-2"></ul></div></div><div class="flex justify-end gap-4 mt-6"><button type="button" data-action="close-modal" class="neumorphic-btn">Cerrar</button></div></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, setDoc, getDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        /**
         * @file Portal Parroquial - Aplicación de una sola página (SPA)
         * @description Este archivo contiene toda la lógica para un portal de gestión de comunidad parroquial,
         * incluyendo autenticación, gestión de datos (eventos, directorio, noticias), y una
         * interfaz de usuario reactiva con diseño neumorfista.
         * @author Senior Developer Review
         */

        // =================================================================================
        // MÓDULO DE CONFIGURACIÓN
        // =================================================================================
        const Config = {
            firebase: {
                apiKey: "AIzaSyATCd0jgG2Lo5q8K5bB15eNvkakJBb15RU", authDomain: "ibcgapp.firebaseapp.com",
                projectId: "ibcgapp", storageBucket: "ibcgapp.appspot.com",
                messagingSenderId: "548258029551", appId: "1:548258029551:web:9354e4cc79ce4f25f0201a",
                measurementId: "G-RBN8KZPJ5X"
            },
            weather: {
                apiKey: '9a11de307931b3ba88e6af9048b7f3b1', lat: 19.5437, lon: -96.91
            },
            paths: {
                base: `artifacts/ibcgapp`,
                collections: {
                    users: `public/data/users`, events: `public/data/events`, 
                    parroquianos: `public/data/parroquianos`, news: `public/data/news`, 
                    manuales: `public/data/manuales`, archivos: `public/data/archivos`
                }
            }
        };

        // =================================================================================
        // SERVICIOS (Firebase, Clima)
        // =================================================================================
        const FirebaseService = {
            db: null, auth: null,
            init(onAuthChangeCallback) {
                const app = initializeApp(Config.firebase);
                this.db = getFirestore(app);
                this.auth = getAuth(app);
                onAuthStateChanged(this.auth, onAuthChangeCallback);
            },
            _getCollectionPath(type) {
                const collectionPath = Config.paths.collections[type];
                if (!collectionPath) throw new Error(`Collection type "${type}" no definida.`);
                return `${Config.paths.base}/${collectionPath}`;
            },
            onCollectionSnapshot(type, callback) {
                const path = this._getCollectionPath(type);
                return onSnapshot(collection(this.db, path), (snapshot) => {
                    callback(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                }, (error) => console.error(`Error en listener de ${type}: `, error));
            },
            async saveDoc(type, id, data) {
                const collectionPath = this._getCollectionPath(type);
                if (id) {
                    await updateDoc(doc(this.db, collectionPath, id), data);
                } else {
                    if (type === 'news' && !data.fechaPublicacion) {
                        data.fechaPublicacion = new Date().toISOString();
                    }
                    return await addDoc(collection(this.db, collectionPath), data);
                }
            },
            async setDoc(type, id, data) { await setDoc(doc(this.db, this._getCollectionPath(type), id), data); },
            async getDoc(type, id) { return await getDoc(doc(this.db, this._getCollectionPath(type), id)); },
            async deleteDoc(type, id) { await deleteDoc(doc(this.db, this._getCollectionPath(type), id)); }
        };
        
        const WeatherService = {
            async fetch() {
                const { lat, lon, apiKey } = Config.weather;
                const url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${apiKey}&units=metric&lang=es`;
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error('Respuesta de red no fue ok');
                    const data = await response.json();
                    return { 
                        temp: data.main.temp, description: data.weather[0].description, 
                        location: data.name, id: data.weather[0].id, sys: data.sys
                    };
                } catch (error) {
                    console.error("Error al obtener el clima:", error);
                    return { description: 'Error de red', location: 'Desconocida' };
                }
            }
        };
        
        // =================================================================================
        // MÓDULO DE UI (Interfaz de Usuario)
        // =================================================================================
        const UI = {
            elements: {},
            init() {
                this.elements = {
                    appLoading: document.getElementById('app-loading'),
                    appContainer: document.getElementById('app-container'),
                    lockscreen: { container: document.getElementById('app-lockscreen'), time: document.getElementById('lockscreen-time'), date: document.getElementById('lockscreen-date'), message: document.getElementById('lockscreen-message'), unlockSwitch: document.getElementById('unlock-switch'), unlockSwitchLabel: document.querySelector('.unlock-switch-label'), },
                    header: { adminControlsContainer: document.getElementById('admin-controls-container'), themeSwitch: document.getElementById('theme-switch-checkbox'), },
                    nav: { tabsContainer: document.getElementById('tabs-container'), pagesContainer: document.getElementById('pages-container'), edgeHandle: document.getElementById('edge-handle'), mobileSidenav: document.getElementById('mobile-sidenav'), mobileSidenavOverlay: document.getElementById('mobile-sidenav-overlay'), mobileNavLinks: document.getElementById('mobile-nav-links'), },
                    pages: {
                        tablero: { currentDate: document.getElementById('current-date'), currentTime: document.getElementById('current-time'), weatherTemp: document.getElementById('weather-temp'), weatherDesc: document.getElementById('weather-desc'), weatherLocation: document.getElementById('weather-location'), upcomingEventsList: document.getElementById('upcoming-events-list'), birthdayCard: document.getElementById('birthday-card'), birthdayList: document.getElementById('birthday-list'), weatherWidget: document.getElementById('weather-widget'), animatedWeatherIcon: document.getElementById('animated-weather-icon'), },
                        agenda: { tableBody: document.getElementById('agenda-table-body') },
                        directorio: { tableBody: document.getElementById('directorio-table-body') },
                        noticias: { grid: document.getElementById('news-grid') },
                        manuales: { container: document.getElementById('manuales-container') },
                        recursos: { container: document.getElementById('archivos-container') },
                        calendario: { header: document.getElementById('month-year-header'), grid: document.getElementById('calendar-grid'), },
                        userManagement: { tableBody: document.getElementById('user-management-table-body') }
                    },
                    modals: { userAuth: document.getElementById('user-auth-modal'), event: document.getElementById('event-modal'), parroquiano: document.getElementById('parroquiano-modal'), news: document.getElementById('news-modal'), newsDetail: document.getElementById('news-detail-modal'), bloqueManual: document.getElementById('bloque-manual-modal'), manual: document.getElementById('manual-modal'), bloqueArchivo: document.getElementById('bloque-archivo-modal'), archivo: document.getElementById('archivo-modal'), confirm: document.getElementById('confirm-modal'), calendarDay: document.getElementById('calendar-day-modal'), },
                    confirmModal: { message: document.getElementById('confirm-message'), deleteBtn: document.getElementById('confirm-delete-btn'), },
                    calendarDayModal: { title: document.getElementById('calendar-day-modal-title'), eventsList: document.getElementById('calendar-day-events-list'), birthdaysSection: document.getElementById('calendar-day-birthdays-section'), birthdaysList: document.getElementById('calendar-day-birthdays-list'), }
                };
            },
            showPage(pageId) {
                this.elements.nav.pagesContainer.querySelectorAll('.page').forEach(page => page.classList.toggle('active', page.id === pageId));
                document.querySelectorAll(`[data-target]`).forEach(tab => tab.classList.toggle('active', tab.dataset.target === pageId));
            },
            renderTable(tbody, data, rowRenderer, emptyMessage) {
                tbody.innerHTML = '';
                if (data.length === 0) {
                    const colSpan = tbody.closest('table')?.querySelector('thead tr').childElementCount || 1;
                    tbody.innerHTML = `<tr><td colspan="${colSpan}" class="p-4 text-center text-gray-500">${emptyMessage}</td></tr>`;
                    return;
                }
                const sortedData = [...data].sort((a, b) => (a.nombre || a.name || '').localeCompare(b.nombre || b.name || ''));
                sortedData.forEach(item => tbody.insertAdjacentHTML('beforeend', rowRenderer(item)));
            },
            updateAdminUI(isSuperAdmin, isAdmin, user, viewAsUser) {
                document.body.classList.toggle('super-admin-mode', isSuperAdmin && !viewAsUser);
                document.body.classList.toggle('admin-mode', (isAdmin || isSuperAdmin) && !viewAsUser);
                
                if (user) {
                     const isSuperAdminView = isSuperAdmin ? `<div class="flex items-center gap-2"><span class="text-sm font-medium whitespace-nowrap">Vista</span><label class="custom-switch"><input type="checkbox" id="view-as-user-switch" ${viewAsUser ? 'checked' : ''} /><div><span class="on">Admin</span><span class="off">User</span></div><i></i></label></div>` : '';
                     this.elements.header.adminControlsContainer.innerHTML = `<div class="flex items-center gap-4">${isSuperAdminView}<span class="font-semibold hidden sm:inline">${user.nombre.split(' ')[0]}</span><button data-action="logout" class="neumorphic-btn danger p-2" title="Cerrar Sesión"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg></button></div>`;
                } else {
                     this.elements.header.adminControlsContainer.innerHTML = ``;
                }
                this.nav.initMobileNav();
            },
            tablero: {
                renderUpcomingEvents(events, container) {
                    container.innerHTML = '';
                    const now = new Date();
                    now.setHours(0, 0, 0, 0);
                    const upcoming = events.filter(event => new Date(event.date + 'T00:00:00Z') >= now).sort((a, b) => new Date(`${a.date}T${a.time}`) - new Date(`${b.date}T${b.time}`)).slice(0, 5);
                    if (upcoming.length === 0) { container.innerHTML = '<li class="text-gray-500">No hay próximos eventos.</li>'; return; }
                    upcoming.forEach(event => {
                        const placeholderImage = 'https://placehold.co/100x100/eef0f4/4b5563?text=Evento';
                        container.insertAdjacentHTML('beforeend', `<li class="flex items-center gap-4 p-3 rounded-lg neumorphic-inset"><img src="${event.imageUrl || placeholderImage}" alt="Imagen del evento" class="w-16 h-16 object-cover rounded-lg flex-shrink-0" onerror="this.src='${placeholderImage}'"><div class="overflow-hidden"><p class="font-semibold truncate">${event.name}</p><p class="text-sm text-gray-500">${new Date(event.date + 'T00:00:00Z').toLocaleDateString('es-ES', { month: 'long', day: 'numeric' })} - ${event.time}h</p></div></li>`);
                    });
                },
                renderBirthdayReminders(parroquianos, card, list) {
                    const today = new Date();
                    const birthdayFolks = parroquianos.filter(p => { if (!p.nacimiento) return false; const birthDate = new Date(p.nacimiento + 'T00:00:00Z'); return (birthDate.getMonth() === today.getMonth()) && (birthDate.getDate() === today.getDate()); });
                    list.innerHTML = '';
                    if (birthdayFolks.length === 0) { card.style.display = 'none'; } else {
                        card.style.display = 'block';
                        birthdayFolks.forEach(person => { list.insertAdjacentHTML('beforeend', `<li class="flex items-center gap-4 p-3 rounded-lg neumorphic-inset"><div class="text-amber-500"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-8 h-8"><path fill-rule="evenodd" d="M10.868 2.884c.321-.772 1.415-.772 1.736 0l1.681 4.06c.064.155.19.283.348.333l4.48.653c.84.123 1.171 1.157.536 1.748l-3.242 3.159c-.12.117-.175.284-.15.444l.764 4.463c.145.845-.733 1.493-1.488 1.085l-4.01-2.108a.75.75 0 00-.702 0l-4.01 2.108c-.755.408-1.633-.24-1.488-1.085l.764-4.463c.025-.16-.03-.327-.15-.444l-3.242-3.159c-.635-.591-.304-1.625.536-1.748l4.48-.653c.158-.023.284-.15.348-.333l1.681-4.06z" clip-rule="evenodd" /></svg></div><div><p class="font-semibold">${person.nombre}</p><p class="text-sm">¡Hoy es su cumpleaños!</p></div></li>`); });
                    }
                },
                updateDateTime(dateEl, timeEl) { const now = new Date(); const days = ['DOM', 'LUN', 'MAR', 'MIÉ', 'JUE', 'VIE', 'SÁB']; dateEl.textContent = `${days[now.getDay()]} ${String(now.getDate()).padStart(2, '0')}/${String(now.getMonth() + 1).padStart(2, '0')}`; timeEl.textContent = now.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }); },
                updateWeather(data, tempEl, descEl, locEl, widgetEl, iconContainer) { tempEl.textContent = data.temp ? `${Math.round(data.temp)}°` : '--°'; descEl.textContent = data.description ? data.description.charAt(0).toUpperCase() + data.description.slice(1) : 'Cargando...'; locEl.textContent = data.location || ''; if (data.id && data.sys) { this.updateWeatherIcon(data, widgetEl, iconContainer); } },
                updateWeatherIcon(data, widgetEl, iconContainer) {
                    iconContainer.innerHTML = ''; let iconHtml = ''; const id = data.id; const now = Date.now() / 1000; const isNight = data.sys && (now < data.sys.sunrise || now > data.sys.sunset);
                    widgetEl.classList.toggle('night', isNight);
                    if (id < 600) { iconHtml = `<div class="cloud cloud1"></div><div class="cloud cloud2"></div><div class="rain">${Array.from({length:15}).map(()=>`<div class="drop" style="left: ${Math.random()*100}%; animation-delay: ${Math.random()}s; animation-duration: ${0.5 + Math.random() * 0.5}s;"></div>`).join('')}</div>`; }
                    else if (id < 800) { iconHtml = `<div class="cloud cloud1" style="animation-duration: 20s;"></div><div class="cloud cloud2" style="animation-duration: 30s;"></div>`; }
                    else if (id === 800) { iconHtml = isNight ? `<div class="stars">${Array.from({length:20}).map(()=>`<div class="star" style="top: ${Math.random()*100}%; left: ${Math.random()*100}%; animation-delay: ${Math.random()}s;"></div>`).join('')}</div>` : `<div class="sun"></div>`; }
                    else { iconHtml = isNight ? `<div class="stars">${Array.from({length:15}).map(()=>`<div class="star" style="top: ${Math.random()*100}%; left: ${Math.random()*100}%; animation-delay: ${Math.random()}s;"></div>`).join('')}</div><div class="cloud cloud1" style="background: rgba(100,100,120,0.8);"></div>` : `<div class="sun" style="top: 25%; left: 65%;"></div><div class="cloud cloud1"></div><div class="cloud cloud2"></div>`; }
                    iconContainer.innerHTML = iconHtml;
                }
            },
            agenda: { createRow(event) { const date = new Date(event.date + 'T00:00:00Z').toLocaleDateString('es-ES', { day: '2-digit', month: 'short', year: 'numeric' }); return `<tr class="border-b"><td class="p-3">${date}</td><td class="p-3 hidden sm:table-cell">${event.time}</td><td class="p-3 font-medium">${event.name}</td><td class="p-3 admin-only-table-cell" data-permission="agenda"><div class="flex gap-2"><button data-action="edit" data-type="event" data-id="${event.id}" class="neumorphic-btn btn-sm">Editar</button><button data-action="delete" data-type="event" data-id="${event.id}" class="neumorphic-btn danger btn-sm">Eliminar</button></div></td></tr>`; } },
            directorio: { createRow(p) { return `<tr class="border-b"><td class="p-3 font-medium">${p.nombre || ''}</td><td class="p-3 hidden md:table-cell">${p.telefono || ''}</td><td class="p-3 hidden lg:table-cell">${p.emergencia_nombre || ''}</td><td class="p-3 admin-only-table-cell" data-permission="directorio"><div class="flex gap-2"><button data-action="edit" data-type="parroquiano" data-id="${p.id}" class="neumorphic-btn btn-sm">Editar</button><button data-action="delete" data-type="parroquiano" data-id="${p.id}" class="neumorphic-btn danger btn-sm">Eliminar</button></div></td></tr>`; } },
            calendario: {
                render(currentDate, events, parroquianos, headerEl, gridEl) {
                    headerEl.textContent = currentDate.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' }).toUpperCase();
                    gridEl.innerHTML = '';
                    const month = currentDate.getMonth();
                    const year = currentDate.getFullYear();
                    const firstDayOfMonth = new Date(year, month, 1).getDay();
                    const daysInMonth = new Date(year, month + 1, 0).getDate();
                    
                    for (let i = 0; i < firstDayOfMonth; i++) { gridEl.insertAdjacentHTML('beforeend', '<div></div>'); }

                    for (let day = 1; day <= daysInMonth; day++) {
                        const date = new Date(year, month, day);
                        const dateString = date.toISOString().split('T')[0];
                        const isToday = new Date().toDateString() === date.toDateString();
                        const dayEvents = events.filter(e => e.date === dateString);
                        const dayBirthdays = parroquianos.filter(p => p.nacimiento && p.nacimiento.substring(5) === dateString.substring(5));
                        
                        let itemsHtml = '<div class="calendar-items-container">';
                        dayEvents.slice(0, 2).forEach(e => { itemsHtml += `<div class="calendar-item event-item" title="${e.name} a las ${e.time}h">${e.name}</div>`; });
                        if (dayEvents.length > 2) { itemsHtml += `<div class="text-xs text-gray-500 pl-1.5">+${dayEvents.length - 2} más</div>`; }
                        dayBirthdays.forEach(p => { itemsHtml += `<div class="calendar-item birthday-item" title="Cumpleaños de ${p.nombre}">🎂 ${p.nombre.split(' ')[0]}</div>`; });
                        itemsHtml += '</div>';

                        gridEl.insertAdjacentHTML('beforeend', `
                            <div class="calendar-cell ${isToday ? 'is-today' : ''}" data-action="show-day-details" data-date="${dateString}">
                                <div class="calendar-day-number text-xs sm:text-sm">${day}</div>
                                ${itemsHtml}
                            </div>
                        `);
                    }
                }
            },
            userManagement: {
                render(users, tbody) {
                    tbody.innerHTML = '';
                    const permissionLabels = { agenda: 'Eventos', directorio: 'Directorio', noticias: 'Noticias', manuales: 'Manuales', recursos: 'Recursos' };
                    users.sort((a, b) => a.nombre.localeCompare(b.nombre)).forEach(user => {
                        const isSuperAdmin = user.role === 'superadmin';
                        
                        let permissionsHtml = Object.entries(permissionLabels).map(([key, label]) => `
                            <label class="flex items-center gap-1 text-xs ${isSuperAdmin ? 'opacity-50' : ''}">
                                <input type="checkbox" data-userid="${user.id}" data-permission="${key}" 
                                ${user.permissions?.[key] || isSuperAdmin ? 'checked' : ''} 
                                ${isSuperAdmin ? 'disabled' : ''} class="permission-checkbox">
                                ${label}
                            </label>
                        `).join('');

                        let roleSelectorHtml = `
                            <select class="neumorphic-input text-sm p-1 role-select" data-userid="${user.id}" ${isSuperAdmin ? 'disabled' : ''}>
                                <option value="user" ${user.role === 'user' ? 'selected' : ''}>Usuario</option>
                                <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                                ${isSuperAdmin ? '<option value="superadmin" selected>Super Admin</option>' : ''}
                            </select>
                        `;

                        tbody.insertAdjacentHTML('beforeend', `
                            <tr class="border-b ${isSuperAdmin ? 'bg-yellow-500/10' : ''}">
                                <td class="p-3 font-medium">${user.nombre}</td>
                                <td class="p-3">${user.email}</td>
                                <td class="p-3">${roleSelectorHtml}</td>
                                <td class="p-3"><div class="flex flex-wrap gap-2">${permissionsHtml}</div></td>
                                <td class="p-3">
                                    <button data-action="delete-user" data-userid="${user.id}" 
                                    class="neumorphic-btn danger btn-sm" ${isSuperAdmin ? 'disabled' : ''}>
                                        Eliminar
                                    </button>
                                </td>
                            </tr>
                        `);
                    });
                }
            },
            nav: {
                initMobileNav() {
                    let linksHtml = '';
                    document.querySelectorAll('#tabs-container .icon-nav-btn').forEach(btn => {
                        if (window.getComputedStyle(btn).display === 'none') return;
                        const svgIcon = btn.innerHTML;
                        const label = btn.title;
                        linksHtml += `
                            <button class="mobile-nav-btn ${btn.classList.contains('active') ? 'active' : ''}" data-target="${btn.dataset.target}">
                                ${svgIcon}
                                <span>${label}</span>
                            </button>`;
                    });
                    UI.elements.nav.mobileNavLinks.innerHTML = linksHtml;
                },
                toggleSidenav(open) { const { mobileSidenav, mobileSidenavOverlay } = UI.elements.nav; mobileSidenav.style.transform = open ? 'translateX(0)' : 'translateX(-100%)'; mobileSidenavOverlay.classList.toggle('active', open); }
            },
        };

        // =================================================================================
        // CONTROLADOR PRINCIPAL DE LA APLICACIÓN (App)
        // =================================================================================
        const App = {
            state: { auth: { user: null, isSuperAdmin: false, isAdmin: false, viewAsUser: false }, data: { events: [], parroquianos: [], news: [], manuales: [], archivos: [], allUsers: [] }, ui: { currentCalendarDate: new Date() }, },
            dataListenersInitialized: false,
            async init() { try { UI.init(); this.setupEventListeners(); this.initTheme(); this.initTimers(); FirebaseService.init(this.onAuthStateChanged.bind(this)); } catch (error) { console.error("Error fatal durante la inicialización:", error); document.body.innerHTML = `<div class="fixed inset-0 bg-red-100 text-red-800 p-8 flex flex-col justify-center items-center text-center"><h1 class="text-3xl font-bold">¡Ups! Ocurrió un error crítico.</h1><p class="mb-4">${error.message}</p></div>`; } },
            async onAuthStateChanged(authUser) {
                 let userProfile = null;
                 if (authUser) {
                     const userDoc = await FirebaseService.getDoc('users', authUser.uid);
                     if (userDoc.exists()) { userProfile = { id: authUser.uid, ...userDoc.data() }; } 
                     else if (authUser.email === 'admin@portal.com') { const superAdminProfile = { nombre: 'Super Admin', email: authUser.email, role: 'superadmin', permissions: {} }; await FirebaseService.setDoc('users', authUser.uid, superAdminProfile); userProfile = { id: authUser.uid, ...superAdminProfile }; }
                 }
                this.state.auth.user = userProfile;
                this.state.auth.isSuperAdmin = userProfile?.role === 'superadmin';
                this.state.auth.isAdmin = userProfile?.role === 'admin';
                this.updateLockscreenStatus();
                this.updateUIPermissions();
                if (!this.dataListenersInitialized && userProfile) { this.setupDataListeners(); this.loadWeather(); this.renderCalendario(); this.dataListenersInitialized = true; }
                if (UI.elements.appLoading.style.display !== 'none') { UI.elements.appLoading.style.display = 'none'; UI.elements.appContainer.classList.add('loaded'); }
            },
            setupDataListeners() {
                FirebaseService.onCollectionSnapshot('events', d => { this.state.data.events = d; this.renderAgenda(); this.renderTablero(); this.renderCalendario(); });
                FirebaseService.onCollectionSnapshot('parroquianos', d => { this.state.data.parroquianos = d; this.renderDirectorio(); this.renderTablero(); this.renderCalendario(); });
                FirebaseService.onCollectionSnapshot('users', users => { this.state.data.allUsers = users; if(this.state.auth.isSuperAdmin) { UI.userManagement.render(users, UI.elements.pages.userManagement.tableBody); } });
            },
            renderTablero() { UI.tablero.renderUpcomingEvents(this.state.data.events, UI.elements.pages.tablero.upcomingEventsList); UI.tablero.renderBirthdayReminders(this.state.data.parroquianos, UI.elements.pages.tablero.birthdayCard, UI.elements.pages.tablero.birthdayList); },
            renderAgenda() { UI.renderTable(UI.elements.pages.agenda.tableBody, this.state.data.events, UI.agenda.createRow, 'No hay eventos.'); },
            renderDirectorio() { UI.renderTable(UI.elements.pages.directorio.tableBody, this.state.data.parroquianos, UI.directorio.createRow, 'No hay registros.'); },
            renderCalendario() { UI.calendario.render(this.state.ui.currentCalendarDate, this.state.data.events, this.state.data.parroquianos, UI.elements.pages.calendario.header, UI.elements.pages.calendario.grid); },
            hasPermission(section) { const { viewAsUser, isSuperAdmin, isAdmin, user } = this.state.auth; if (viewAsUser) return false; if (isSuperAdmin) return true; return isAdmin && user.permissions?.[section] === true; },
            updateUIPermissions() { UI.updateAdminUI(this.state.auth.isSuperAdmin, this.state.auth.isAdmin, this.state.auth.user, this.state.auth.viewAsUser); document.querySelectorAll('[data-permission]').forEach(el => { el.style.display = this.hasPermission(el.dataset.permission) ? '' : 'none'; }); UI.nav.initMobileNav(); },
            updateLockscreenStatus() { const { user } = this.state.auth; const { unlockSwitch, unlockSwitchLabel, container } = UI.elements.lockscreen; if (user) { unlockSwitch.disabled = false; unlockSwitchLabel.classList.remove('disabled'); } else { unlockSwitch.disabled = true; unlockSwitch.checked = false; unlockSwitchLabel.classList.add('disabled'); if (container.classList.contains('fade-out')) { container.classList.remove('fade-out'); } } },
            setupEventListeners() {
                document.body.addEventListener('click', this.handleGlobalClick.bind(this));
                document.addEventListener('submit', this.handleFormSubmission.bind(this));
                document.body.addEventListener('change', this.handleGlobalChange.bind(this));

                // Listener para la tabla de usuarios
                UI.elements.pages.userManagement.tableBody.addEventListener('change', (e) => {
                    const target = e.target;
                    if (target.classList.contains('role-select')) {
                        this.handleRoleChange(target.dataset.userid, target.value);
                    } else if (target.classList.contains('permission-checkbox')) {
                        this.handlePermissionChange(target.dataset.userid, target.dataset.permission, target.checked);
                    }
                });

                UI.elements.lockscreen.unlockSwitch.addEventListener('change', (e) => { if (e.target.checked) setTimeout(() => UI.elements.lockscreen.container.classList.add('fade-out'), 300); });
                document.getElementById('prev-month-btn').addEventListener('click', () => { this.state.ui.currentCalendarDate.setMonth(this.state.ui.currentCalendarDate.getMonth() - 1); this.renderCalendario(); });
                document.getElementById('next-month-btn').addEventListener('click', () => { this.state.ui.currentCalendarDate.setMonth(this.state.ui.currentCalendarDate.getMonth() + 1); this.renderCalendario(); });
                UI.elements.nav.edgeHandle.addEventListener('click', () => UI.nav.toggleSidenav(true));
                UI.elements.nav.mobileSidenavOverlay.addEventListener('click', () => UI.nav.toggleSidenav(false));
            },
            handleGlobalClick(e) {
                const target = e.target.closest('[data-action], [data-target], [data-modal-target], .accordion-toggle, #show-login-btn, #show-register-btn');
                if (!target) return;
                const { action, target: pageTarget, modalTarget, type, id, userid } = target.dataset;
                if (pageTarget) { UI.showPage(pageTarget); if (target.closest('#mobile-nav-links')) UI.nav.toggleSidenav(false); }
                if (modalTarget) this.openModal(modalTarget);
                if (action) { const actionHandlers = { 'logout': this.handleLogout.bind(this), 'close-modal': () => this.closeModal(target.closest('.fixed.inset-0').id), 'close-sidenav': () => UI.nav.toggleSidenav(false), 'edit': () => this.handleEdit(type, id), 'delete': () => this.handleDelete(type, id), 'delete-user': () => this.handleDeleteUser(userid), 'show-day-details': () => this.handleShowDayDetails(target.dataset.date), }; if(actionHandlers[action]) actionHandlers[action](); }
                if (target.matches('.accordion-toggle')) { target.classList.toggle('active'); const content = target.nextElementSibling; content.style.maxHeight = content.style.maxHeight ? null : `${content.scrollHeight}px`; }
                if(target.id === 'show-register-btn') { e.preventDefault(); document.getElementById('login-view').classList.add('hidden'); document.getElementById('register-view').classList.remove('hidden'); target.classList.add('active'); document.getElementById('show-login-btn').classList.remove('active'); }
                if(target.id === 'show-login-btn') { e.preventDefault(); document.getElementById('register-view').classList.add('hidden'); document.getElementById('login-view').classList.remove('hidden'); target.classList.add('active'); document.getElementById('show-register-btn').classList.remove('active'); }
            },
            handleFormSubmission(e) { e.preventDefault(); const formId = e.target.id; const formHandlers = { 'login-form': this.handleLogin, 'register-form': this.handleRegister, }; (formHandlers[formId] || this.handleGenericFormSubmit).call(this, e.target); },
            handleGlobalChange(e) { const target = e.target; if (target.id === 'view-as-user-switch') { this.state.auth.viewAsUser = e.target.checked; this.updateUIPermissions(); } },
            async handleLogin(form) {
                const email = form.querySelector('#login-email').value;
                const password = form.querySelector('#login-password').value;
                const errorMsg = form.querySelector('#login-error-msg');
                errorMsg.classList.add('hidden');
                try {
                    await signInWithEmailAndPassword(FirebaseService.auth, email, password);
                    this.closeModal('user-auth-modal');
                    form.reset();
                } catch (error) {
                    console.error("Error de inicio de sesión:", error.code);
                    errorMsg.textContent = "Correo o contraseña incorrectos.";
                    errorMsg.classList.remove('hidden');
                }
            },
            async handleRegister(form) {
                const name = form.querySelector('#register-name').value;
                const email = form.querySelector('#register-email').value;
                const password = form.querySelector('#register-password').value;
                const errorMsg = form.querySelector('#register-error-msg');
                errorMsg.classList.add('hidden');

                if (password.length < 6) {
                    errorMsg.textContent = "La contraseña debe tener al menos 6 caracteres.";
                    errorMsg.classList.remove('hidden');
                    return;
                }

                try {
                    const userCredential = await createUserWithEmailAndPassword(FirebaseService.auth, email, password);
                    const newUser = {
                        nombre: name,
                        email: email,
                        role: 'user',
                        permissions: { agenda: false, directorio: false, noticias: false, manuales: false, recursos: false }
                    };
                    await FirebaseService.setDoc('users', userCredential.user.uid, newUser);
                    this.closeModal('user-auth-modal');
                    form.reset();
                } catch (error) {
                    console.error("Error de registro:", error.code);
                    if (error.code === 'auth/email-already-in-use') {
                        errorMsg.textContent = "Este correo electrónico ya está en uso.";
                    } else {
                        errorMsg.textContent = "Ocurrió un error al registrar la cuenta.";
                    }
                    errorMsg.classList.remove('hidden');
                }
            },
            async handleLogout() { await signOut(FirebaseService.auth); window.location.reload(); },
            async handleGenericFormSubmit(form) {
                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());
                const type = form.dataset.type;
                const id = data.id; 
                delete data.id;

                try {
                    await FirebaseService.saveDoc(type, id, data);
                    this.closeModal(`${type}-modal`);
                } catch(error) {
                    console.error(`Error al guardar ${type}:`, error);
                    alert(`No se pudo guardar la información. Verifique la consola para más detalles.`);
                }
            },
            handleEdit(type, id) {
                const collection = this.state.data[type + 's'] || this.state.data[type]; // 'events', 'parroquianos' etc.
                const item = collection.find(i => i.id === id);
                if (item) {
                    this.openModal(`${type}-modal`, item);
                }
            },
            handleDelete(type, id) {
                const confirmModal = UI.elements.modals.confirm;
                UI.elements.confirmModal.message.textContent = `¿Estás seguro de que quieres eliminar este elemento de ${type}? Esta acción no se puede deshacer.`;
                this.openModal('confirm-modal');

                const deleteHandler = async () => {
                    try {
                        await FirebaseService.deleteDoc(type, id);
                        this.closeModal('confirm-modal');
                    } catch (error) {
                        console.error(`Error al eliminar ${type}:`, error);
                    }
                    UI.elements.confirmModal.deleteBtn.removeEventListener('click', deleteHandler);
                };
                UI.elements.confirmModal.deleteBtn.addEventListener('click', deleteHandler, { once: true });
            },
            async handleRoleChange(userId, newRole) {
                try {
                    await FirebaseService.saveDoc('users', userId, { role: newRole });
                } catch (error) {
                    console.error("Error al cambiar el rol:", error);
                }
            },
            async handlePermissionChange(userId, permission, value) {
                try {
                    await FirebaseService.saveDoc('users', userId, { [`permissions.${permission}`]: value });
                } catch (error) {
                    console.error("Error al cambiar el permiso:", error);
                }
            },
            handleDeleteUser(userId) {
                const userToDelete = this.state.data.allUsers.find(u => u.id === userId);
                if (!userToDelete) return;

                UI.elements.confirmModal.message.textContent = `¿Estás seguro de que quieres eliminar al usuario ${userToDelete.nombre}? Esta acción no se puede deshacer.`;
                this.openModal('confirm-modal');
                
                const deleteHandler = async () => {
                    // Nota: Eliminar un usuario de Firestore no lo elimina de Firebase Authentication.
                    // Se necesita una función de backend (Cloud Function) para eso de forma segura.
                    // Por ahora, solo lo eliminamos de la colección de usuarios.
                    try {
                        await FirebaseService.deleteDoc('users', userId);
                        this.closeModal('confirm-modal');
                    } catch (error) {
                        console.error("Error al eliminar el usuario:", error);
                    }
                    UI.elements.confirmModal.deleteBtn.removeEventListener('click', deleteHandler);
                };
                UI.elements.confirmModal.deleteBtn.addEventListener('click', deleteHandler, { once: true });
            },
            handleShowDayDetails(dateString) {
                const date = new Date(dateString + 'T00:00:00Z');
                const { events, parroquianos } = this.state.data;
                
                const dayEvents = events.filter(e => e.date === dateString).sort((a,b) => a.time.localeCompare(b.time));
                const dayBirthdays = parroquianos.filter(p => p.nacimiento && p.nacimiento.substring(5) === dateString.substring(5));

                UI.calendarDayModal.title.textContent = date.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                
                const eventsList = UI.elements.calendarDayModal.eventsList;
                eventsList.innerHTML = dayEvents.length ? dayEvents.map(e => `<li><div class="p-2 rounded-lg neumorphic-inset"><p class="font-semibold">${e.name}</p><p class="text-sm">${e.time}h</p></div></li>`).join('') : '<li class="text-gray-500">No hay eventos.</li>';

                const birthdaysSection = UI.elements.calendarDayModal.birthdaysSection;
                const birthdaysList = UI.elements.calendarDayModal.birthdaysList;
                if (dayBirthdays.length > 0) {
                    birthdaysList.innerHTML = dayBirthdays.map(p => `<li><div class="p-2 rounded-lg neumorphic-inset"><p class="font-semibold">${p.nombre}</p></div></li>`).join('');
                    birthdaysSection.classList.remove('hidden');
                } else {
                    birthdaysSection.classList.add('hidden');
                }

                this.openModal('calendar-day-modal');
            },
            initTimers() {
                setInterval(() => {
                    const now = new Date();
                    UI.tablero.updateDateTime(UI.elements.pages.tablero.currentDate, UI.elements.pages.tablero.currentTime);
                    if(UI.elements.lockscreen.time) {
                        UI.elements.lockscreen.time.textContent = now.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                        UI.elements.lockscreen.date.textContent = now.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
                    }
                }, 1000);
            },
            async loadWeather() { const data = await WeatherService.fetch(); UI.tablero.updateWeather(data, UI.elements.pages.tablero.weatherTemp, UI.elements.pages.tablero.weatherDesc, UI.elements.pages.tablero.weatherLocation, UI.elements.pages.tablero.weatherWidget, UI.elements.pages.tablero.animatedWeatherIcon); },
            initTheme() { const themeSwitch = UI.elements.header.themeSwitch; const savedTheme = localStorage.getItem('theme'); const applyTheme = (theme) => { document.body.classList.toggle('dark-theme', theme === 'dark'); themeSwitch.checked = theme === 'dark'; }; if (savedTheme) applyTheme(savedTheme); else if (window.matchMedia?.('(prefers-color-scheme: dark)').matches) applyTheme('dark'); themeSwitch.addEventListener('change', () => { const newTheme = themeSwitch.checked ? 'dark' : 'light'; localStorage.setItem('theme', newTheme); applyTheme(newTheme); }); },
            openModal(modalId, data = null) { 
                const modal = document.getElementById(modalId); 
                if(!modal) return;
                
                const form = modal.querySelector('form');
                if (form) {
                    form.reset();
                    const title = modal.querySelector('h2');
                    if (data) {
                        if (title) title.textContent = `Editar ${form.dataset.type.charAt(0).toUpperCase() + form.dataset.type.slice(1)}`;
                        Object.keys(data).forEach(key => {
                            const input = form.querySelector(`[name="${key}"]`);
                            if (input) input.value = data[key];
                        });
                        const idInput = form.querySelector('[name="id"]');
                        if(idInput) idInput.value = data.id;
                    } else {
                         if (title) title.textContent = `Agregar ${form.dataset.type.charAt(0).toUpperCase() + form.dataset.type.slice(1)}`;
                         const idInput = form.querySelector('[name="id"]');
                         if(idInput) idInput.value = '';
                    }
                }
                modal.classList.remove('hidden');
            },
            closeModal(modalId) { const modal = document.getElementById(modalId); if(modal) modal.classList.add('hidden'); }
        };
        
        // --- INICIALIZACIÓN DE LA APLICACIÓN ---
        document.addEventListener('DOMContentLoaded', () => App.init());

    </script>
</body>
</html>
