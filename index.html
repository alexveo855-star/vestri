<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Parroquial</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⛪</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@600&display=swap" rel="stylesheet">
    <style>
        /* --- Base y Diseño Neumorfista --- */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #eef0f4;
            color: #4b5563;
            transition: background-color 0.5s ease, color 0.5s ease;
        }
        .fade-out {
            opacity: 0;
            pointer-events: none;
        }
        #app-loading {
            position: fixed; inset: 0; display: flex; align-items: center; justify-content: center;
            background-color: #eef0f4; z-index: 100; font-size: 1.25rem; color: #4b5563;
        }
        #app-container { opacity: 0; transition: opacity 0.3s ease-in-out; }
        #app-container.loaded { opacity: 1; }
        .page { display: none; }
        .page.active { display: block; }

        /* --- Visibilidad del Administrador --- */
        .admin-only, .admin-only-table-cell {
            display: none !important;
        }
        .admin-mode .admin-only {
            display: inline-flex !important;
        }
         .admin-mode .admin-only-block {
            display: block !important;
        }
        .admin-mode .admin-only-table-cell {
            display: table-cell !important;
        }
        
        .super-admin-only { display: none !important; }
        .super-admin-mode .super-admin-only { display: flex !important; }
        .super-admin-mode .super-admin-only-table-cell { display: table-cell !important; }

        /* Tarjeta Neumorfista (Extruida) */
        .neumorphic-card {
            background: #eef0f4;
            border-radius: 20px;
            box-shadow: 8px 8px 16px #d1d9e6, -8px -8px 16px #ffffff;
            transition: background-color 0.5s ease, box-shadow 0.5s ease;
        }

        /* Estilo Presionado (Intruido) */
        .neumorphic-inset {
            box-shadow: inset 6px 6px 12px #d1d9e6, inset -6px -6px 12px #ffffff;
             transition: box-shadow 0.5s ease;
        }

        /* Botones Neumorfistas */
        .neumorphic-btn {
            padding: 0.5rem 1rem;
            border-radius: 10px;
            border: none;
            background: #eef0f4;
            box-shadow: 4px 4px 8px #d1d9e6, -4px -4px 8px #ffffff;
            color: #4b5563;
            font-weight: 500;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .neumorphic-btn:hover {
            box-shadow: 2px 2px 4px #d1d9e6, -2px -2px 4px #ffffff;
        }
        .neumorphic-btn:active, .neumorphic-btn.active {
            box-shadow: inset 4px 4px 8px #d1d9e6, inset -4px -4px 8px #ffffff;
            color: #3b82f6;
        }
        .neumorphic-btn.primary { color: #3b82f6; font-weight: 600; }
        .neumorphic-btn.danger { color: #ef4444; }
        .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.875rem; }
        .neumorphic-btn:disabled {
            cursor: not-allowed;
            opacity: 0.7;
            box-shadow: inset 2px 2px 4px #d1d9e6, inset -2px -2px 4px #ffffff;
        }

        /* --- Estilos de Botones de Navegación (UIVERSE.IO by lenfear23) --- */
        .nav-button {
          display: flex;
          align-items: center;
          justify-content: center;
          outline: none;
          cursor: pointer;
          width: 150px;
          height: 50px;
          background-image: linear-gradient(to top, #D8D9DB 0%, #fff 80%, #FDFDFD 100%);
          border-radius: 30px;
          border: 1px solid #8F9092;
          transition: all 0.2s ease;
          font-family: "Source Sans Pro", sans-serif;
          font-size: 14px;
          font-weight: 600;
          color: #606060;
          text-shadow: 0 1px #fff;
        }
        
        .nav-button:hover {
          box-shadow: 0 4px 3px 1px #FCFCFC, 0 6px 8px #D6D7D9, 0 -4px 4px #CECFD1, 0 -6px 4px #FEFEFE, inset 0 0 3px 3px #CECFD1;
        }
        
        .nav-button:active,
        .nav-button.active {
          box-shadow: 0 4px 3px 1px #FCFCFC, 0 6px 8px #D6D7D9, 0 -4px 4px #CECFD1, 0 -6px 4px #FEFEFE, inset 0 0 5px 3px #999, inset 0 0 30px #aaa;
        }
        
        .nav-button:focus {
          box-shadow: 0 4px 3px 1px #FCFCFC, 0 6px 8px #D6D7D9, 0 -4px 4px #CECFD1, 0 -6px 4px #FEFEFE, inset 0 0 5px 3px #999, inset 0 0 30px #aaa;
        }

        /* Campos de Formulario */
        .neumorphic-input {
            width: 100%;
            background: #eef0f4;
            border: none;
            border-radius: 10px;
            padding: 0.75rem 1rem;
            box-shadow: inset 4px 4px 8px #d1d9e6, inset -4px -4px 8px #ffffff;
            transition: background-color 0.5s ease, box-shadow 0.5s ease, color 0.5s ease;
            color: #4b5563;
        }
        select.neumorphic-input {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }
        .neumorphic-input:focus { outline: none; }
        textarea.neumorphic-input { resize: none; }

        /* Estilos del Calendario */
        .calendar-cell {
            min-height: 100px; padding: 0.25rem; border-radius: 10px; background: #eef0f4;
            transition: all 0.2s ease-in-out; border: 1px solid transparent; display: flex; flex-direction: column;
        }
        @media (min-width: 768px) { .calendar-cell { min-height: 120px; padding: 0.5rem; } }
        .calendar-cell.is-today { box-shadow: inset 4px 4px 8px #d1d9e6, inset -4px -4px 8px #ffffff; border-color: #3b82f6; }
        .calendar-cell.not-current-month { color: #9ca3af; background: transparent; }
        .calendar-day-number { font-weight: 600; margin-bottom: 0.25rem; }
        .calendar-items-container { flex-grow: 1; overflow-y: auto; }
        .calendar-item {
            font-size: 0.75rem; padding: 2px 6px; border-radius: 6px; margin-bottom: 4px;
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap; cursor: default;
        }
        .event-item { background-color: #bfdbfe; color: #1e40af; }
        .birthday-item { background-color: #fef08a; color: #854d0e; }

        /* Estilos del Panel Edge Móvil */
        #mobile-sidenav-overlay {
            position: fixed; inset: 0; background-color: rgba(31, 41, 55, 0.5); z-index: 55;
            opacity: 0; transition: opacity 0.3s ease-in-out; pointer-events: none;
        }
        #mobile-sidenav {
            position: fixed; top: 0; left: 0; bottom: 0; width: 280px; background-color: #eef0f4;
            z-index: 60; transform: translateX(-100%); padding: 1.5rem; display: flex; flex-direction: column; will-change: transform;
            transition: background-color 0.5s ease;
        }
        #mobile-sidenav.is-transitioning { transition: transform 0.3s ease-in-out, background-color 0.5s ease; }
        #mobile-sidenav.active { transform: translateX(0); }
        #mobile-sidenav-overlay.active { opacity: 1; pointer-events: auto; }

        #edge-handle {
            position: fixed; top: 25%; left: 0; transform: translateY(-50%); width: 20px; height: 160px;
            background-color: rgba(107, 114, 128, 0.4); border-top-right-radius: 10px; border-bottom-right-radius: 10px;
            z-index: 50; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }
        #edge-handle::before { content: ''; width: 4px; height: 20px; background: #fff; border-radius: 2px; }

        /* Estilos de la Galería de Noticias */
        .gallery-thumbnail {
            width: 80px; height: 60px; border-radius: 8px; cursor: pointer; object-fit: cover;
            opacity: 0.6; transition: all 0.2s ease-in-out; border: 2px solid transparent; flex-shrink: 0;
        }
        .gallery-thumbnail.active { opacity: 1; border-color: #3b82f6; box-shadow: 0 0 0 3px #eef0f4; }
        #news-gallery-thumbnails { -ms-overflow-style: none; scrollbar-width: none; }
        #news-gallery-thumbnails::-webkit-scrollbar { display: none; }

        /* Estilos de Acordeón */
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out;
        }
        .accordion-icon {
            transition: transform 0.3s ease-in-out;
        }
        .accordion-toggle.active .accordion-icon {
            transform: rotate(180deg);
        }

        /* Estilos del Interruptor de Vista */
        #view-as-user-switch:checked ~ .dot {
          transform: translateX(1rem); /* 16px */
        }
        #view-as-user-switch:checked ~ .block {
          background-color: #3b82f6;
        }
        body.dark-theme #view-as-user-switch:checked ~ .block {
          background-color: #60a5fa;
        }
        .dot {
            transition: transform 0.2s ease-in-out;
        }

        /* Estilos del Interruptor de Rol de Usuario */
        .user-role-switch:checked ~ .dot {
          transform: translateX(1rem);
        }
        .user-role-switch:checked ~ .block {
          background-color: #3b82f6;
        }
        body.dark-theme .user-role-switch:checked ~ .block {
          background-color: #60a5fa;
        }

        /* --- Pantalla de Bloqueo --- */
        #app-lockscreen {
             background-color: #eef0f4;
             transition: background-color 0.5s ease, opacity 0.5s ease-in-out;
        }

        /* --- Estilos del Interruptor de Desbloqueo --- */
        .unlock-switch-label {
            display: inline-block;
            width: 120px;
            height: 60px;
            transition: opacity 0.3s ease;
        }
        .unlock-switch-label.disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }
        .unlock-switch-track {
            position: relative;
            width: 100%;
            height: 100%;
            border-radius: 30px;
        }
        .unlock-switch-thumb {
            position: absolute;
            top: 5px;
            left: 5px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            transition: transform 0.3s ease-in-out, background-color 0.3s;
        }
        #unlock-switch:checked + .unlock-switch-track .unlock-switch-thumb {
            transform: translateX(60px);
            background-color: #d1fae5; /* Verde claro para indicar 'desbloqueado' */
        }

        /* --- ESTILOS DEL INTERRUPTOR DE TEMA (UIVERSE.IO) --- */
        .theme-switch {
          --toggle-size: 24px;
          --container-width: 5.625em;
          --container-height: 2.5em;
          --container-radius: 6.25em;
          --container-light-bg: #3D7EAE;
          --container-night-bg: #1D1F2C;
          --circle-container-diameter: 3.375em;
          --sun-moon-diameter: 2.125em;
          --sun-bg: #ECCA2F;
          --moon-bg: #C4C9D1;
          --spot-color: #959DB1;
          --circle-container-offset: calc((var(--circle-container-diameter) - var(--container-height)) / 2 * -1);
          --stars-color: #fff;
          --clouds-color: #F3FDFF;
          --back-clouds-color: #AACADF;
          --transition: .5s cubic-bezier(0, -0.02, 0.4, 1.25);
          --circle-transition: .3s cubic-bezier(0, -0.02, 0.35, 1.17);
        }

        .theme-switch, .theme-switch *, .theme-switch *::before, .theme-switch *::after {
          box-sizing: border-box;
          margin: 0;
          padding: 0;
          font-size: var(--toggle-size);
        }

        .theme-switch__container {
          width: var(--container-width);
          height: var(--container-height);
          background-color: var(--container-light-bg);
          border-radius: var(--container-radius);
          overflow: hidden;
          cursor: pointer;
          box-shadow: 0em -0.062em 0.062em rgba(0, 0, 0, 0.25), 0em 0.062em 0.125em rgba(255, 255, 255, 0.94);
          transition: var(--transition);
          position: relative;
        }

        .theme-switch__container::before {
          content: "";
          position: absolute;
          z-index: 1;
          inset: 0;
          box-shadow: 0em 0.05em 0.187em rgba(0, 0, 0, 0.25) inset, 0em 0.05em 0.187em rgba(0, 0, 0, 0.25) inset;
          border-radius: var(--container-radius)
        }

        .theme-switch__checkbox {
          display: none;
        }

        .theme-switch__circle-container {
          width: var(--circle-container-diameter);
          height: var(--circle-container-diameter);
          background-color: rgba(255, 255, 255, 0.1);
          position: absolute;
          left: var(--circle-container-offset);
          top: var(--circle-container-offset);
          border-radius: var(--container-radius);
          box-shadow: inset 0 0 0 3.375em rgba(255, 255, 255, 0.1), inset 0 0 0 3.375em rgba(255, 255, 255, 0.1), 0 0 0 0.625em rgba(255, 255, 255, 0.1), 0 0 0 1.25em rgba(255, 255, 255, 0.1);
          display: flex;
          transition: var(--circle-transition);
          pointer-events: none;
        }

        .theme-switch__sun-moon-container {
          pointer-events: auto;
          position: relative;
          z-index: 2;
          width: var(--sun-moon-diameter);
          height: var(--sun-moon-diameter);
          margin: auto;
          border-radius: var(--container-radius);
          background-color: var(--sun-bg);
          box-shadow: 0.062em 0.062em 0.062em 0em rgba(254, 255, 239, 0.61) inset, 0em -0.062em 0.062em 0em #a1872a inset;
          filter: drop-shadow(0.062em 0.125em 0.125em rgba(0, 0, 0, 0.25)) drop-shadow(0em 0.062em 0.125em rgba(0, 0, 0, 0.25));
          overflow: hidden;
          transition: var(--transition);
        }

        .theme-switch__moon {
          transform: translateX(100%);
          width: 100%;
          height: 100%;
          background-color: var(--moon-bg);
          border-radius: inherit;
          box-shadow: 0.062em 0.062em 0.062em 0em rgba(254, 255, 239, 0.61) inset, 0em -0.062em 0.062em 0em #969696 inset;
          transition: var(--transition);
          position: relative;
        }

        .theme-switch__spot {
          position: absolute;
          top: 0.75em;
          left: 0.312em;
          width: 0.75em;
          height: 0.75em;
          border-radius: var(--container-radius);
          background-color: var(--spot-color);
          box-shadow: 0em 0.0312em 0.062em rgba(0, 0, 0, 0.25) inset;
        }

        .theme-switch__spot:nth-of-type(2) {
          width: 0.375em;
          height: 0.375em;
          top: 0.937em;
          left: 1.375em;
        }

        .theme-switch__spot:nth-last-of-type(3) {
          width: 0.25em;
          height: 0.25em;
          top: 0.312em;
          left: 0.812em;
        }

        .theme-switch__clouds {
          width: 1.25em;
          height: 1.25em;
          background-color: var(--clouds-color);
          border-radius: var(--container-radius);
          position: absolute;
          bottom: -0.625em;
          left: 0.312em;
          box-shadow: 0.937em 0.312em var(--clouds-color), -0.312em -0.312em var(--back-clouds-color), 1.437em 0.375em var(--clouds-color), 0.5em -0.125em var(--back-clouds-color), 2.187em 0 var(--clouds-color), 1.25em -0.062em var(--back-clouds-color), 2.937em 0.312em var(--clouds-color), 2em -0.312em var(--back-clouds-color), 3.625em -0.062em var(--clouds-color), 2.625em 0em var(--back-clouds-color), 4.5em -0.312em var(--clouds-color), 3.375em -0.437em var(--back-clouds-color), 4.625em -1.75em 0 0.437em var(--clouds-color), 4em -0.625em var(--back-clouds-color), 4.125em -2.125em 0 0.437em var(--back-clouds-color);
          transition: 0.5s cubic-bezier(0, -0.02, 0.4, 1.25);
        }

        .theme-switch__stars-container {
          position: absolute;
          color: var(--stars-color);
          top: -100%;
          left: 0.312em;
          width: 2.75em;
          height: auto;
          transition: var(--transition);
        }

        .theme-switch__checkbox:checked + .theme-switch__container {
          background-color: var(--container-night-bg);
        }

        .theme-switch__checkbox:checked + .theme-switch__container .theme-switch__circle-container {
          left: calc(100% - var(--circle-container-offset) - var(--circle-container-diameter));
        }

        .theme-switch__checkbox:checked + .theme-switch__container .theme-switch__circle-container:hover {
          left: calc(100% - var(--circle-container-offset) - var(--circle-container-diameter) - 0.187em)
        }

        .theme-switch__circle-container:hover {
          left: calc(var(--circle-container-offset) + 0.187em);
        }

        .theme-switch__checkbox:checked + .theme-switch__container .theme-switch__moon {
          transform: translate(0);
        }

        .theme-switch__checkbox:checked + .theme-switch__container .theme-switch__clouds {
          bottom: -4.062em;
        }

        .theme-switch__checkbox:checked + .theme-switch__container .theme-switch__stars-container {
          top: 50%;
          transform: translateY(-50%);
        }

        /* --- Estilos del Widget de Clima --- */
        .weather-widget {
          display: flex;
          flex-direction: column;
          align-items: center;
          height: 200px;
          width: 100%;
          border-radius: 20px;
          overflow: hidden;
          box-shadow: rgba(0, 0, 0, 0.15) 2px 3px 4px;
        }

        .weather-widget .info-section {
          position: relative;
          display: flex;
          align-items: center;
          justify-content: space-between;
          width: 100%;
          height: 100%;
          color: white;
        }

        .weather-widget .left-side {
          display: flex;
          flex-direction: column;
          justify-content: space-around;
          height: 100%;
          z-index: 1;
          padding-left: 18px;
        }

        .weather-widget .weather {
          display: flex;
          align-items: center;
          justify-content: flex-start;
          gap: 5px;
          font-size: 0.9rem;
        }

        .weather-widget .weather div:nth-child(1) {
          width: 30px;
          height: auto;
        }

        .weather-widget .temperature {
          font-size: 3rem;
          font-weight: 600;
        }

        .weather-widget .right-side {
          display: flex;
          flex-direction: column;
          align-items: flex-end;
          justify-content: space-around;
          height: 100%;
          padding-right: 18px;
          z-index: 1;
        }

        .weather-widget .right-side > div {
          display: flex;
          flex-direction: column;
          align-items: flex-end;
        }

        .weather-widget .hour {
          font-size: 2.25rem;
          font-weight: 600;
          line-height: 1em;
        }

        .weather-widget .date {
          font-size: 1rem;
        }
         .weather-widget .city {
            font-size: 0.9rem;
         }

        .weather-widget .background-design {
          position: absolute;
          height: 100%;
          width: 100%;
          background-color: #ec7263;
          overflow: hidden;
        }

        .weather-widget .circle {
          background-color: #efc745;
        }

        .weather-widget .circle:nth-child(1) {
          position: absolute;
          top: -80%;
          right: -50%;
          width: 300px;
          height: 300px;
          opacity: 0.4;
          border-radius: 50%;
        }

        .weather-widget .circle:nth-child(2) {
          position: absolute;
          top: -70%;
          right: -30%;
          width: 210px;
          height: 210px;
          opacity: 0.4;
          border-radius: 50%;
        }

        .weather-widget .circle:nth-child(3) {
          position: absolute;
          top: -35%;
          right: -8%;
          width: 100px;
          height: 100px;
          opacity: 1;
          border-radius: 50%;
        }
        
        /* --- ESTILOS MODAL AUTH (UIVERSE.IO) --- */
        #user-auth-modal .content {
          width: 330px;
          padding: 40px 30px;
          background: #dde1e7;
          border-radius: 10px;
          box-shadow: -3px -3px 7px #ffffff73,
                      2px 2px 5px rgba(94,104,121,0.288);
        }
        
        #user-auth-modal .auth-tabs {
            display: flex;
            justify-content: space-around;
            margin-bottom: 25px;
            border-radius: 25px;
            background: #dde1e7;
            box-shadow: inset 2px 2px 5px #BABECC, inset -5px -5px 10px #ffffff73;
        }
        #user-auth-modal .auth-tab {
            width: 50%;
            padding: 10px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 18px;
            font-weight: 600;
            color: #595959;
            border-radius: 25px;
            transition: all 0.3s ease;
        }
        #user-auth-modal .auth-tab.active {
            color: #3498db;
            background: #dde1e7;
            box-shadow: 2px 2px 5px #BABECC, -5px -5px 10px #ffffff73;
        }

        #user-auth-modal .text {
          font-size: 33px;
          font-weight: 600;
          margin-bottom: 35px;
          color: #595959;
          text-align: center;
        }

        #user-auth-modal .field {
          height: 50px;
          width: 100%;
          display: flex;
          position: relative;
          margin-top: 20px;
        }
        #user-auth-modal form .field:first-of-type {
            margin-top: 0;
        }

        #user-auth-modal .field .input {
          height: 100%;
          width: 100%;
          padding-left: 45px;
          outline: none;
          border: none;
          font-size: 18px;
          background: #dde1e7;
          color: #595959;
          border-radius: 25px;
          box-shadow: inset 2px 2px 5px #BABECC,
                      inset -5px -5px 10px #ffffff73;
        }

        #user-auth-modal .field .input:focus {
          box-shadow: inset 1px 1px 2px #BABECC,
                      inset -1px -1px 2px #ffffff73;
        }
        #user-auth-modal .field .input:focus ~ .label {
            opacity: 0;
        }

        #user-auth-modal .field .span {
          position: absolute;
          color: #595959;
          width: 50px;
          line-height: 55px;
        }

        #user-auth-modal .field .label {
          position: absolute;
          top: 50%;
          transform: translateY(-50%);
          left: 45px;
          pointer-events: none;
          color: #666666;
          transition: opacity 0.2s ease;
        }

        #user-auth-modal .field .input:valid ~ .label {
          opacity: 0;
        }

        #user-auth-modal .forgot-pass {
          text-align: left;
          margin: 10px 0 10px 5px;
        }

        #user-auth-modal .forgot-pass a {
          font-size: 16px;
          color: #666666;
          text-decoration: none;
        }

        #user-auth-modal .forgot-pass:hover a {
          text-decoration: underline;
        }

        #user-auth-modal .button {
          margin: 15px 0;
          width: 100%;
          height: 50px;
          font-size: 18px;
          line-height: 50px;
          font-weight: 600;
          background: #dde1e7;
          border-radius: 25px;
          border: none;
          outline: none;
          cursor: pointer;
          color: #595959;
          box-shadow: 2px 2px 5px #BABECC,
                      -5px -5px 10px #ffffff73;
        }

        #user-auth-modal .button:focus {
          color: #3498db;
          box-shadow: inset 2px 2px 5px #BABECC,
                     inset -5px -5px 10px #ffffff73;
        }

        #user-auth-modal .sign-up {
          margin: 10px 0;
          color: #595959;
          font-size: 16px;
        }

        #user-auth-modal .sign-up a {
          color: #3498db;
          text-decoration: none;
        }

        #user-auth-modal .sign-up a:hover {
          text-decoration: underline;
        }
        
        /* --- ESTILOS REDES SOCIALES (UIVERSE.IO by MijailVillegas) --- */
        .card {
         max-width: fit-content;
         border-radius: 15px;
         display: flex;
         flex-direction: column;
         align-content: center;
         justify-content: center;
         gap: 1rem;
         backdrop-filter: blur(15px);
         box-shadow: inset 0 0 20px rgba(255, 255, 255, 0.192),
           inset 0 0 5px rgba(255, 255, 255, 0.274), 0 5px 5px rgba(0, 0, 0, 0.164);
         transition: 0.5s;
        }

        .card:hover {
         animation: ease-out 5s;
         background: rgba(173, 173, 173, 0.05);
        }

        .card ul {
         padding: 1rem;
         display: flex;
         list-style: none;
         gap: 1rem;
         align-items: center;
         justify-content: center;
         align-content: center;
         flex-wrap: wrap;
         flex-direction: row;
        }

        .card ul li {
         cursor: pointer;
        }

        .svg {
         transition: all 0.3s;
         padding: 1rem;
         height: 60px;
         width: 60px;
         border-radius: 100%;
         color: rgb(255, 174, 0);
         fill: currentColor;
         box-shadow: inset 0 0 20px rgba(255, 255, 255, 0.3),
           inset 0 0 5px rgba(255, 255, 255, 0.5), 0 5px 5px rgba(0, 0, 0, 0.164);
        }

        .text {
         opacity: 0;
         border-radius: 5px;
         padding: 5px;
         transition: all 0.3s;
         color: rgb(255, 174, 0);
         background-color: rgba(255, 255, 255, 0.3);
         position: absolute;
         z-index: 9999;
         box-shadow: -5px 0 1px rgba(153, 153, 153, 0.2),
           -10px 0 1px rgba(153, 153, 153, 0.2),
           inset 0 0 20px rgba(255, 255, 255, 0.3),
           inset 0 0 5px rgba(255, 255, 255, 0.5), 0 5px 5px rgba(0, 0, 0, 0.082);
        }

        /*isometric prooyection*/
        .iso-pro {
         transition: 0.5s;
         position: relative;
        }
        .iso-pro:hover a > .svg {
         transform: translate(15px, -15px);
         border-radius: 100%;
        }

        .iso-pro:hover .text {
         opacity: 1;
         transform: translate(25px, -2px) skew(-5deg);
        }

        .iso-pro:hover .svg {
         transform: translate(5px, -5px);
        }

        .iso-pro span {
         opacity: 0;
         position: absolute;
         color: #1877f2;
         border-color: #1877f2;
         box-shadow: inset 0 0 20px rgba(255, 255, 255, 0.3),
           inset 0 0 5px rgba(255, 255, 255, 0.5), 0 5px 5px rgba(0, 0, 0, 0.164);
         border-radius: 50%;
         transition: all 0.3s;
         height: 60px;
         width: 60px;
         top: 0;
         left: 0;
        }

        .iso-pro:hover span {
         opacity: 1;
        }

        .iso-pro:hover span:nth-child(1) {
         opacity: 0.2;
        }

        .iso-pro:hover span:nth-child(2) {
         opacity: 0.4;
         transform: translate(5px, -5px);
        }

        .iso-pro:hover span:nth-child(3) {
         opacity: 0.6;
         transform: translate(10px, -10px);
        }
        
        /* --- ESTILOS DEL TEMA OSCURO --- */
        body.dark-theme {
            background-color: #1f2937;
            color: #d1d5db;
        }
        body.dark-theme .neumorphic-card {
            background: #374151;
            box-shadow: 8px 8px 16px #111827, -8px -8px 16px #4b5563;
        }
        body.dark-theme .neumorphic-inset {
            box-shadow: inset 6px 6px 12px #111827, inset -6px -6px 12px #4b5563;
        }
        body.dark-theme h1, body.dark-theme h2, body.dark-theme h3 {
            color: #f9fafb;
        }
        body.dark-theme p {
            color: #d1d5db;
        }
        body.dark-theme header p, body.dark-theme #weather-desc, body.dark-theme .text-gray-500 {
            color: #9ca3af;
        }
        body.dark-theme .neumorphic-btn {
            background: #374151;
            box-shadow: 4px 4px 8px #111827, -4px -4px 8px #4b5563;
            color: #d1d5db;
        }
        body.dark-theme .neumorphic-btn:hover {
            box-shadow: 2px 2px 4px #111827, -2px -2px 4px #4b5563;
        }
        body.dark-theme .neumorphic-btn:active, body.dark-theme .neumorphic-btn.active {
            box-shadow: inset 4px 4px 8px #111827, inset -4px -4px 8px #4b5563;
            color: #60a5fa;
        }
        body.dark-theme .neumorphic-btn.primary { color: #60a5fa; }
        body.dark-theme .neumorphic-btn.danger { color: #f87171; }

        body.dark-theme .nav-button {
            background-image: linear-gradient(to top, #2d3748 0%, #4a5568 80%, #5a6578 100%);
            border-color: #4a5568;
            color: #e2e8f0;
            text-shadow: 0 1px #1a202c;
        }

        body.dark-theme .nav-button:hover {
            box-shadow: 0 4px 3px 1px #1a202c, 0 6px 8px #171923, 0 -4px 4px #4a5568, 0 -6px 4px #5a6578, inset 0 0 3px 3px #4a5568;
        }

        body.dark-theme .nav-button:active,
        body.dark-theme .nav-button.active {
            box-shadow: 0 4px 3px 1px #1a202c, 0 6px 8px #171923, 0 -4px 4px #4a5568, 0 -6px 4px #5a6578, inset 0 0 5px 3px #6b7280, inset 0 0 30px #718096;
        }

        body.dark-theme .nav-button:focus {
            box-shadow: 0 4px 3px 1px #1a202c, 0 6px 8px #171923, 0 -4px 4px #4a5568, 0 -6px 4px #5a6578, inset 0 0 5px 3px #6b7280, inset 0 0 30px #718096;
        }
        
        body.dark-theme .neumorphic-input {
            background: #374151;
            box-shadow: inset 4px 4px 8px #111827, inset -4px -4px 8px #4b5563;
            color: #f9fafb;
        }
        body.dark-theme select.neumorphic-input {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E");
        }
        body.dark-theme .neumorphic-input::placeholder { color: #6b7280; }

        body.dark-theme #mobile-sidenav { background-color: #374151; }

        body.dark-theme .weather-widget {
            box-shadow: none;
        }
        body.dark-theme .weather-widget .background-design {
            background-color: #3b82f6;
        }
        body.dark-theme .weather-widget .circle {
            background-color: #60a5fa;
        }

        body.dark-theme .calendar-cell { background: #374151; }
        body.dark-theme .calendar-cell.is-today { 
            box-shadow: inset 4px 4px 8px #111827, inset -4px -4px 8px #4b5563; 
            border-color: #60a5fa; 
        }
        body.dark-theme .calendar-cell.not-current-month { background: transparent; color: #6b7280; }
        body.dark-theme table thead { border-color: #4b5563; }
        body.dark-theme table tr { border-color: rgba(75, 85, 99, 0.5); }

        body.dark-theme #app-lockscreen {
            background-color: #1f2937;
        }
        body.dark-theme #lockscreen-time, body.dark-theme #lockscreen-date, body.dark-theme #app-lockscreen p {
            color: #d1d5db;
        }
        body.dark-theme #lockscreen-message { color: #f87171; }
        
        body.dark-theme #user-auth-modal .content {
            background: #374151;
            box-shadow: -3px -3px 7px #4b5563, 2px 2px 5px #111827;
        }
        body.dark-theme #user-auth-modal .text {
            color: #f9fafb;
        }
        body.dark-theme #user-auth-modal .field .input {
            background: #374151;
            color: #d1d5db;
            box-shadow: inset 2px 2px 5px #111827, inset -5px -5px 10px #4b5563;
        }
        body.dark-theme #user-auth-modal .field .input:focus {
          box-shadow: inset 1px 1px 2px #111827, inset -1px -1px 2px #4b5563;
        }
        body.dark-theme #user-auth-modal .field .span,
        body.dark-theme #user-auth-modal .field .label {
            color: #9ca3af;
        }
        body.dark-theme #user-auth-modal .forgot-pass a {
            color: #9ca3af;
        }
        body.dark-theme #user-auth-modal .button {
            background: #374151;
            color: #d1d5db;
            box-shadow: 2px 2px 5px #111827, -5px -5px 10px #4b5563;
        }
        body.dark-theme #user-auth-modal .button:focus {
            color: #60a5fa;
            box-shadow: inset 2px 2px 5px #111827, inset -5px -5px 10px #4b5563;
        }
        body.dark-theme #user-auth-modal .sign-up {
            color: #9ca3af;
        }
        body.dark-theme #user-auth-modal .auth-tabs {
            background: #374151;
            box-shadow: inset 2px 2px 5px #111827, inset -5px -5px 10px #4b5563;
        }
        body.dark-theme #user-auth-modal .auth-tab {
            color: #d1d5db;
        }
        body.dark-theme #user-auth-modal .auth-tab.active {
            color: #60a5fa;
            background: #374151;
            box-shadow: 2px 2px 5px #111827, -5px -5px 10px #4b5563;
        }
    </style>
</head>
<body class="antialiased">

    <!-- Pantalla de Bloqueo -->
    <div id="app-lockscreen" class="fixed inset-0 z-[101] flex flex-col items-center justify-center transition-opacity duration-500 ease-in-out">
        <div class="text-center">
            <p id="lockscreen-time" class="text-6xl sm:text-7xl font-bold text-gray-700"></p>
            <p id="lockscreen-date" class="text-lg sm:text-xl text-gray-500"></p>
        </div>

        <div class="mt-16 text-center">
            <label for="unlock-switch" class="unlock-switch-label">
                <input type="checkbox" id="unlock-switch" class="hidden" disabled>
                <div class="unlock-switch-track neumorphic-inset">
                    <div class="unlock-switch-thumb neumorphic-card"></div>
                </div>
            </label>
            <p class="mt-6 text-gray-500 font-medium">Desliza para desbloquear</p>
            <p id="lockscreen-message" class="text-red-500 text-sm mt-2 hidden">Debes iniciar sesión para desbloquear.</p>
        </div>

        <div class="mt-8">
            <button data-modal-target="user-auth-modal" class="neumorphic-btn primary">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>
                <span>Registrarse o Iniciar Sesión</span>
            </button>
        </div>
    </div>

    <!-- Menú Móvil -->
    <div id="mobile-nav-wrapper" class="md:hidden">
        <div id="mobile-sidenav-overlay"></div>
        <div id="mobile-sidenav">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-xl font-bold text-gray-700">Menú</h2>
                <button data-action="close-sidenav" class="neumorphic-btn p-2"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button>
            </div>
            <nav id="mobile-nav-links" class="flex flex-col gap-3"></nav>
        </div>
        <div id="edge-handle"></div>
    </div>

    <div id="app-loading">Cargando Portal...</div>

    <div id="app-container" class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="flex flex-col sm:flex-row justify-between sm:items-center mb-8 gap-4">
            <div class="text-center sm:text-left">
                <h1 class="text-3xl sm:text-4xl font-bold text-gray-700">Comunidad de Gracia</h1>
                <p class="text-gray-500 mt-2">Mi espacio Digital</p>
            </div>
             <div class="flex items-center justify-center sm:justify-end shrink-0 gap-4">
                 <label class="theme-switch">
                  <input type="checkbox" id="theme-switch-checkbox" class="theme-switch__checkbox">
                  <div class="theme-switch__container">
                    <div class="theme-switch__clouds"></div>
                    <div class="theme-switch__stars-container">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 144 55" fill="none">
                        <path fill-rule="evenodd" clip-rule="evenodd" d="M135.831 3.00688C135.055 3.85027 134.111 4.29946 133 4.35447C134.111 4.40947 135.055 4.85867 135.831 5.71123C136.607 6.55462 136.996 7.56303 136.996 8.72727C136.996 7.95722 137.172 7.25134 137.525 6.59129C137.886 5.93124 138.372 5.39954 138.98 5.00535C139.598 4.60199 140.268 4.39114 141 4.35447C139.88 4.2903 138.936 3.85027 138.16 3.00688C137.384 2.16348 136.996 1.16425 136.996 0C136.996 1.16425 136.607 2.16348 135.831 3.00688ZM31 23.3545C32.1114 23.2995 33.0551 22.8503 33.8313 22.0069C34.6075 21.1635 34.9956 20.1642 34.9956 19C34.9956 20.1642 35.3837 21.1635 36.1599 22.0069C36.9361 22.8503 37.8798 23.2903 39 23.3545C38.2679 23.3911 37.5976 23.602 36.9802 24.0053C36.3716 24.3995 35.8864 24.9312 35.5248 25.5913C35.172 26.2513 34.9956 26.9572 34.9956 27.7273C34.9956 26.563 34.6075 25.5546 33.8313 24.7112C33.0551 23.8587 32.1114 23.4095 31 23.3545ZM0 36.3545C1.11136 36.2995 2.05513 35.8503 2.83131 35.0069C3.6075 34.1635 3.99559 33.1642 3.99559 32C3.99559 33.1642 4.38368 34.1635 5.15987 35.0069C5.93605 35.8503 6.87982 36.2903 8 36.3545C7.26792 36.3911 6.59757 36.602 5.98015 37.0053C5.37155 37.3995 4.88644 37.9312 4.52481 38.5913C4.172 39.2513 3.99559 39.9572 3.99559 40.7273C3.99559 39.563 3.6075 38.5546 2.83131 37.7112C2.05513 36.8587 1.11136 36.4095 0 36.3545ZM56.8313 24.0069C56.0551 24.8503 55.1114 25.2995 54 25.3545C55.1114 25.4095 56.0551 25.8587 56.8313 26.7112C57.6075 27.5546 57.9956 28.563 57.9956 29.7273C57.9956 28.9572 58.172 28.2513 58.5248 27.5913C58.8864 26.9312 59.3716 26.3995 59.9802 26.0053C60.5976 25.602 61.2679 25.3911 62 25.3545C60.8798 25.2903 59.9361 24.8503 59.1599 24.0069C58.3837 23.1635 57.9956 22.1642 57.9956 21C57.9956 22.1642 57.6075 23.1635 56.8313 24.0069ZM81 25.3545C82.1114 25.2995 83.0551 24.8503 83.8313 24.0069C84.6075 23.1635 84.9956 22.1642 84.9956 21C84.9956 22.1642 85.3837 23.1635 86.1599 24.0069C86.9361 24.8503 87.8798 25.2903 89 25.3545C88.2679 25.3911 87.5976 25.602 86.9802 26.0053C86.3716 26.3995 85.8864 26.9312 85.5248 27.5913C85.172 28.2513 84.9956 28.9572 84.9956 29.7273C84.9956 28.563 84.6075 27.5546 83.8313 26.7112C83.0551 25.8587 82.1114 25.4095 81 25.3545ZM136 36.3545C137.111 36.2995 138.055 35.8503 138.831 35.0069C139.607 34.1635 139.996 33.1642 139.996 32C139.996 33.1642 140.384 34.1635 141.16 35.0069C141.936 35.8503 142.88 36.2903 144 36.3545C143.268 36.3911 142.598 36.602 141.98 37.0053C141.372 37.3995 140.886 37.9312 140.525 38.5913C140.172 39.2513 139.996 39.9572 139.996 40.7273C139.996 39.563 139.607 38.5546 138.831 37.7112C138.055 36.8587 137.111 36.4095 136 36.3545ZM101.831 49.0069C101.055 49.8503 100.111 50.2995 99 50.3545C100.111 50.4095 101.055 50.8587 101.831 51.7112C102.607 52.5546 102.996 53.563 102.996 54.7273C102.9956 53.9572 103.172 53.2513 103.525 52.5913C103.886 51.9312 104.372 51.3995 104.98 51.0053C105.598 50.602 106.268 50.3911 107 50.3545C105.88 50.2903 104.936 49.8503 104.16 49.0069C103.384 48.1635 102.996 47.1642 102.996 46C102.996 47.1642 102.607 48.1635 101.831 49.0069Z" fill="currentColor"></path>
                      </svg>
                    </div>
                    <div class="theme-switch__circle-container">
                      <div class="theme-switch__sun-moon-container">
                        <div class="theme-switch__moon">
                          <div class="theme-switch__spot"></div>
                          <div class="theme-switch__spot"></div>
                          <div class="theme-switch__spot"></div>
                        </div>
                      </div>
                    </div>
                  </div>
                </label>
                <div id="admin-controls-container"></div>
            </div>
        </header>

        <!-- Navegación Principal (Desktop) -->
        <nav class="mb-8 hidden md:block">
            <div id="tabs-container" class="flex flex-wrap justify-center items-center gap-4">
                <button class="nav-button active" data-target="page-tablero">Tablero</button>
                <button class="nav-button" data-target="page-agenda">Eventos</button>
                <button class="nav-button" data-target="page-directorio">Directorio</button>
                <button class="nav-button" data-target="page-noticias">Noticias</button>
                <button class="nav-button" data-target="page-manuales">Manuales</button>
                <button class="nav-button" data-target="page-recursos">Recursos</button>
                <button class="nav-button" data-target="page-calendario">Calendario</button>
                <button class="nav-button super-admin-only" data-target="page-user-management">Usuarios</button>
            </div>
        </nav>

        <main>
            <div id="pages-container">
                <!-- Páginas de Contenido -->
                <div id="page-tablero" class="page active">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- Tarjeta de Hoy (Clima y Hora) -->
                        <div class="md:col-span-1">
                            <div class="weather-widget">
                                <section class="info-section">
                                    <div class="background-design">
                                        <div class="circle"></div>
                                        <div class="circle"></div>
                                        <div class="circle"></div>
                                    </div>
                                    <div class="left-side">
                                        <div class="weather">
                                            <div>
                                                <svg id="weather-icon-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="#ffffff"><g stroke-width="0"></g><g stroke-linecap="round" stroke-linejoin="round"></g><g><path d="M12 4.5V9.5M12 14.5V19.5M19.5 12H14.5M9.5 12H4.5M17.6066 6.3934L15.5 8.5M8.5 15.5L6.3934 17.6066M17.6066 17.6066L15.5 15.5M8.5 8.5L6.3934 6.3934" stroke="#ffffff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></g></svg>
                                            </div>
                                            <div id="weather-desc">Cargando...</div>
                                        </div>
                                        <div id="weather-temp" class="temperature">--°</div>
                                    </div>
                                    <div class="right-side">
                                        <div>
                                            <div id="current-time" class="hour">--:--</div>
                                            <div id="current-date" class="date">-- --/--</div>
                                        </div>
                                        <div id="weather-location" class="city">Cargando...</div>
                                    </div>
                                </section>
                            </div>
                        </div>
                        <div class="md:col-span-2 space-y-6">
                            <div id="birthday-card" class="neumorphic-card p-6" style="display: none;">
                                <h2 class="text-xl font-bold mb-4">Cumpleaños de Hoy</h2>
                                <ul id="birthday-list" class="space-y-3"></ul>
                            </div>
                            <div class="neumorphic-card p-6">
                                <h2 class="text-xl font-bold mb-4">Próximos Eventos</h2>
                                <ul id="upcoming-events-list" class="space-y-3"><li class="text-gray-500">Cargando eventos...</li></ul>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="page-agenda" class="page">
                    <div class="neumorphic-card p-6">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                            <h2 class="text-2xl font-bold">Eventos</h2>
                            <button data-modal-target="event-modal" data-permission="agenda" class="neumorphic-btn primary w-full sm:w-auto admin-only"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" /></svg><span>Agregar Evento</span></button>
                        </div>
                        <div class="overflow-x-auto"><table class="w-full text-left"><thead class="border-b border-gray-300"><tr><th class="p-3 font-semibold">Fecha</th><th class="p-3 font-semibold hidden sm:table-cell">Hora</th><th class="p-3 font-semibold">Nombre del Evento</th><th class="p-3 font-semibold admin-only-table-cell" data-permission="agenda">Acciones</th></tr></thead><tbody id="agenda-table-body"></tbody></table></div>
                    </div>
                </div>
                <div id="page-directorio" class="page">
                    <div class="neumorphic-card p-6">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                            <h2 class="text-2xl font-bold">Directorio</h2>
                            <button data-modal-target="parroquiano-modal" data-permission="directorio" class="neumorphic-btn primary w-full sm:w-auto admin-only"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path d="M11 5a3 3 0 11-6 0 3 3 0 016 0zM12.73 10.21a5.002 5.002 0 016.536 6.536l.243.243a1 1 0 11-1.414 1.414l-.243-.243a5.002 5.002 0 01-7.95-7.95l-1.01-1.01A5.002 5.002 0 012.27 12.27l-1.01 1.01a1 1 0 11-1.414-1.414l1.01-1.01a5.002 5.002 0 017.95 7.95l.243.243a1 1 0 011.414 1.414l-.243-.243a5.002 5.002 0 01-6.536-6.536l1.01 1.01z" /></svg><span>Agregar Parroquiano</span></button>
                        </div>
                        <div class="overflow-x-auto"><table class="w-full text-left"><thead class="border-b border-gray-300"><tr><th class="p-3 font-semibold">Nombre</th><th class="p-3 font-semibold hidden md:table-cell">Teléfono</th><th class="p-3 font-semibold hidden lg:table-cell">Contacto Emergencia</th><th class="p-3 font-semibold admin-only-table-cell" data-permission="directorio">Acciones</th></tr></thead><tbody id="directorio-table-body"></tbody></table></div>
                    </div>
                </div>
                <div id="page-noticias" class="page">
                    <div class="neumorphic-card p-6">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                            <h2 class="text-2xl font-bold">Noticias Parroquiales</h2>
                            <button data-modal-target="news-modal" data-permission="noticias" class="neumorphic-btn primary w-full sm:w-auto admin-only"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" /></svg><span>Agregar Noticia</span></button>
                        </div>
                        <div id="news-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                    </div>
                </div>
                <div id="page-manuales" class="page">
                    <div class="neumorphic-card p-6">
                         <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                            <h2 class="text-2xl font-bold">Manuales y Guías</h2>
                            <button data-modal-target="bloque-manual-modal" data-permission="manuales" class="neumorphic-btn primary w-full sm:w-auto admin-only"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" /></svg><span>Agregar Bloque</span></button>
                        </div>
                        <div id="manuales-container" class="space-y-4"></div>
                    </div>
                </div>
                <div id="page-recursos" class="page">
                    <div class="neumorphic-card p-6">
                         <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                            <h2 class="text-2xl font-bold">Recursos y Documentos</h2>
                            <button data-modal-target="bloque-archivo-modal" data-permission="recursos" class="neumorphic-btn primary w-full sm:w-auto admin-only"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" /></svg><span>Agregar Bloque</span></button>
                        </div>
                        <div id="archivos-container" class="space-y-4"></div>
                    </div>
                </div>
                <div id="page-calendario" class="page">
                    <div class="neumorphic-card p-6">
                        <div id="calendar-header" class="flex justify-between items-center mb-6">
                            <button id="prev-month-btn" class="neumorphic-btn p-2 sm:p-auto"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" /></svg></button>
                            <h2 id="month-year-header" class="text-xl sm:text-2xl font-bold text-center"></h2>
                            <button id="next-month-btn" class="neumorphic-btn p-2 sm:p-auto"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" /></svg></button>
                        </div>
                        <div class="grid grid-cols-7 gap-1 sm:gap-2 text-center font-semibold mb-2 text-gray-600 text-sm sm:text-base"><div>Do</div><div>Lu</div><div>Ma</div><div>Mi</div><div>Ju</div><div>Vi</div><div>Sá</div></div>
                        <div id="calendar-grid" class="grid grid-cols-7 gap-1 sm:gap-2"></div>
                    </div>
                </div>
                <div id="page-user-management" class="page">
                    <div class="neumorphic-card p-6">
                        <h2 class="text-2xl font-bold mb-6">Gestión de Usuarios</h2>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead class="border-b border-gray-300">
                                    <tr>
                                        <th class="p-3 font-semibold">Nombre</th>
                                        <th class="p-3 font-semibold">Correo</th>
                                        <th class="p-3 font-semibold">Rol</th>
                                        <th class="p-3 font-semibold">Permisos</th>
                                        <th class="p-3 font-semibold">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="user-management-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        <footer class="mt-8 pt-8">
            <div class="flex justify-center">
                <div class="card">
                  <ul>
                    <li class="iso-pro">
                      <span></span>
                      <span></span>
                      <span></span>
                      <a href="https://www.facebook.com/profile.php?id=100090817543616" target="_blank" rel="noopener noreferrer">
                        <svg
                          viewBox="0 0 320 512"
                          xmlns="http://www.w3.org/2000/svg"
                          class="svg"
                        >
                          <path
                            d="M279.14 288l14.22-92.66h-88.91v-60.13c0-25.35 12.42-50.06 52.24-50.06h40.42V6.26S260.43 0 225.36 0c-73.22 0-121.08 44.38-121.08 124.72v70.62H22.89V288h81.39v224h100.17V288z"
                          ></path></svg
                      ></a>
                      <div class="text">Facebook</div>
                    </li>
                    <li class="iso-pro">
                      <span></span>
                      <span></span>
                      <span></span>
                      <a href="https://x.com/acna_xalapa" target="_blank" rel="noopener noreferrer">
                        <svg
                          class="svg"
                          xmlns="http://www.w3.org/2000/svg"
                          viewBox="0 0 512 512"
                        >
                          <path
                            d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"
                          ></path>
                        </svg>
                      </a>
                      <div class="text">Twitter</div>
                    </li>
                    <li class="iso-pro">
                      <span></span>
                      <span></span>
                      <span></span>
                      <a href="https://www.instagram.com/acna_xalapa/" target="_blank" rel="noopener noreferrer">
                        <svg
                          class="svg"
                          xmlns="http://www.w3.org/2000/svg"
                          viewBox="0 0 448 512"
                        >
                          <path
                            d="M224.1 141c-63.6 0-114.9 51.3-114.9 114.9s51.3 114.9 114.9 114.9S339 319.5 339 255.9 287.7 141 224.1 141zm0 189.6c-41.1 0-74.7-33.5-74.7-74.7s33.5-74.7 74.7-74.7 74.7 33.5 74.7 74.7-33.6 74.7-74.7 74.7zm146.4-194.3c0 14.9-12 26.8-26.8 26.8-14.9 0-26.8-12-26.8-26.8s12-26.8 26.8-26.8 26.8 12 26.8 26.8zm76.1 27.2c-1.7-35.9-9.9-67.7-36.2-93.9-26.2-26.2-58-34.4-93.9-36.2-37-2.1-147.9-2.1-184.9 0-35.8 1.7-67.6 9.9-93.9 36.1s-34.4 58-36.2 93.9c-2.1 37-2.1 147.9 0 184.9 1.7 35.9 9.9 67.7 36.2 93.9s58 34.4 93.9 36.2c37 2.1 147.9 2.1 184.9 0 35.9-1.7 67.7-9.9 93.9-36.2 26.2-26.2 34.4-58 36.2-93.9 2.1-37 2.1-147.8 0-184.8zM398.8 388c-7.8 19.6-22.9 34.7-42.6 42.6-29.5 11.7-99.5 9-132.1 9s-102.7 2.6-132.1-9c-19.6-7.8-34.7-22.9-42.6-42.6-11.7-29.5-9-99.5-9-132.1s-2.6-102.7 9-132.1c7.8-19.6 22.9-34.7 42.6-42.6 29.5-11.7 99.5-9 132.1-9s102.7-2.6 132.1 9c19.6 7.8 34.7 22.9 42.6 42.6 11.7 29.5 9 99.5 9 132.1s2.7 102.7-9 132.1z"
                          ></path>
                        </svg>
                      </a>
                      <div class="text">Instagram</div>
                    </li>
                  </ul>
                </div>
            </div>
        </footer>
    </div>

    <!-- Modales -->
     <div id="user-auth-modal" class="fixed inset-0 bg-gray-900 bg-opacity-25 backdrop-blur-sm flex items-center justify-center hidden z-[110] p-4">
        <div class="content relative">
             <button data-action="close-modal" class="absolute -top-6 -right-3 text-white hover:text-gray-300">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            
            <div class="auth-tabs">
                <button id="show-login-btn" class="auth-tab active">Iniciar Sesión</button>
                <button id="show-register-btn" class="auth-tab">Registrarse</button>
            </div>

            <!-- Vista de Login -->
            <div id="login-view">
                <form id="login-form" action="#" class="mt-8">
                    <div class="field">
                       <input required type="email" id="login-email" class="input" autocomplete="email">
                       <span class="span"><svg class="" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" y="0" x="0" height="20" width="50" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" xmlns="http://www.w3.org/2000/svg"><g><path class="" data-original="#000000" fill="#595959" d="m467 61h-422c-24.813 0-45 20.187-45 45v300c0 24.813 20.187 45 45 45h422c24.813 0 45-20.187 45-45v-300c0-24.813-20.187-45-45-45zm-21.086 42.229 18.172 15.143-207.086 172.583-207.086-172.583 18.172-15.143 188.914 157.417zm-403.914 329.771v-274.526l183.58 152.958c2.582 2.152 5.53 3.229 8.48 3.229s5.898-1.077 8.48-3.229l183.58-152.958v274.526z"></path></g></svg></span>
                       <label class="label">Correo Electrónico</label>
                    </div>
                    <div class="field">
                       <input required type="password" id="login-password" class="input" autocomplete="current-password">
                       <span class="span"><svg class="" xml:space="preserve" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" y="0" x="0" height="20" width="50" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" xmlns="http://www.w3.org/2000/svg"><g><path class="" data-original="#000000" fill="#595959" d="M336 192h-16v-64C320 57.406 262.594 0 192 0S64 57.406 64 128v64H48c-26.453 0-48 21.523-48 48v224c0 26.477 21.547 48 48 48h288c26.453 0 48-21.523 48-48V240c0-26.477-21.547-48-48-48zm-229.332-64c0-47.063 38.27-85.332 85.332-85.332s85.332 38.27 85.332 85.332v64H106.668zm0 0"></path></g></svg></span>
                       <label class="label">Contraseña</label>
                    </div>
                    <p id="login-error-msg" class="text-red-500 text-sm my-4 text-center hidden">Credenciales incorrectas.</p>
                    <button class="button" type="submit">Ingresar</button>
                </form>
            </div>
            <!-- Vista de Registro -->
            <div id="register-view" class="hidden">
                <form id="register-form" action="#" class="mt-8">
                    <div class="field">
                       <input required type="text" id="register-name" class="input" autocomplete="name">
                       <span class="span"><svg class="" xml:space="preserve" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" y="0" x="0" height="20" width="50" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" xmlns="http://www.w3.org/2000/svg"><g><path class="" data-original="#000000" fill="#595959" d="M256 0c-74.439 0-135 60.561-135 135s60.561 135 135 135 135-60.561 135-135S330.439 0 256 0zM423.966 358.195C387.006 320.667 338.009 300 286 300h-60c-52.008 0-101.006 20.667-137.966 58.195C51.255 395.539 31 444.833 31 497c0 8.284 6.716 15 15 15h420c8.284 0 15-6.716 15-15 0-52.167-20.255-101.461-57.034-138.805z"></path></g></svg></span>
                       <label class="label">Nombre Completo</label>
                    </div>
                    <div class="field">
                       <input required type="email" id="register-email" class="input" autocomplete="email">
                       <span class="span"><svg class="" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" y="0" x="0" height="20" width="50" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" xmlns="http://www.w3.org/2000/svg"><g><path class="" data-original="#000000" fill="#595959" d="m467 61h-422c-24.813 0-45 20.187-45 45v300c0 24.813 20.187 45 45 45h422c24.813 0 45-20.187 45-45v-300c0-24.813-20.187-45-45-45zm-21.086 42.229 18.172 15.143-207.086 172.583-207.086-172.583 18.172-15.143 188.914 157.417zm-403.914 329.771v-274.526l183.58 152.958c2.582 2.152 5.53 3.229 8.48 3.229s5.898-1.077 8.48-3.229l183.58-152.958v274.526z"></path></g></svg></span>
                       <label class="label">Correo</label>
                    </div>
                    <div class="field">
                       <input required type="password" id="register-password" class="input" autocomplete="new-password">
                       <span class="span"><svg class="" xml:space="preserve" style="enable-background:new 0 0 512 512" viewBox="0 0 512 512" y="0" x="0" height="20" width="50" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" xmlns="http://www.w3.org/2000/svg"><g><path class="" data-original="#000000" fill="#595959" d="M336 192h-16v-64C320 57.406 262.594 0 192 0S64 57.406 64 128v64H48c-26.453 0-48 21.523-48 48v224c0 26.477 21.547 48 48 48h288c26.453 0 48-21.523 48-48V240c0-26.477-21.547-48-48-48zm-229.332-64c0-47.063 38.27-85.332 85.332-85.332s85.332 38.27 85.332 85.332v64H106.668zm0 0"></path></g></svg></span>
                       <label class="label">Contraseña</label>
                    </div>
                    <p id="register-error-msg" class="text-red-500 text-sm my-4 text-center hidden"></p>
                    <button class="button" type="submit">Crear Cuenta</button>
                </form>
            </div>
        </div>
    </div>
    
    <div id="event-modal" class="fixed inset-0 bg-gray-900 bg-opacity-25 flex items-center justify-center hidden z-50 p-4">
        <div class="neumorphic-card p-8 w-full max-w-md">
            <h2 class="text-2xl font-bold mb-6"></h2>
            <form id="event-form" data-type="event">
                <input type="hidden" name="id">
                <div class="mb-4"><label for="event-name" class="block text-sm font-medium mb-1">Nombre del Evento</label><input type="text" id="event-name" name="name" class="neumorphic-input" required></div>
                <div class="mb-4"><label for="event-date" class="block text-sm font-medium mb-1">Fecha</label><input type="date" id="event-date" name="date" class="neumorphic-input" required></div>
                <div class="mb-4"><label for="event-time" class="block text-sm font-medium mb-1">Hora</label><input type="time" id="event-time" name="time" class="neumorphic-input" required></div>
                <div class="mb-6">
                    <label for="event-imageUrl" class="block text-sm font-medium mb-1">URL de la Imagen (Opcional)</label>
                    <input type="url" id="event-imageUrl" name="imageUrl" class="neumorphic-input" placeholder="https://ejemplo.com/imagen.jpg">
                </div>
                <div class="flex justify-end gap-4"><button type="button" data-action="close-modal" class="neumorphic-btn">Cancelar</button><button type="submit" class="neumorphic-btn primary">Guardar</button></div>
            </form>
        </div>
    </div>
    <div id="parroquiano-modal" class="fixed inset-0 bg-gray-900 bg-opacity-25 flex items-center justify-center hidden z-50 p-4">
        <div class="neumorphic-card p-8 w-full max-w-lg">
            <h2 class="text-2xl font-bold mb-6"></h2>
            <form id="parroquiano-form" data-type="parroquiano" class="space-y-4">
                <input type="hidden" name="id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="parroquiano-nombre" class="block text-sm font-medium mb-1">Nombre Completo</label>
                        <input type="text" id="parroquiano-nombre" name="nombre" class="neumorphic-input" required>
                    </div>
                    <div>
                        <label for="parroquiano-nacimiento" class="block text-sm font-medium mb-1">Fecha de Nacimiento</label>
                        <input type="date" id="parroquiano-nacimiento" name="nacimiento" class="neumorphic-input">
                    </div>
                    <div>
                        <label for="parroquiano-telefono" class="block text-sm font-medium mb-1">Teléfono</label>
                        <input type="tel" id="parroquiano-telefono" name="telefono" class="neumorphic-input">
                    </div>
                    <div>
                        <label for="parroquiano-email" class="block text-sm font-medium mb-1">Correo Electrónico</label>
                        <input type="email" id="parroquiano-email" name="email" class="neumorphic-input">
                    </div>
                    <div class="md:col-span-2">
                        <label for="parroquiano-direccion" class="block text-sm font-medium mb-1">Dirección</label>
                        <textarea id="parroquiano-direccion" name="direccion" rows="2" class="neumorphic-input"></textarea>
                    </div>
                </div>
                <div class="pt-4 mt-4 border-t border-gray-300 dark:border-gray-600">
                     <h3 class="text-lg font-semibold mb-2">Contacto de Emergencia</h3>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="parroquiano-emergencia-nombre" class="block text-sm font-medium mb-1">Nombre del Contacto</label>
                            <input type="text" id="parroquiano-emergencia-nombre" name="emergencia_nombre" class="neumorphic-input">
                        </div>
                        <div>
                            <label for="parroquiano-emergencia-telefono" class="block text-sm font-medium mb-1">Teléfono del Contacto</label>
                            <input type="tel" id="parroquiano-emergencia-telefono" name="emergencia_telefono" class="neumorphic-input">
                        </div>
                    </div>
                </div>
                <div class="flex justify-end gap-4 pt-4">
                    <button type="button" data-action="close-modal" class="neumorphic-btn">Cancelar</button>
                    <button type="submit" class="neumorphic-btn primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>
    <div id="manual-modal" class="fixed inset-0 bg-gray-900 bg-opacity-25 flex items-center justify-center hidden z-50 p-4">
        <div class="neumorphic-card p-8 w-full max-w-md">
            <h2 class="text-2xl font-bold mb-6"></h2>
            <form id="manual-form" data-type="manual">
                <input type="hidden" name="id">
                <input type="hidden" name="blockId">
                <div class="mb-4"><label for="manual-nombre" class="block text-sm font-medium mb-1">Nombre del Manual</label><input type="text" id="manual-nombre" name="nombre" class="neumorphic-input" required></div>
                <div class="mb-6"><label for="manual-url" class="block text-sm font-medium mb-1">URL del Manual</label><input type="url" id="manual-url" name="url" class="neumorphic-input" placeholder="https://ejemplo.com/documento.pdf" required></div>
                <div class="flex justify-end gap-4"><button type="button" data-action="close-modal" class="neumorphic-btn">Cancelar</button><button type="submit" class="neumorphic-btn primary">Guardar</button></div>
            </form>
        </div>
    </div>
    <div id="archivo-modal" class="fixed inset-0 bg-gray-900 bg-opacity-25 flex items-center justify-center hidden z-50 p-4">
        <div class="neumorphic-card p-8 w-full max-w-md">
            <h2 class="text-2xl font-bold mb-6"></h2>
            <form id="archivo-form" data-type="archivo">
                <input type="hidden" name="id">
                <input type="hidden" name="blockId">
                <div class="mb-4"><label for="archivo-nombre" class="block text-sm font-medium mb-1">Nombre del Archivo</label><input type="text" id="archivo-nombre" name="nombre" class="neumorphic-input" required></div>
                <div class="mb-6"><label for="archivo-url" class="block text-sm font-medium mb-1">URL del Archivo</label><input type="url" id="archivo-url" name="url" class="neumorphic-input" placeholder="https://ejemplo.com/recurso.zip" required></div>
                <div class="flex justify-end gap-4"><button type="button" data-action="close-modal" class="neumorphic-btn">Cancelar</button><button type="submit" class="neumorphic-btn primary">Guardar</button></div>
            </form>
        </div>
    </div>
    <div id="confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-25 flex items-center justify-center hidden z-50 p-4">
        <div class="neumorphic-card p-8 w-full max-w-sm">
            <h2 class="text-xl font-bold mb-4">Confirmar Eliminación</h2>
            <p id="confirm-message" class="mb-6">¿Estás seguro?</p>
            <div class="flex justify-end gap-4"><button type="button" data-action="close-modal" class="neumorphic-btn">Cancelar</button><button type="button" id="confirm-delete-btn" class="neumorphic-btn danger">Eliminar</button></div>
        </div>
    </div>
    <div id="calendar-day-modal" class="fixed inset-0 bg-gray-900 bg-opacity-25 flex items-center justify-center hidden z-50 p-4">
        <div class="neumorphic-card p-8 w-full max-w-md">
            <h2 id="calendar-day-modal-title" class="text-xl font-bold mb-6"></h2>
            <div class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                <div>
                    <h3 class="font-semibold mb-2">Eventos Programados</h3>
                    <ul id="calendar-day-events-list" class="space-y-2"></ul>
                </div>
                <div id="calendar-day-birthdays-section" class="hidden">
                    <h3 class="font-semibold mb-2">Agenda Parroquial (Cumpleaños)</h3>
                    <ul id="calendar-day-birthdays-list" class="space-y-2"></ul>
                </div>
            </div>
            <div class="flex justify-end gap-4 mt-6">
                <button type="button" data-action="close-modal" class="neumorphic-btn">Cerrar</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, setDoc, getDoc, updateDoc, deleteDoc, getDocs, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =================================================================================
        // CONFIGURACIÓN CENTRALIZADA
        // Almacena todas las configuraciones y constantes en un solo lugar para fácil acceso y modificación.
        // =================================================================================
        const Config = {
            firebase: {
                apiKey: "AIzaSyATCd0jgG2Lo5q8K5bB15eNvkakJBb15RU", authDomain: "ibcgapp.firebaseapp.com",
                projectId: "ibcgapp", storageBucket: "ibcgapp.appspot.com",
                messagingSenderId: "548258029551", appId: "1:548258029551:web:9354e4cc79ce4f25f0201a",
                measurementId: "G-RBN8KZPJ5X"
            },
            weather: {
                apiKey: '9a11de307931b3ba88e6af9048b7f3b1',
                lat: 19.5437,
                lon: -96.91
            },
            paths: {
                base: `artifacts/ibcgapp`,
                collections: {
                    users: `public/data/users`, events: `public/data/events`, 
                    parroquianos: `public/data/parroquianos`, news: `public/data/news`, 
                    manuales: `public/data/manuales`, archivos: `public/data/archivos`
                }
            }
        };

        // =================================================================================
        // SERVICIOS EXTERNOS (Firebase, Clima)
        // Módulos que abstraen la comunicación con APIs externas. No conocen el DOM.
        // =================================================================================
        const FirebaseService = {
            db: null, auth: null,
            /**
             * Inicializa los servicios de Firebase y establece el listener de autenticación.
             * @param {function} onAuthChangeCallback - Función a ejecutar cuando cambia el estado de autenticación.
             */
            init(onAuthChangeCallback) {
                const app = initializeApp(Config.firebase);
                this.db = getFirestore(app);
                this.auth = getAuth(app);
                onAuthStateChanged(this.auth, onAuthChangeCallback);
            },
            /**
             * Obtiene la ruta completa de una colección en Firestore.
             * @param {string} type - El nombre de la colección (ej. 'users', 'events').
             * @returns {string} La ruta completa de la colección.
             */
            _getCollectionPath(type) {
                const collectionPath = Config.paths.collections[type];
                if (!collectionPath) throw new Error(`Collection type "${type}" no definida.`);
                return `${Config.paths.base}/${collectionPath}`;
            },
            /**
             * Escucha cambios en una colección en tiempo real.
             * @param {string} type - El nombre de la colección.
             * @param {function} callback - Función que se ejecuta con los datos actualizados.
             * @returns {function} Una función para cancelar la suscripción (unsubscribe).
             */
            onCollectionSnapshot(type, callback) {
                const path = this._getCollectionPath(type);
                return onSnapshot(collection(this.db, path), (snapshot) => {
                    callback(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                }, (error) => console.error(`Error en listener de ${type}: `, error));
            },
            /**
             * Guarda (crea o actualiza) un documento en una colección.
             * @param {string} type - El nombre de la colección.
             * @param {string|null} id - El ID del documento a actualizar, o null para crear uno nuevo.
             * @param {object} data - Los datos a guardar.
             * @returns {Promise<void|import("firebase/firestore").DocumentReference>}
             */
            async saveDoc(type, id, data) {
                const collectionPath = this._getCollectionPath(type);
                if (id) {
                    await updateDoc(doc(this.db, collectionPath, id), data);
                } else {
                    if (type === 'news' && !data.fechaPublicacion) {
                        data.fechaPublicacion = new Date().toISOString();
                    }
                    return await addDoc(collection(this.db, collectionPath), data);
                }
            },
            /**
             * Establece (sobrescribe) un documento con un ID específico.
             * @param {string} type - El nombre de la colección.
             * @param {string} id - El ID del documento.
             * @param {object} data - Los datos a establecer.
             */
            async setDoc(type, id, data) {
                await setDoc(doc(this.db, this._getCollectionPath(type), id), data);
            },
            /**
             * Obtiene un único documento por su ID.
             * @param {string} type - El nombre de la colección.
             * @param {string} id - El ID del documento.
             * @returns {Promise<import("firebase/firestore").DocumentSnapshot>}
             */
             async getDoc(type, id) {
                return await getDoc(doc(this.db, this._getCollectionPath(type), id));
            },
            /**
             * Elimina un documento por su ID.
             * @param {string} type - El nombre de la colección.
             * @param {string} id - El ID del documento a eliminar.
             */
            async deleteDoc(type, id) {
                await deleteDoc(doc(this.db, this._getCollectionPath(type), id));
            }
        };

        const WeatherService = {
            /**
             * Obtiene los datos del clima desde la API de OpenWeatherMap.
             * @returns {Promise<{temp: number, description: string, location: string}>}
             */
            async fetch() {
                const { lat, lon, apiKey } = Config.weather;
                const url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${apiKey}&units=metric&lang=es`;
                try {
                    const response = await fetch(url);
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.message || 'Respuesta inválida de la API');
                    return { temp: data.main.temp, description: data.weather[0].description, location: data.name };
                } catch (error) {
                    console.error("Error al obtener el clima:", error);
                    return { description: 'Error de red', location: '' };
                }
            }
        };
        
        // =================================================================================
        // MÓDULO DE UI (Interfaz de Usuario)
        // Responsable de TODA la manipulación del DOM. No contiene lógica de negocio.
        // Organizado por componentes para mayor claridad.
        // =================================================================================
        const UI = {
            elements: {}, // Se llenará en init()
            /**
             * Inicializa el módulo UI, cacheando todos los elementos del DOM.
             */
            init() {
                this.elements = {
                    appLoading: document.getElementById('app-loading'),
                    appContainer: document.getElementById('app-container'),
                    lockscreen: {
                        container: document.getElementById('app-lockscreen'),
                        time: document.getElementById('lockscreen-time'),
                        date: document.getElementById('lockscreen-date'),
                        message: document.getElementById('lockscreen-message'),
                        unlockSwitch: document.getElementById('unlock-switch'),
                        unlockSwitchLabel: document.querySelector('.unlock-switch-label'),
                    },
                    header: {
                        adminControlsContainer: document.getElementById('admin-controls-container'),
                        themeSwitch: document.getElementById('theme-switch-checkbox'),
                    },
                    nav: {
                        tabsContainer: document.getElementById('tabs-container'),
                        pagesContainer: document.getElementById('pages-container'),
                        edgeHandle: document.getElementById('edge-handle'),
                        mobileSidenav: document.getElementById('mobile-sidenav'),
                        mobileSidenavOverlay: document.getElementById('mobile-sidenav-overlay'),
                        mobileNavLinks: document.getElementById('mobile-nav-links'),
                    },
                    pages: {
                        tablero: {
                            currentDate: document.getElementById('current-date'),
                            currentTime: document.getElementById('current-time'),
                            weatherTemp: document.getElementById('weather-temp'),
                            weatherDesc: document.getElementById('weather-desc'),
                            weatherLocation: document.getElementById('weather-location'),
                            upcomingEventsList: document.getElementById('upcoming-events-list'),
                            birthdayCard: document.getElementById('birthday-card'),
                            birthdayList: document.getElementById('birthday-list'),
                        },
                        agenda: { tableBody: document.getElementById('agenda-table-body') },
                        directorio: { tableBody: document.getElementById('directorio-table-body') },
                        noticias: { grid: document.getElementById('news-grid') },
                        manuales: { container: document.getElementById('manuales-container') },
                        recursos: { container: document.getElementById('archivos-container') },
                        calendario: {
                            header: document.getElementById('month-year-header'),
                            grid: document.getElementById('calendar-grid'),
                        },
                        userManagement: { tableBody: document.getElementById('user-management-table-body') }
                    },
                    modals: {
                        userAuth: document.getElementById('user-auth-modal'),
                        event: document.getElementById('event-modal'),
                        parroquiano: document.getElementById('parroquiano-modal'),
                        news: document.getElementById('news-modal'),
                        newsDetail: document.getElementById('news-detail-modal'),
                        bloqueManual: document.getElementById('bloque-manual-modal'),
                        manual: document.getElementById('manual-modal'),
                        bloqueArchivo: document.getElementById('bloque-archivo-modal'),
                        archivo: document.getElementById('archivo-modal'),
                        confirm: document.getElementById('confirm-modal'),
                        calendarDay: document.getElementById('calendar-day-modal'),
                    },
                    newsDetail: {
                        title: document.getElementById('news-detail-title'),
                        date: document.getElementById('news-detail-date'),
                        image: document.getElementById('news-detail-image'),
                        content: document.getElementById('news-detail-content'),
                        galleryContainer: document.getElementById('news-gallery-container'),
                        thumbnails: document.getElementById('news-gallery-thumbnails'),
                        prevBtn: document.getElementById('gallery-prev-btn'),
                        nextBtn: document.getElementById('gallery-next-btn'),
                    },
                    confirmModal: {
                        message: document.getElementById('confirm-message'),
                        deleteBtn: document.getElementById('confirm-delete-btn'),
                    },
                    calendarDayModal: {
                        title: document.getElementById('calendar-day-modal-title'),
                        eventsList: document.getElementById('calendar-day-events-list'),
                        birthdaysSection: document.getElementById('calendar-day-birthdays-section'),
                        birthdaysList: document.getElementById('calendar-day-birthdays-list'),
                    }
                };
            },
            
            /** Muestra una página y actualiza las pestañas de navegación. */
            showPage(pageId) {
                this.elements.nav.pagesContainer.querySelectorAll('.page').forEach(page => page.classList.toggle('active', page.id === pageId));
                document.querySelectorAll(`[data-target]`).forEach(tab => tab.classList.toggle('active', tab.dataset.target === pageId));
            },

            /** Renderiza una tabla con datos. */
            renderTable(tbody, data, rowRenderer, emptyMessage) {
                tbody.innerHTML = '';
                if (data.length === 0) {
                    const colSpan = tbody.closest('table')?.querySelector('thead tr').childElementCount || 1;
                    tbody.innerHTML = `<tr><td colspan="${colSpan}" class="p-4 text-center text-gray-500">${emptyMessage}</td></tr>`;
                    return;
                }
                const sortedData = [...data].sort((a, b) => (a.nombre || a.name || '').localeCompare(b.nombre || b.name || ''));
                sortedData.forEach(item => tbody.insertAdjacentHTML('beforeend', rowRenderer(item)));
            },
            
            /** Renderiza una cuadrícula de tarjetas. */
            renderGrid(container, data, cardRenderer, emptyMessage) {
                container.innerHTML = '';
                if (data.length === 0) {
                    container.innerHTML = `<p class="col-span-full text-center text-gray-500">${emptyMessage}</span>`;
                    return;
                }
                const sortedData = [...data].sort((a, b) => new Date(b.fechaPublicacion) - new Date(a.fechaPublicacion));
                sortedData.forEach(item => container.insertAdjacentHTML('beforeend', cardRenderer(item)));
            },

            /** Actualiza la UI de administrador (botones, visibilidad de elementos, etc.). */
            updateAdminUI(isSuperAdmin, isAdmin, user, viewAsUser) {
                document.body.classList.toggle('super-admin-mode', isSuperAdmin && !viewAsUser);
                document.body.classList.toggle('admin-mode', (isAdmin || isSuperAdmin) && !viewAsUser);
                
                if (user) {
                     const isSuperAdminView = isSuperAdmin ? `
                        <div class="flex items-center gap-2">
                            <span class="text-sm font-medium whitespace-nowrap">Vista Usuario</span>
                            <label for="view-as-user-switch" class="flex items-center cursor-pointer">
                                <div class="relative">
                                    <input type="checkbox" id="view-as-user-switch" class="sr-only" ${viewAsUser ? 'checked' : ''}>
                                    <div class="block bg-gray-400 dark:bg-gray-600 w-10 h-6 rounded-full transition"></div>
                                    <div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition-transform"></div>
                                </div>
                            </label>
                        </div>
                    ` : '';

                     this.elements.header.adminControlsContainer.innerHTML = `
                        <div class="flex items-center gap-4">
                            ${isSuperAdminView}
                            <span class="font-semibold hidden sm:inline">${user.nombre.split(' ')[0]}</span>
                            <button data-action="logout" class="neumorphic-btn danger p-2" title="Cerrar Sesión">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                            </button>
                        </div>`;
                } else {
                     this.elements.header.adminControlsContainer.innerHTML = ``;
                }
                this.nav.initMobileNav();
            },

            // --- Componentes de UI ---
            tablero: {
                renderUpcomingEvents(events, container) {
                    container.innerHTML = '';
                    const now = new Date();
                    now.setHours(0, 0, 0, 0);
                    const upcoming = events
                        .filter(event => new Date(event.date + 'T00:00:00Z') >= now)
                        .sort((a, b) => new Date(`${a.date}T${a.time}`) - new Date(`${b.date}T${b.time}`))
                        .slice(0, 5);

                    if (upcoming.length === 0) {
                        container.innerHTML = '<li class="text-gray-500">No hay próximos eventos.</li>';
                        return;
                    }
                    upcoming.forEach(event => {
                        const placeholderImage = 'https://placehold.co/100x100/eef0f4/4b5563?text=Evento';
                        container.insertAdjacentHTML('beforeend', `
                            <li class="flex items-center gap-4 p-3 rounded-lg neumorphic-inset">
                                <img src="${event.imageUrl || placeholderImage}" alt="Imagen del evento" class="w-16 h-16 object-cover rounded-lg flex-shrink-0" onerror="this.src='${placeholderImage}'">
                                <div class="overflow-hidden">
                                    <p class="font-semibold truncate">${event.name}</p>
                                    <p class="text-sm text-gray-500">${new Date(event.date + 'T00:00:00Z').toLocaleDateString('es-ES', { month: 'long', day: 'numeric' })} - ${event.time}h</p>
                                </div>
                            </li>`);
                    });
                },
                renderBirthdayReminders(parroquianos, card, list) {
                    const today = new Date();
                    const birthdayFolks = parroquianos.filter(p => {
                        if (!p.nacimiento) return false;
                        const birthDate = new Date(p.nacimiento + 'T00:00:00Z');
                        return (birthDate.getMonth() === today.getMonth()) && (birthDate.getDate() === today.getDate());
                    });
                    list.innerHTML = '';
                    if (birthdayFolks.length === 0) {
                        card.style.display = 'none';
                    } else {
                        card.style.display = 'block';
                        birthdayFolks.forEach(person => {
                            list.insertAdjacentHTML('beforeend', `
                                <li class="flex items-center gap-4 p-3 rounded-lg neumorphic-inset">
                                    <div class="text-amber-500"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-8 h-8"><path fill-rule="evenodd" d="M10.868 2.884c.321-.772 1.415-.772 1.736 0l1.681 4.06c.064.155.19.283.348.333l4.48.653c.84.123 1.171 1.157.536 1.748l-3.242 3.159c-.12.117-.175.284-.15.444l.764 4.463c.145.845-.733 1.493-1.488 1.085l-4.01-2.108a.75.75 0 00-.702 0l-4.01 2.108c-.755.408-1.633-.24-1.488-1.085l.764-4.463c.025-.16-.03-.327-.15-.444l-3.242-3.159c-.635-.591-.304-1.625.536-1.748l4.48-.653c.158-.023.284-.15.348-.333l1.681-4.06z" clip-rule="evenodd" /></svg></div>
                                    <div><p class="font-semibold">${person.nombre}</p><p class="text-sm">¡Hoy es su cumpleaños!</p></div>
                                </li>`);
                        });
                    }
                },
                updateDateTime(dateEl, timeEl) {
                    const now = new Date();
                    const days = ['DOM', 'LUN', 'MAR', 'MIÉ', 'JUE', 'VIE', 'SÁB'];
                    dateEl.textContent = `${days[now.getDay()]} ${String(now.getDate()).padStart(2, '0')}/${String(now.getMonth() + 1).padStart(2, '0')}`;
                    timeEl.textContent = now.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                },
                updateWeather(data, tempEl, descEl, locEl) {
                    tempEl.textContent = data.temp ? `${Math.round(data.temp)}°` : '--°';
                    descEl.textContent = data.description ? data.description.charAt(0).toUpperCase() + data.description.slice(1) : 'Cargando...';
                    locEl.textContent = data.location || '';
                }
            },
            agenda: {
                createRow(event) {
                    const date = new Date(event.date + 'T00:00:00Z').toLocaleDateString('es-ES', { day: '2-digit', month: 'short', year: 'numeric' });
                    return `
                        <tr class="border-b border-gray-300/50">
                            <td class="p-3">${date}</td>
                            <td class="p-3 hidden sm:table-cell">${event.time}</td>
                            <td class="p-3 font-medium">${event.name}</td>
                            <td class="p-3 admin-only-table-cell" data-permission="agenda">
                                <div class="flex gap-2">
                                    <button data-action="edit" data-type="event" data-id="${event.id}" class="neumorphic-btn btn-sm">Editar</button>
                                    <button data-action="delete" data-type="event" data-id="${event.id}" class="neumorphic-btn danger btn-sm">Eliminar</button>
                                </div>
                            </td>
                        </tr>`;
                }
            },
            directorio: {
                createRow(p) {
                    return `
                        <tr class="border-b border-gray-300/50">
                            <td class="p-3 font-medium">${p.nombre || ''}</td>
                            <td class="p-3 hidden md:table-cell">${p.telefono || ''}</td>
                            <td class="p-3 hidden lg:table-cell">${p.emergencia_nombre || ''}</td>
                            <td class="p-3 admin-only-table-cell" data-permission="directorio">
                                 <div class="flex gap-2">
                                    <button data-action="edit" data-type="parroquiano" data-id="${p.id}" class="neumorphic-btn btn-sm">Editar</button>
                                    <button data-action="delete" data-type="parroquiano" data-id="${p.id}" class="neumorphic-btn danger btn-sm">Eliminar</button>
                                </div>
                            </td>
                        </tr>`;
                }
            },
            noticias: {
                createCard(article) {
                    const placeholderImage = 'https://placehold.co/600x400/eef0f4/4b5563?text=Noticia';
                    return `
                        <div class="neumorphic-card flex flex-col">
                            <img src="${article.imageUrl || placeholderImage}" alt="Imagen de la noticia" class="rounded-t-2xl h-48 w-full object-cover" onerror="this.src='${placeholderImage}'">
                            <div class="p-4 flex flex-col flex-grow">
                                <h3 class="text-lg font-bold mb-2 break-words">${article.titulo}</h3>
                                <p class="text-sm text-gray-500 mb-2">${new Date(article.fechaPublicacion).toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                                <p class="text-sm mb-4 flex-grow break-words">${article.resumen}</p>
                                <div class="flex justify-between items-center mt-auto">
                                    <button data-action="read-more" data-type="news" data-id="${article.id}" class="neumorphic-btn primary btn-sm">Leer Más</button>
                                    <div class="admin-only" data-permission="noticias" style="gap: 0.5rem;">
                                        <button data-action="edit" data-type="news" data-id="${article.id}" class="neumorphic-btn btn-sm">Editar</button>
                                        <button data-action="delete" data-type="news" data-id="${article.id}" class="neumorphic-btn danger btn-sm">Eliminar</button>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                }
            },
             acordeon: { // Para Manuales y Recursos
                render(container, blocks, emptyMessage, typeConfig) {
                    container.innerHTML = '';
                    if (blocks.length === 0) {
                        container.innerHTML = `<p class="text-center text-gray-500">${emptyMessage}</p>`;
                        return;
                    }
                    const sortedBlocks = [...blocks].sort((a, b) => (a.nombre || '').localeCompare(b.nombre || ''));
                    sortedBlocks.forEach(block => {
                        const items = block.items || [];
                        const itemsHtml = items.length > 0 ? items.map(item => `
                            <li class="flex justify-between items-center p-3 rounded-lg neumorphic-inset">
                                <a href="${item.url}" target="_blank" rel="noopener noreferrer" class="flex-grow truncate hover:text-blue-600 flex items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 flex-shrink-0"><path d="M12.232 4.232a2.5 2.5 0 013.536 3.536l-1.225 1.224a.75.75 0 001.061 1.06l1.224-1.224a4 4 0 00-5.656-5.656l-3 3a4 4 0 00.225 5.865.75.75 0 00.977-1.138 2.5 2.5 0 01-.142-3.665l3-3z" /><path d="M8.603 14.397a2.5 2.5 0 01-3.536-3.536l1.225-1.224a.75.75 0 00-1.061-1.06l-1.224 1.224a4 4 0 005.656 5.656l3-3a4 4 0 00-.225-5.865.75.75 0 00-.977 1.138 2.5 2.5 0 01.142 3.665l-3 3z" /></svg>
                                    <span class="truncate">${item.nombre}</span>
                                </a>
                                <div class="admin-only flex-shrink-0 ml-4" data-permission="${typeConfig.permission}" style="gap: 0.5rem;">
                                    <button data-action="edit" data-type="${typeConfig.item}" data-block-id="${block.id}" data-item-id="${item.id}" class="neumorphic-btn btn-sm">Editar</button>
                                    <button data-action="delete" data-type="${typeConfig.item}" data-block-id="${block.id}" data-item-id="${item.id}" class="neumorphic-btn danger btn-sm">Eliminar</button>
                                </div>
                            </li>
                        `).join('') : `<li class="text-sm text-gray-500 p-2">No hay ${typeConfig.plural} en este bloque.</li>`;

                        container.insertAdjacentHTML('beforeend', `
                            <div class="neumorphic-card overflow-hidden">
                                <div class="flex justify-between items-center p-4 cursor-pointer accordion-toggle">
                                    <h3 class="text-xl font-bold">${block.nombre}</h3>
                                    <div class="flex items-center gap-4">
                                        <div class="admin-only" data-permission="${typeConfig.permission}" style="gap: 0.5rem;">
                                            <button data-action="add-item" data-modal-target="${typeConfig.item}-modal" data-block-id="${block.id}" class="neumorphic-btn primary btn-sm">Añadir</button>
                                            <button data-action="edit" data-type="${typeConfig.block}" data-id="${block.id}" class="neumorphic-btn btn-sm">Editar</button>
                                            <button data-action="delete" data-type="${typeConfig.block}" data-id="${block.id}" class="neumorphic-btn danger btn-sm">Eliminar</button>
                                        </div>
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor" class="accordion-icon w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" /></svg>
                                    </div>
                                </div>
                                <div class="accordion-content">
                                    <ul class="p-4 pt-0 space-y-3">${itemsHtml}</ul>
                                </div>
                            </div>`);
                    });
                }
            },
            calendario: {
                render(date, events, parroquianos, headerEl, gridEl) {
                    const year = date.getFullYear();
                    const month = date.getMonth();
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
                    headerEl.textContent = `${monthNames[month]} ${year}`;
                    gridEl.innerHTML = '';
                    const firstDayOfMonth = new Date(year, month, 1).getDay();
                    const daysInMonth = new Date(year, month + 1, 0).getDate();
                    for (let i = 0; i < firstDayOfMonth; i++) {
                        gridEl.insertAdjacentHTML('beforeend', `<div></div>`);
                    }
                    for (let day = 1; day <= daysInMonth; day++) {
                        const cellDate = new Date(year, month, day);
                        const isToday = cellDate.getTime() === today.getTime();
                        const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                        const dailyEvents = events.filter(e => e.date === dateString);
                        const dailyBirthdays = parroquianos.filter(p => {
                            if (!p.nacimiento) return false;
                            const birthDate = new Date(p.nacimiento + 'T00:00:00Z');
                            return birthDate.getMonth() === month && birthDate.getDate() === day;
                        });
                        
                        const isClickable = dailyEvents.length > 0 || dailyBirthdays.length > 0;
                        let cellClasses = `calendar-cell ${isToday ? 'is-today' : ''}`;
                        let actionAttr = '';
                        if (isClickable) {
                            cellClasses += ' cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-600';
                            actionAttr = `data-action="show-day-details" data-date="${dateString}"`;
                        }

                        let itemsHtml = dailyEvents.map(e => `<div class="calendar-item event-item" title="${e.name} a las ${e.time}">${e.name}</div>`).join('');
                        itemsHtml += dailyBirthdays.map(p => `<div class="calendar-item birthday-item" title="Cumpleaños de ${p.nombre}">🎂 ${p.nombre.split(' ')[0]}</div>`).join('');
                        
                        const cellHtml = `<div class="${cellClasses}" ${actionAttr}><div class="calendar-day-number">${day}</div><div class="calendar-items-container">${itemsHtml}</div></div>`;
                        gridEl.insertAdjacentHTML('beforeend', cellHtml);
                    }
                }
            },
            userManagement: {
                render(users, tableBody) {
                    tableBody.innerHTML = '';
                    const permissionsMap = {
                        agenda: 'Agenda', directorio: 'Directorio', noticias: 'Noticias',
                        manuales: 'Manuales', recursos: 'Recursos', verAgendaCalendario: 'Ver Agenda Cal.'
                    };
                    const permissionsKeys = Object.keys(permissionsMap);

                    users.forEach(user => {
                        if (user.role === 'superadmin') return;
                        
                        const roleSwitch = `
                            <label class="flex items-center cursor-pointer">
                                <div class="relative">
                                    <input type="checkbox" data-user-id="${user.id}" class="sr-only user-role-switch" ${user.role === 'admin' ? 'checked' : ''}>
                                    <div class="block bg-gray-400 dark:bg-gray-600 w-10 h-6 rounded-full transition"></div>
                                    <div class="dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition-transform"></div>
                                </div>
                                <span id="role-label-${user.id}" class="ml-3 text-sm font-medium">${user.role === 'admin' ? 'Admin' : 'Espectador'}</span>
                            </label>`;

                        const permissionsCheckboxes = permissionsKeys.map(key => `
                            <label class="flex items-center gap-1 text-xs">
                               <input type="checkbox" data-user-id="${user.id}" data-permission="${key}" class="user-permission-checkbox" 
                               ${user.permissions && user.permissions[key] ? 'checked' : ''} ${user.role !== 'admin' ? 'disabled' : ''}>
                               ${permissionsMap[key]}
                            </label>
                        `).join('');

                        const row = `
                            <tr class="border-b border-gray-300/50">
                                <td class="p-3">${user.nombre}</td>
                                <td class="p-3">${user.email}</td>
                                <td class="p-3">${roleSwitch}</td>
                                <td class="p-3">
                                    <div class="flex flex-wrap gap-2 items-center ${user.role !== 'admin' ? 'opacity-50' : ''}">
                                        ${permissionsCheckboxes}
                                    </div>
                                </td>
                                <td class="p-3">
                                    <button data-action="delete-user" data-user-id="${user.id}" class="neumorphic-btn danger btn-sm">Eliminar</button>
                                </td>
                            </tr>`;
                        tableBody.insertAdjacentHTML('beforeend', row);
                    });
                }
            },
            nav: {
                initMobileNav() {
                    let linksHtml = '';
                    document.querySelectorAll('#tabs-container .nav-button').forEach(btn => {
                        const style = window.getComputedStyle(btn);
                        if (style.display === 'none') return;

                        const text = btn.textContent.trim();
                        const target = btn.dataset.target;
                        const isActive = btn.classList.contains('active');
                        
                        linksHtml += `
                            <button class="nav-button ${isActive ? 'active' : ''}" data-target="${target}" style="width: 100%;">
                                ${text}
                            </button>`;
                    });
                    UI.elements.nav.mobileNavLinks.innerHTML = linksHtml;
                },
                toggleSidenav(open) {
                    const { mobileSidenav, mobileSidenavOverlay } = UI.elements.nav;
                    mobileSidenav.classList.add('is-transitioning');
                    mobileSidenav.style.transform = open ? 'translateX(0)' : 'translateX(-100%)';
                    mobileSidenavOverlay.classList.toggle('active', open);
                }
            },
        };

        // =================================================================================
        // CONTROLADOR PRINCIPAL DE LA APLICACIÓN (App)
        // Orquesta la lógica, maneja el estado y conecta los servicios con la UI.
        // =================================================================================
        const App = {
            state: {
                auth: { user: null, isSuperAdmin: false, isAdmin: false, viewAsUser: false },
                data: { events: [], parroquianos: [], news: [], manuales: [], archivos: [], allUsers: [] },
                ui: { currentCalendarDate: new Date(), currentGalleryImages: [], currentGalleryIndex: 0 },
            },
            dataListenersInitialized: false,
            
            /**
             * Punto de entrada de la aplicación.
             */
            async init() {
                try {
                    UI.init();
                    this.setupEventListeners();
                    this.initTheme();
                    this.initTimers();
                    FirebaseService.init(this.onAuthStateChanged.bind(this));
                } catch (error) {
                     console.error("Error fatal durante la inicialización:", error);
                    document.body.innerHTML = `<div class="fixed inset-0 bg-red-100 text-red-800 p-8 flex flex-col justify-center items-center text-center"><h1 class="text-3xl font-bold mb-4">¡Ups! Ocurrió un error crítico.</h1><p class="mb-4">${error.message}</p></div>`;
                }
            },
            
            /**
             * Se ejecuta cuando cambia el estado de autenticación de Firebase.
             * @param {import("firebase/auth").User | null} authUser - El objeto de usuario de Firebase.
             */
            async onAuthStateChanged(authUser) {
                 let userProfile = null;
                 if (authUser) {
                     const userDoc = await FirebaseService.getDoc('users', authUser.uid);
                     if (userDoc.exists()) {
                         userProfile = { id: authUser.uid, ...userDoc.data() };
                     } else if (authUser.email === 'admin@portal.com') {
                         const superAdminProfile = { nombre: 'Admin Especial', email: authUser.email, role: 'superadmin', permissions: {} };
                         await FirebaseService.setDoc('users', authUser.uid, superAdminProfile);
                         userProfile = { id: authUser.uid, ...superAdminProfile };
                     }
                 }
                
                this.state.auth.user = userProfile;
                this.state.auth.isSuperAdmin = userProfile?.role === 'superadmin';
                this.state.auth.isAdmin = userProfile?.role === 'admin';

                this.updateLockscreenStatus();
                this.updateUIPermissions();

                if (!this.dataListenersInitialized && userProfile) {
                    this.setupDataListeners();
                    this.loadWeather();
                    UI.calendario.render(this.state.ui.currentCalendarDate, this.state.data.events, this.state.data.parroquianos, UI.elements.pages.calendario.header, UI.elements.pages.calendario.grid);
                    this.dataListenersInitialized = true;
                }

                if (UI.elements.appLoading.style.display !== 'none') {
                    UI.elements.appLoading.style.display = 'none';
                    UI.elements.appContainer.classList.add('loaded');
                }
            },
            
            /**
             * Configura los listeners de datos de Firestore.
             */
            setupDataListeners() {
                FirebaseService.onCollectionSnapshot('events', d => { this.state.data.events = d; this.renderAgenda(); this.renderTablero(); this.renderCalendario(); });
                FirebaseService.onCollectionSnapshot('parroquianos', d => { this.state.data.parroquianos = d; this.renderDirectorio(); this.renderTablero(); this.renderCalendario(); });
                FirebaseService.onCollectionSnapshot('news', d => { this.state.data.news = d; UI.renderGrid(UI.elements.pages.noticias.grid, d, UI.noticias.createCard, 'No hay noticias.'); });
                FirebaseService.onCollectionSnapshot('manuales', d => { this.state.data.manuales = d; UI.acordeon.render(UI.elements.pages.manuales.container, d, 'No hay manuales.', {plural: 'manuales', block: 'bloqueManual', item: 'manual', permission: 'manuales'}); });
                FirebaseService.onCollectionSnapshot('archivos', d => { this.state.data.archivos = d; UI.acordeon.render(UI.elements.pages.recursos.container, d, 'No hay archivos.', {plural: 'archivos', block: 'bloqueArchivo', item: 'archivo', permission: 'recursos'}); });
                FirebaseService.onCollectionSnapshot('users', users => { this.state.data.allUsers = users; if(this.state.auth.isSuperAdmin) { UI.userManagement.render(users, UI.elements.pages.userManagement.tableBody); } });
            },

            // --- Renderizadores de Páginas Completas ---
            renderTablero() {
                UI.tablero.renderUpcomingEvents(this.state.data.events, UI.elements.pages.tablero.upcomingEventsList);
                UI.tablero.renderBirthdayReminders(this.state.data.parroquianos, UI.elements.pages.tablero.birthdayCard, UI.elements.pages.tablero.birthdayList);
            },
            renderAgenda() {
                UI.renderTable(UI.elements.pages.agenda.tableBody, this.state.data.events, UI.agenda.createRow, 'No hay eventos.');
            },
            renderDirectorio() {
                UI.renderTable(UI.elements.pages.directorio.tableBody, this.state.data.parroquianos, UI.directorio.createRow, 'No hay registros.');
            },
            renderCalendario() {
                 UI.calendario.render(this.state.ui.currentCalendarDate, this.state.data.events, this.state.data.parroquianos, UI.elements.pages.calendario.header, UI.elements.pages.calendario.grid);
            },

            // --- Lógica de Permisos ---
            hasPermission(section) {
                const { viewAsUser, isSuperAdmin, isAdmin, user } = this.state.auth;
                if (viewAsUser) return false;
                if (isSuperAdmin) return true;
                return isAdmin && user.permissions?.[section] === true;
            },
            updateUIPermissions() {
                 UI.updateAdminUI(this.state.auth.isSuperAdmin, this.state.auth.isAdmin, this.state.auth.user, this.state.auth.viewAsUser);
                 document.querySelectorAll('[data-permission]').forEach(el => {
                    el.style.display = this.hasPermission(el.dataset.permission) ? '' : 'none';
                 });
                 UI.nav.initMobileNav();
            },
            updateLockscreenStatus() {
                const { user, isSuperAdmin, isAdmin } = this.state.auth;
                const { unlockSwitch, unlockSwitchLabel, message, container } = UI.elements.lockscreen;
                if (isSuperAdmin || isAdmin || user?.role === 'viewer') {
                    unlockSwitch.disabled = false;
                    unlockSwitchLabel.classList.remove('disabled');
                    message.classList.add('hidden');
                } else {
                    unlockSwitch.disabled = true;
                    unlockSwitch.checked = false;
                    unlockSwitchLabel.classList.add('disabled');
                    if (container.classList.contains('fade-out')) {
                        container.style.display = 'flex';
                        setTimeout(() => container.classList.remove('fade-out'), 10);
                    }
                }
            },

            // --- Manejadores de Eventos ---
            setupEventListeners() {
                document.body.addEventListener('click', this.handleGlobalClick.bind(this));
                document.addEventListener('submit', this.handleFormSubmission.bind(this));
                document.body.addEventListener('change', this.handleGlobalChange.bind(this));

                // --- Event listeners específicos ---
                UI.elements.lockscreen.unlockSwitch.addEventListener('change', (e) => {
                    if (e.target.checked) setTimeout(() => UI.elements.lockscreen.container.classList.add('fade-out'), 300);
                });
                document.getElementById('prev-month-btn').addEventListener('click', () => { this.state.ui.currentCalendarDate.setMonth(this.state.ui.currentCalendarDate.getMonth() - 1); this.renderCalendario(); });
                document.getElementById('next-month-btn').addEventListener('click', () => { this.state.ui.currentCalendarDate.setMonth(this.state.ui.currentCalendarDate.getMonth() + 1); this.renderCalendario(); });
            },
            
            handleGlobalClick(e) {
                const target = e.target.closest('[data-action], [data-target], [data-modal-target], .accordion-toggle');
                if (!target) return;

                const { action, target: pageTarget, modalTarget, type, id, blockId, itemId } = target.dataset;

                if (pageTarget) UI.showPage(pageTarget);
                if (modalTarget) this.openModal(modalTarget, null, blockId);

                if (action) {
                    const actionHandlers = {
                        'logout': this.handleLogout,
                        'close-modal': () => this.closeModal(target.closest('.fixed.inset-0').id),
                        'close-sidenav': () => UI.nav.toggleSidenav(false),
                        'edit': () => this.handleEdit(type, id, blockId, itemId),
                        'delete': () => this.handleDelete(type, id, blockId, itemId),
                        'delete-user': () => this.handleDeleteUser(target.dataset.userId),
                        'read-more': () => this.handleReadMore(id),
                        'add-item': () => this.openModal(`${modalTarget.replace('-modal', '')}-modal`, null, blockId),
                        'show-day-details': () => this.handleShowDayDetails(target.dataset.date),
                    };
                    actionHandlers[action]?.();
                }
                
                if (target.matches('.accordion-toggle')) {
                    target.classList.toggle('active');
                    const content = target.nextElementSibling;
                    content.style.maxHeight = content.style.maxHeight ? null : `${content.scrollHeight}px`;
                }
                 if(target.id === 'show-register-btn') { e.preventDefault(); document.getElementById('login-view').classList.add('hidden'); document.getElementById('register-view').classList.remove('hidden'); target.classList.add('active'); document.getElementById('show-login-btn').classList.remove('active'); }
                 if(target.id === 'show-login-btn') { e.preventDefault(); document.getElementById('register-view').classList.add('hidden'); document.getElementById('login-view').classList.remove('hidden'); target.classList.add('active'); document.getElementById('show-register-btn').classList.remove('active'); }

            },

            handleFormSubmission(e) {
                e.preventDefault();
                const formId = e.target.id;
                const formHandlers = {
                    'login-form': this.handleLogin,
                    'register-form': this.handleRegister,
                };
                // Llama al manejador específico o al genérico
                (formHandlers[formId] || this.handleGenericFormSubmit).call(this, e.target);
            },
            
            handleGlobalChange(e) {
                const target = e.target;
                if (target.id === 'view-as-user-switch') {
                    this.state.auth.viewAsUser = e.target.checked;
                    this.updateUIPermissions();
                } else if (target.matches('.user-role-switch')) {
                    const userId = target.dataset.userId;
                    const newRole = target.checked ? 'admin' : 'viewer';
                    const label = document.getElementById(`role-label-${userId}`);
                    if (label) {
                        label.textContent = newRole === 'admin' ? 'Admin' : 'Espectador';
                    }
                    this.updateUserRole(userId, newRole);
                } else if (target.matches('.user-permission-checkbox')) {
                    this.updateUserPermission(target.dataset.userId, target.dataset.permission, target.checked);
                }
            },
            
            // --- Acciones de la Aplicación ---
            async handleLogin(form) { /* ... Lógica de inicio de sesión ... */ },
            async handleRegister(form) { /* ... Lógica de registro ... */ },
            async handleLogout() { await signOut(FirebaseService.auth); },
            async handleGenericFormSubmit(form) { /* ... Lógica de envío de formularios ... */ },
            handleEdit(type, id, blockId, itemId) { /* ... Lógica de edición ... */ },
            handleDelete(type, id, blockId, itemId) { /* ... Lógica de eliminación ... */ },
            handleDeleteUser(userId) {
                if (!this.state.auth.isSuperAdmin || this.state.auth.user.id === userId) return;

                const userToDelete = this.state.data.allUsers.find(u => u.id === userId);
                if (!userToDelete) return;

                UI.elements.confirmModal.message.textContent = `¿Seguro de eliminar al usuario "${userToDelete.nombre}"? Esta acción eliminará su perfil de la app, pero no su cuenta de autenticación.`;
                this.openModal('confirm');

                UI.elements.confirmModal.deleteBtn.onclick = async () => {
                    try {
                        // Nota: Esto solo elimina el perfil del usuario de Firestore.
                        // La eliminación completa de la cuenta de Firebase Auth requeriría una Cloud Function
                        // por razones de seguridad, lo cual está fuera del alcance de este entorno de cliente.
                        await FirebaseService.deleteDoc('users', userId);
                        this.closeModal('confirm');
                    } catch (err) {
                        console.error(`Error al eliminar usuario:`, err);
                    }
                };
            },
            handleReadMore(id) { /* ... Lógica de "Leer más" ... */ },
            handleShowDayDetails(dateString) {
                const date = new Date(dateString + 'T00:00:00Z');
                const dailyEvents = this.state.data.events.filter(e => e.date === dateString);
                const dailyBirthdays = this.state.data.parroquianos.filter(p => {
                    if (!p.nacimiento) return false;
                    const birthDate = new Date(p.nacimiento + 'T00:00:00Z');
                    return birthDate.getMonth() === date.getMonth() && birthDate.getDate() === date.getDate();
                });

                const { title, eventsList, birthdaysSection, birthdaysList } = UI.elements.calendarDayModal;
                title.textContent = `Detalles del ${date.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' })}`;

                eventsList.innerHTML = dailyEvents.length > 0
                    ? dailyEvents.map(e => `<li class="p-2 neumorphic-inset rounded-lg">${e.name} - ${e.time}h</li>`).join('')
                    : '<li class="text-sm text-gray-500">No hay eventos para este día.</li>';

                if (this.hasPermission('verAgendaCalendario')) {
                    birthdaysSection.classList.remove('hidden');
                    birthdaysList.innerHTML = dailyBirthdays.length > 0
                        ? dailyBirthdays.map(p => `<li class="p-2 neumorphic-inset rounded-lg">🎂 Cumpleaños de ${p.nombre}</li>`).join('')
                        : '<li class="text-sm text-gray-500">No hay cumpleaños este día.</li>';
                } else {
                    birthdaysSection.classList.add('hidden');
                }

                this.openModal('calendar-day-modal');
            },

            async updateUserRole(userId, newRole) {
                if (!this.state.auth.isSuperAdmin) return;
                await FirebaseService.saveDoc('users', userId, { role: newRole });
            },
            async updateUserPermission(userId, permission, isEnabled) {
                 if (!this.state.auth.isSuperAdmin) return;
                 const user = this.state.data.allUsers.find(u => u.id === userId);
                 if (user) {
                     const permissions = { ...(user.permissions || {}), [permission]: isEnabled };
                     await FirebaseService.saveDoc('users', userId, { permissions });
                 }
            },

            // --- Utilidades ---
            initTimers() {
                setInterval(() => {
                    const { currentDate, currentTime } = UI.elements.pages.tablero;
                    UI.tablero.updateDateTime(currentDate, currentTime);
                    const { time, date } = UI.elements.lockscreen;
                    if(time) time.textContent = new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                    if(date) date.textContent = new Date().toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
                }, 1000);
            },
            async loadWeather() { 
                const data = await WeatherService.fetch();
                const { weatherTemp, weatherDesc, weatherLocation } = UI.elements.pages.tablero;
                UI.tablero.updateWeather(data, weatherTemp, weatherDesc, weatherLocation);
            },
            initTheme() {
                const themeSwitch = UI.elements.header.themeSwitch;
                const savedTheme = localStorage.getItem('theme');
                const applyTheme = (theme) => {
                    document.body.classList.toggle('dark-theme', theme === 'dark');
                    themeSwitch.checked = theme === 'dark';
                };
                
                if (savedTheme) applyTheme(savedTheme);
                else if (window.matchMedia?.('(prefers-color-scheme: dark)').matches) applyTheme('dark');

                themeSwitch.addEventListener('change', () => {
                    const newTheme = themeSwitch.checked ? 'dark' : 'light';
                    localStorage.setItem('theme', newTheme);
                    applyTheme(newTheme);
                });
            },
             openModal(modalId, data = null, blockId = null) {
                const modal = UI.elements.modals[modalId.replace('-modal','')] || document.getElementById(modalId);
                if (!modal) return;
                const form = modal.querySelector('form');
                if (form) {
                    form.reset();
                    const titleEl = modal.querySelector('h2'); 
                    const type = form.dataset.type;
                    let typeName = {
                        'bloqueManual': 'Bloque de Manual', 'manual': 'Manual',
                        'bloqueArchivo': 'Bloque de Archivo', 'archivo': 'Archivo',
                        'news': 'Noticia', 'event': 'Evento', 'parroquiano': 'Parroquiano'
                    }[type] || type;

                    if (modalId !== 'user-auth-modal' && titleEl) {
                        titleEl.textContent = data ? `Editar ${typeName}` : `Agregar ${typeName}`;
                    }

                    if (data) {
                        Object.keys(data).forEach(key => {
                            const input = form.querySelector(`[name="${key}"]`);
                            if (input) {
                                if (key === 'galleryUrls' && Array.isArray(data[key])) input.value = data[key].join('\n');
                                else input.value = data[key];
                            }
                        });
                    }
                    const blockIdInput = form.querySelector('input[name="blockId"]');
                    if (blockId && blockIdInput) blockIdInput.value = blockId;
                }
                modal.classList.remove('hidden');
            },
            closeModal(modalId) { 
                const modal = UI.elements.modals[modalId.replace('-modal','')] || document.getElementById(modalId);
                if (modal) modal.classList.add('hidden');
            }
        };

        // Rellenar la implementación de los manejadores que faltan
        App.handleLogin = async function(form) {
            const email = form.querySelector('#login-email').value;
            const password = form.querySelector('#login-password').value;
            const errorMsg = form.querySelector('#login-error-msg');
            errorMsg.classList.add('hidden');
            
            try {
                let userCredential;
                if (email === 'admin@portal.com' && password === 'admin123') {
                     userCredential = await signInWithEmailAndPassword(FirebaseService.auth, email, password).catch(err => 
                        err.code === 'auth/user-not-found' ? createUserWithEmailAndPassword(FirebaseService.auth, email, password) : Promise.reject(err)
                     );
                } else {
                    userCredential = await signInWithEmailAndPassword(FirebaseService.auth, email, password);
                }
                this.closeModal('user-auth-modal');

                const { unlockSwitch, container } = UI.elements.lockscreen;
                if (unlockSwitch.disabled) {
                    unlockSwitch.disabled = false;
                    UI.elements.lockscreen.unlockSwitchLabel.classList.remove('disabled');
                    UI.elements.lockscreen.message.classList.add('hidden');
                }
                unlockSwitch.checked = true;
                unlockSwitch.dispatchEvent(new Event('change'));
            } catch(error) {
                errorMsg.textContent = 'Correo o contraseña incorrectos.';
                errorMsg.classList.remove('hidden');
            }
        };
        App.handleRegister = async function(form) {
             const name = form.querySelector('#register-name').value;
             const email = form.querySelector('#register-email').value;
             const password = form.querySelector('#register-password').value;
             const errorMsg = form.querySelector('#register-error-msg');
             errorMsg.classList.add('hidden');

            try {
                const userCredential = await createUserWithEmailAndPassword(FirebaseService.auth, email, password);
                const newUserProfile = { nombre: name, email: email, role: 'viewer', permissions: {} };
                await FirebaseService.setDoc('users', userCredential.user.uid, newUserProfile);
                this.closeModal('user-auth-modal');

                const { unlockSwitch, container } = UI.elements.lockscreen;
                if (unlockSwitch.disabled) {
                    unlockSwitch.disabled = false;
                    UI.elements.lockscreen.unlockSwitchLabel.classList.remove('disabled');
                    UI.elements.lockscreen.message.classList.add('hidden');
                }
                unlockSwitch.checked = true;
                unlockSwitch.dispatchEvent(new Event('change'));
            } catch(error) {
                 if (error.code === 'auth/email-already-in-use') errorMsg.textContent = 'Este correo ya está registrado.';
                 else if (error.code === 'auth/weak-password') errorMsg.textContent = 'La contraseña debe tener al menos 6 caracteres.';
                 else errorMsg.textContent = 'Error al registrar la cuenta.';
                 errorMsg.classList.remove('hidden');
            }
        };
        App.handleGenericFormSubmit = async function(form) {
            const type = form.dataset.type;
            const permissionMap = {
                event: 'agenda', parroquiano: 'directorio', news: 'noticias',
                bloqueManual: 'manuales', manual: 'manuales',
                bloqueArchivo: 'recursos', archivo: 'recursos',
                verAgendaCalendario: 'verAgendaCalendario'
            };
            if (!this.hasPermission(permissionMap[type])) return;
            
            const submitButton = form.querySelector('button[type="submit"]');
            if (submitButton) submitButton.disabled = true;

            try {
                const data = Object.fromEntries(new FormData(form).entries());
                const id = data.id;
                delete data.id;

                const blockTypes = { bloqueManual: 'manuales', bloqueArchivo: 'archivos' };
                const itemTypes = { manual: { collection: 'manuales' }, archivo: { collection: 'archivos' } };

                if (blockTypes[type]) {
                    if (!id) data.items = [];
                    await FirebaseService.saveDoc(blockTypes[type], id, data);
                } else if (itemTypes[type]) {
                    const config = itemTypes[type];
                    const { blockId, ...itemData } = data;
                    const block = this.state.data[config.collection].find(b => b.id === blockId);
                    if (!block) throw new Error("Block not found");

                    const items = block.items || [];
                    if (itemData.id) { // Edit item
                        const index = items.findIndex(item => item.id === itemData.id);
                        if (index > -1) items[index] = { ...items[index], ...itemData };
                    } else { // Add new item
                         itemData.id = crypto.randomUUID();
                         items.push(itemData);
                    }
                    await FirebaseService.saveDoc(config.collection, blockId, { items });
                } else {
                     if (type === 'news') data.galleryUrls = data.galleryUrls ? data.galleryUrls.split('\n').map(url => url.trim()).filter(Boolean) : [];
                    await FirebaseService.saveDoc(type === 'news' ? 'news' : type + 's', id, data);
                }
                this.closeModal(`${type}-modal`);
            } catch (err) {
                console.error(`Error al guardar:`, err);
            } finally {
                if (submitButton) submitButton.disabled = false;
            }
        };
        App.handleEdit = function(type, id, blockId, itemId) {
            const permissionMap = {
                event: 'agenda', parroquiano: 'directorio', news: 'noticias',
                bloqueManual: 'manuales', manual: 'manuales',
                bloqueArchivo: 'recursos', archivo: 'recursos',
                verAgendaCalendario: 'verAgendaCalendario'
            };
            if(!this.hasPermission(permissionMap[type])) return;

            const itemTypes = { manual: 'manuales', archivo: 'archivos' };
            const blockTypes = { bloqueManual: 'manuales', bloqueArchivo: 'archivos' };

            if (itemTypes[type]) {
                const block = this.state.data[itemTypes[type]].find(b => b.id === blockId);
                const item = block?.items.find(i => i.id === itemId);
                if (item) this.openModal(`${type}-modal`, { ...item, blockId });
            } else {
                const collectionName = blockTypes[type] || (type === 'news' ? 'news' : type + 's');
                const item = this.state.data[collectionName].find(i => i.id === id);
                if (item) this.openModal(`${type}-modal`, item);
            }
        };
        App.handleDelete = function(type, id, blockId, itemId) {
            const permissionMap = {
                event: 'agenda', parroquiano: 'directorio', news: 'noticias',
                bloqueManual: 'manuales', manual: 'manuales',
                bloqueArchivo: 'recursos', archivo: 'recursos',
                verAgendaCalendario: 'verAgendaCalendario'
            };
            if (!this.hasPermission(permissionMap[type])) return;

            UI.elements.confirmModal.message.textContent = `¿Seguro de eliminar este registro?`;
            this.openModal('confirm');

            UI.elements.confirmModal.deleteBtn.onclick = async () => {
                try {
                    const itemTypes = { manual: 'manuales', archivo: 'archivos' };
                    const blockTypes = { bloqueManual: 'manuales', bloqueArchivo: 'archivos' };

                    if (itemTypes[type]) {
                        const block = this.state.data[itemTypes[type]].find(b => b.id === blockId);
                        if (block) {
                            const items = (block.items || []).filter(item => item.id !== itemId);
                            await FirebaseService.saveDoc(itemTypes[type], blockId, { items });
                        }
                    } else {
                        await FirebaseService.deleteDoc(blockTypes[type] || (type === 'news' ? 'news' : type + 's'), id);
                    }
                    this.closeModal('confirm');
                } catch (err) { console.error(`Error al eliminar:`, err); }
            };
        };
        App.handleReadMore = function(id) {
            const item = this.state.data.news.find(i => i.id === id);
            if (!item) return;
            const { title, date, content, image, thumbnails, prevBtn, nextBtn } = UI.elements.newsDetail;
            
            title.textContent = item.titulo;
            date.textContent = new Date(item.fechaPublicacion).toLocaleDateString('es-ES',{year:'numeric',month:'long',day:'numeric'});
            content.innerHTML = item.contenido.replace(/\n/g,'<br>');
            
            this.state.ui.currentGalleryImages = [item.imageUrl, ...(item.galleryUrls || [])].filter(Boolean);
            this.state.ui.currentGalleryIndex = 0;
            
            thumbnails.innerHTML = this.state.ui.currentGalleryImages.map((url, index) => 
                `<img src="${url}" data-action="set-gallery-image" data-index="${index}" class="gallery-thumbnail ${index === 0 ? 'active' : ''}">`
            ).join('');
            
            const showBtns = this.state.ui.currentGalleryImages.length > 1;
            prevBtn.classList.toggle('hidden', !showBtns);
            nextBtn.classList.toggle('hidden', !showBtns);

            const showImage = (index) => {
                image.style.opacity = 0;
                setTimeout(() => {
                    image.src = this.state.ui.currentGalleryImages[index] || 'https://placehold.co/800x600/eef0f4/4b5563?text=No+disponible';
                    image.style.opacity = 1;
                }, 150);
                thumbnails.querySelectorAll('.gallery-thumbnail').forEach((thumb, i) => {
                    thumb.classList.toggle('active', i === index);
                    if (i === index) thumb.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                });
                this.state.ui.currentGalleryIndex = index;
            };

            prevBtn.onclick = () => showImage((this.state.ui.currentGalleryIndex - 1 + this.state.ui.currentGalleryImages.length) % this.state.ui.currentGalleryImages.length);
            nextBtn.onclick = () => showImage((this.state.ui.currentGalleryIndex + 1) % this.state.ui.currentGalleryImages.length);
            thumbnails.onclick = (e) => {
                if(e.target.matches('.gallery-thumbnail')) showImage(parseInt(e.target.dataset.index, 10));
            };

            showImage(0);
            this.openModal('newsDetail');
        };

        // Iniciar la aplicación
        document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>
</html>

