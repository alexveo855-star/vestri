<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Parroquial</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⛪</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- Base y Diseño Neumorfista --- */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #eef0f4;
            color: #4b5563;
        }
        .fade-out {
            opacity: 0;
        }
        #app-loading {
            position: fixed; inset: 0; display: flex; align-items: center; justify-content: center;
            background-color: #eef0f4; z-index: 100; font-size: 1.25rem; color: #4b5563;
        }
        #app-container { opacity: 0; transition: opacity 0.3s ease-in-out; }
        #app-container.loaded { opacity: 1; }
        .page { display: none; }
        .page.active { display: block; }
        
        /* --- Visibilidad del Administrador --- */
        .admin-only, .admin-only-table-cell {
            display: none !important;
        }
        .admin-mode .admin-only {
            display: inline-flex !important;
        }
         .admin-mode .admin-only-block {
            display: block !important;
        }
        .admin-mode .admin-only-table-cell {
            display: table-cell !important;
        }

        /* Tarjeta Neumorfista (Extruida) */
        .neumorphic-card {
            background: #eef0f4;
            border-radius: 20px;
            box-shadow: 8px 8px 16px #d1d9e6, -8px -8px 16px #ffffff;
        }

        /* Estilo Presionado (Intruido) */
        .neumorphic-inset {
            box-shadow: inset 6px 6px 12px #d1d9e6, inset -6px -6px 12px #ffffff;
        }

        /* Botones Neumorfistas */
        .neumorphic-btn {
            padding: 0.5rem 1rem;
            border-radius: 10px;
            border: none;
            background: #eef0f4;
            box-shadow: 4px 4px 8px #d1d9e6, -4px -4px 8px #ffffff;
            color: #4b5563;
            font-weight: 500;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .neumorphic-btn:hover {
            box-shadow: 2px 2px 4px #d1d9e6, -2px -2px 4px #ffffff;
        }
        .neumorphic-btn:active, .neumorphic-btn.active {
            box-shadow: inset 4px 4px 8px #d1d9e6, inset -4px -4px 8px #ffffff;
            color: #3b82f6;
        }
        .neumorphic-btn.primary { color: #3b82f6; font-weight: 600; }
        .neumorphic-btn.danger { color: #ef4444; }
        .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.875rem; }
        .neumorphic-btn:disabled {
            cursor: not-allowed;
            opacity: 0.7;
            box-shadow: inset 2px 2px 4px #d1d9e6, inset -2px -2px 4px #ffffff;
        }

        /* Pestañas de Navegación */
        #tabs-container { border-bottom: none; padding: 1rem; }
        .nav-tab {
            border-bottom: none;
            border-radius: 12px;
            padding: 1rem;
            transition: all 0.2s ease-in-out;
            color: #6B7280; /* Tono de ícono más claro */
        }
        @media (min-width: 1280px) {
            .nav-tab { padding: 1.25rem; }
        }
        .nav-tab.active {
            color: #3b82f6;
            box-shadow: inset 5px 5px 10px #d1d9e6, inset -5px -5px 10px #ffffff;
        }
        .nav-tab:not(.active):hover { color: #3b82f6; }

        /* Campos de Formulario */
        .neumorphic-input {
            width: 100%;
            background: #eef0f4;
            border: none;
            border-radius: 10px;
            padding: 0.75rem 1rem;
            box-shadow: inset 4px 4px 8px #d1d9e6, inset -4px -4px 8px #ffffff;
        }
        .neumorphic-input:focus { outline: none; }
        textarea.neumorphic-input { resize: none; }
        
        /* Estilos del Calendario */
        .calendar-cell {
            min-height: 100px; padding: 0.25rem; border-radius: 10px; background: #eef0f4;
            transition: all 0.2s ease-in-out; border: 1px solid transparent; display: flex; flex-direction: column;
        }
        @media (min-width: 768px) { .calendar-cell { min-height: 120px; padding: 0.5rem; } }
        .calendar-cell.is-today { box-shadow: inset 4px 4px 8px #d1d9e6, inset -4px -4px 8px #ffffff; border-color: #3b82f6; }
        .calendar-cell.not-current-month { color: #9ca3af; background: transparent; }
        .calendar-day-number { font-weight: 600; margin-bottom: 0.25rem; }
        .calendar-items-container { flex-grow: 1; overflow-y: auto; }
        .calendar-item {
            font-size: 0.75rem; padding: 2px 6px; border-radius: 6px; margin-bottom: 4px;
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap; cursor: default;
        }
        .event-item { background-color: #bfdbfe; color: #1e40af; }
        .birthday-item { background-color: #fef08a; color: #854d0e; }

        /* Estilos del Panel Edge Móvil */
        #mobile-sidenav-overlay {
            position: fixed; inset: 0; background-color: rgba(31, 41, 55, 0.5); z-index: 55;
            opacity: 0; transition: opacity 0.3s ease-in-out; pointer-events: none;
        }
        #mobile-sidenav {
            position: fixed; top: 0; left: 0; bottom: 0; width: 280px; background-color: #eef0f4;
            z-index: 60; transform: translateX(-100%); padding: 1.5rem; display: flex; flex-direction: column; will-change: transform;
        }
        #mobile-sidenav.is-transitioning { transition: transform 0.3s ease-in-out; }
        #mobile-sidenav.active { transform: translateX(0); }
        #mobile-sidenav-overlay.active { opacity: 1; pointer-events: auto; }
        .mobile-nav-link {
            display: flex; align-items: center; gap: 1rem; padding: 0.75rem 1rem; border-radius: 12px;
            font-weight: 500; color: #4b5563; transition: all 0.2s ease-in-out;
        }
        .mobile-nav-link.active { color: #3b82f6; box-shadow: inset 5px 5px 10px #d1d9e6, inset -5px -5px 10px #ffffff; }
        .mobile-nav-link:not(.active):hover { color: #3b82f6; }
        #edge-handle {
            position: fixed; top: 30%; left: 0; transform: translateY(-50%); width: 20px; height: 80px;
            background-color: rgba(107, 114, 128, 0.4); border-top-right-radius: 10px; border-bottom-right-radius: 10px;
            z-index: 50; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }
        #edge-handle::before { content: ''; width: 4px; height: 20px; background: #fff; border-radius: 2px; }
        
        /* Estilos de la Galería de Noticias */
        .gallery-thumbnail {
            width: 80px; height: 60px; border-radius: 8px; cursor: pointer; object-fit: cover;
            opacity: 0.6; transition: all 0.2s ease-in-out; border: 2px solid transparent; flex-shrink: 0;
        }
        .gallery-thumbnail.active { opacity: 1; border-color: #3b82f6; box-shadow: 0 0 0 3px #eef0f4; }
        #news-gallery-thumbnails { -ms-overflow-style: none; scrollbar-width: none; }
        #news-gallery-thumbnails::-webkit-scrollbar { display: none; }

        /* Estilos de Acordeón */
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out;
        }
        .accordion-icon {
            transition: transform 0.3s ease-in-out;
        }
        .accordion-toggle.active .accordion-icon {
            transform: rotate(180deg);
        }

        /* --- Estilos del Interruptor de Desbloqueo --- */
        .unlock-switch-label {
            display: inline-block;
            width: 120px;
            height: 60px;
        }
        .unlock-switch-track {
            position: relative;
            width: 100%;
            height: 100%;
            border-radius: 30px;
        }
        .unlock-switch-thumb {
            position: absolute;
            top: 5px;
            left: 5px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            transition: transform 0.3s ease-in-out, background-color 0.3s;
        }
        #unlock-switch:checked + .unlock-switch-track .unlock-switch-thumb {
            transform: translateX(60px);
            background-color: #d1fae5; /* Verde claro para indicar 'desbloqueado' */
        }
    </style>
</head>
<body class="antialiased">

    <!-- Pantalla de Bloqueo -->
    <div id="app-lockscreen" class="fixed inset-0 z-[101] flex flex-col items-center justify-center transition-opacity duration-1000 ease-in-out" style="background-color: #eef0f4;">
        <div class="text-center">
            <p id="lockscreen-time" class="text-7xl font-bold text-gray-700"></p>
            <p id="lockscreen-date" class="text-xl text-gray-500"></p>
        </div>

        <div class="mt-16 text-center">
            <label for="unlock-switch" class="unlock-switch-label cursor-pointer">
                <input type="checkbox" id="unlock-switch" class="hidden">
                <div class="unlock-switch-track neumorphic-inset">
                    <div class="unlock-switch-thumb neumorphic-card"></div>
                </div>
            </label>
            <p class="mt-6 text-gray-500 font-medium">Toca para desbloquear</p>
        </div>
    </div>

    <!-- Menú Móvil -->
    <div id="mobile-nav-wrapper" class="md:hidden">
        <div id="mobile-sidenav-overlay"></div>
        <div id="mobile-sidenav">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-xl font-bold text-gray-700">Menú</h2>
                <button id="close-sidenav-btn" class="neumorphic-btn p-2"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button>
            </div>
            <nav id="mobile-nav-links" class="flex flex-col gap-3"></nav>
        </div>
        <div id="edge-handle"></div>
    </div>

    <div id="app-loading">Cargando Portal...</div>

    <div id="app-container" class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-8 relative">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-700">Portal Parroquial</h1>
            <p class="text-gray-500 mt-2">Un espacio para toda la comunidad.</p>
             <div id="admin-controls-container" class="absolute top-0 right-0"></div>
        </header>

        <!-- Navegación Principal (Desktop) -->
        <nav class="mb-8 neumorphic-card hidden md:block">
            <div id="tabs-container" class="flex flex-wrap justify-center items-center gap-2 sm:gap-4">
                <div class="nav-tab active" data-target="page-tablero" title="Tablero"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 016 3.75h2.25A2.25 2.25 0 0110.5 6v2.25a2.25 2.25 0 01-2.25 2.25H6A2.25 2.25 0 013.75 8.25V6zM3.75 15.75A2.25 2.25 0 016 13.5h2.25a2.25 2.25 0 012.25 2.25V18a2.25 2.25 0 01-2.25 2.25H6A2.25 2.25 0 013.75 18v-2.25zM13.5 6a2.25 2.25 0 012.25-2.25H18A2.25 2.25 0 0120.25 6v2.25A2.25 2.25 0 0118 10.5h-2.25a2.25 2.25 0 01-2.25-2.25V6zM13.5 15.75a2.25 2.25 0 012.25-2.25H18a2.25 2.25 0 012.25 2.25V18A2.25 2.25 0 0118 20.25h-2.25A2.25 2.25 0 0113.5 18v-2.25z" /></svg></div>
                <div class="nav-tab" data-target="page-agenda" title="Eventos"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div>
                <div class="nav-tab" data-target="page-directorio" title="Directorio"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-4.67c.12-.24.232-.487.335-.737m-3.058 3.07A3.375 3.375 0 008.25 15c0-1.01.39-1.928 1.04-2.625M16.5 7.5V18a2.25 2.25 0 002.25 2.25M16.5 7.5V4.875c0-.621-.504-1.125-1.125-1.125H4.125C3.504 3.75 3 4.254 3 4.875V18a2.25 2.25 0 002.25 2.25h13.5M6 7.5h3v3H6v-3z" /></svg></div>
                <div class="nav-tab" data-target="page-noticias" title="Noticias"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M12 7.5h1.5m-1.5 3h1.5m-7.5 3h7.5m-7.5 3h7.5m3-9h3.375c.621 0 1.125.504 1.125 1.125V18a2.25 2.25 0 01-2.25 2.25M16.5 7.5V18a2.25 2.25 0 002.25 2.25M16.5 7.5V4.875c0-.621-.504-1.125-1.125-1.125H4.125C3.504 3.75 3 4.254 3 4.875V18a2.25 2.25 0 002.25 2.25h13.5M6 7.5h3v3H6v-3z" /></svg></div>
                <div class="nav-tab" data-target="page-manuales" title="Manuales"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" /></svg></div>
                <div class="nav-tab" data-target="page-recursos" title="Recursos"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.75V12A2.25 2.25 0 014.5 9.75h15A2.25 2.25 0 0121.75 12v.75m-8.69-6.44l-2.12-2.12a1.5 1.5 0 00-1.061-.44H4.5A2.25 2.25 0 002.25 6v12a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9a2.25 2.25 0 00-2.25-2.25h-5.379a1.5 1.5 0 01-1.06-.44z" /></svg></div>
                <div class="nav-tab" data-target="page-calendario" title="Calendario"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0h18M-4.5 12h22.5" /></svg></div>
            </div>
        </nav>

        <main>
            <div id="pages-container">
                <!-- Páginas de Contenido -->
                <div id="page-tablero" class="page active">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="md:col-span-1 neumorphic-card flex flex-col p-6">
                            <h2 class="text-xl font-bold mb-4">Hoy</h2>
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <p id="current-date" class="text-3xl font-bold text-blue-600"></p>
                                    <p id="current-time" class="text-lg"></p>
                                </div>
                                <div class="text-right">
                                    <p id="weather-temp" class="text-3xl font-bold">--°C</p>
                                    <p id="weather-desc" class="text-sm">Cargando...</p>
                                </div>
                            </div>
                             <div class="text-sm text-gray-400 flex items-center justify-end gap-1">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4"><path fill-rule="evenodd" d="M9.69 18.933l.003.001C9.89 19.02 10 19 10 19s.11.02.308-.066l.002-.001.006-.003.018-.008a5.741 5.741 0 00.281-.14c.186-.12.406-.28.653-.478l.048-.041a11.956 11.956 0 002.55-2.55c.33-.445.626-.902.87-1.371.243-.47.44-1.003.58-1.583a7.996 7.996 0 00.12-2.318C15.02 5.09 12.833 3 10 3S4.98 5.09 4.98 8.132a7.996 7.996 0 00.12 2.318c.14.58.337 1.113.58 1.583.244.469.54.926.87 1.371a11.956 11.956 0 002.55 2.55l.048.041c.247.198.467.358.653.478a5.741 5.741 0 00.281.14l.018.008.006.003zM10 11.25a3.125 3.125 0 100-6.25 3.125 3.125 0 000 6.25z" clip-rule="evenodd" /></svg>
                                <span id="weather-location"></span>
                             </div>
                        </div>
                        <div class="md:col-span-2 space-y-6">
                            <div id="birthday-card" class="neumorphic-card p-6" style="display: none;">
                                <h2 class="text-xl font-bold mb-4">Cumpleaños de Hoy</h2>
                                <ul id="birthday-list" class="space-y-3"></ul>
                            </div>
                            <div class="neumorphic-card p-6">
                                <h2 class="text-xl font-bold mb-4">Próximos Eventos</h2>
                                <ul id="upcoming-events-list" class="space-y-3"><li class="text-gray-500">Cargando eventos...</li></ul>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="page-agenda" class="page">
                    <div class="neumorphic-card p-6">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                            <h2 class="text-2xl font-bold">Eventos</h2>
                            <button data-modal-target="event-modal" class="neumorphic-btn primary w-full sm:w-auto admin-only"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" /></svg><span>Agregar Evento</span></button>
                        </div>
                        <div class="overflow-x-auto"><table class="w-full text-left"><thead class="border-b border-gray-300"><tr><th class="p-3 font-semibold">Fecha</th><th class="p-3 font-semibold hidden sm:table-cell">Hora</th><th class="p-3 font-semibold">Nombre del Evento</th><th class="p-3 font-semibold admin-only-table-cell">Acciones</th></tr></thead><tbody id="agenda-table-body"></tbody></table></div>
                    </div>
                </div>
                <div id="page-directorio" class="page">
                    <div class="neumorphic-card p-6">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                            <h2 class="text-2xl font-bold">Directorio</h2>
                            <button data-modal-target="parroquiano-modal" class="neumorphic-btn primary w-full sm:w-auto admin-only"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path d="M11 5a3 3 0 11-6 0 3 3 0 016 0zM12.73 10.21a5.002 5.002 0 016.536 6.536l.243.243a1 1 0 11-1.414 1.414l-.243-.243a5.002 5.002 0 01-7.95-7.95l-1.01-1.01A5.002 5.002 0 012.27 12.27l-1.01 1.01a1 1 0 11-1.414-1.414l1.01-1.01a5.002 5.002 0 017.95 7.95l.243.243a1 1 0 011.414 1.414l-.243-.243a5.002 5.002 0 01-6.536-6.536l1.01 1.01z" /></svg><span>Agregar Parroquiano</span></button>
                        </div>
                        <div class="overflow-x-auto"><table class="w-full text-left"><thead class="border-b border-gray-300"><tr><th class="p-3 font-semibold">Nombre</th><th class="p-3 font-semibold hidden md:table-cell">Teléfono</th><th class="p-3 font-semibold hidden lg:table-cell">Contacto Emergencia</th><th class="p-3 font-semibold admin-only-table-cell">Acciones</th></tr></thead><tbody id="directorio-table-body"></tbody></table></div>
                    </div>
                </div>
                <div id="page-noticias" class="page">
                    <div class="neumorphic-card p-6">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                            <h2 class="text-2xl font-bold">Noticias Parroquiales</h2>
                            <button data-modal-target="news-modal" class="neumorphic-btn primary w-full sm:w-auto admin-only"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" /></svg><span>Agregar Noticia</span></button>
                        </div>
                        <div id="news-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                    </div>
                </div>
                <div id="page-manuales" class="page">
                    <div class="neumorphic-card p-6">
                         <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                            <h2 class="text-2xl font-bold">Manuales y Guías</h2>
                            <button data-modal-target="bloque-manual-modal" class="neumorphic-btn primary w-full sm:w-auto admin-only"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" /></svg><span>Agregar Bloque</span></button>
                        </div>
                        <div id="manuales-container" class="space-y-4"></div>
                    </div>
                </div>
                <div id="page-recursos" class="page">
                    <div class="neumorphic-card p-6">
                         <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                            <h2 class="text-2xl font-bold">Recursos y Documentos</h2>
                            <button data-modal-target="bloque-archivo-modal" class="neumorphic-btn primary w-full sm:w-auto admin-only"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" /></svg><span>Agregar Bloque</span></button>
                        </div>
                        <div id="archivos-container" class="space-y-4"></div>
                    </div>
                </div>
                <div id="page-calendario" class="page">
                    <div class="neumorphic-card p-6">
                        <div id="calendar-header" class="flex justify-between items-center mb-6">
                            <button id="prev-month-btn" class="neumorphic-btn p-2 sm:p-auto"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" /></svg></button>
                            <h2 id="month-year-header" class="text-xl sm:text-2xl font-bold text-center"></h2>
                            <button id="next-month-btn" class="neumorphic-btn p-2 sm:p-auto"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" /></svg></button>
                        </div>
                        <div class="grid grid-cols-7 gap-1 sm:gap-2 text-center font-semibold mb-2 text-gray-600 text-sm sm:text-base"><div>Do</div><div>Lu</div><div>Ma</div><div>Mi</div><div>Ju</div><div>Vi</div><div>Sá</div></div>
                        <div id="calendar-grid" class="grid grid-cols-7 gap-1 sm:gap-2"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modales -->
    <div id="admin-login-modal" class="fixed inset-0 bg-gray-900 bg-opacity-25 flex items-center justify-center hidden z-50 p-4">
        <div class="neumorphic-card p-8 w-full max-w-sm">
            <h2 class="text-2xl font-bold mb-6">Acceso de Administrador</h2>
            <form id="admin-login-form">
                <div class="mb-4"><label for="admin-password" class="block text-sm font-medium mb-1">Contraseña</label><input type="password" id="admin-password" name="password" class="neumorphic-input" required></div>
                <p id="login-error-msg" class="text-red-500 text-sm mb-4 hidden">Contraseña incorrecta.</p>
                <div class="flex justify-end gap-4"><button type="button" data-action="close-modal" class="neumorphic-btn">Cancelar</button><button type="submit" class="neumorphic-btn primary">Ingresar</button></div>
            </form>
        </div>
    </div>
    <div id="event-modal" class="fixed inset-0 bg-gray-900 bg-opacity-25 flex items-center justify-center hidden z-50 p-4">
        <div class="neumorphic-card p-8 w-full max-w-md">
            <h2 class="text-2xl font-bold mb-6"></h2>
            <form id="event-form" data-type="event">
                <input type="hidden" name="id">
                <div class="mb-4"><label for="event-name" class="block text-sm font-medium mb-1">Nombre del Evento</label><input type="text" id="event-name" name="name" class="neumorphic-input" required></div>
                <div class="mb-4"><label for="event-date" class="block text-sm font-medium mb-1">Fecha</label><input type="date" id="event-date" name="date" class="neumorphic-input" required></div>
                <div class="mb-4"><label for="event-time" class="block text-sm font-medium mb-1">Hora</label><input type="time" id="event-time" name="time" class="neumorphic-input" required></div>
                <div class="mb-6">
                    <label for="event-imageUrl" class="block text-sm font-medium mb-1">URL de la Imagen (Opcional)</label>
                    <input type="url" id="event-imageUrl" name="imageUrl" class="neumorphic-input" placeholder="https://ejemplo.com/imagen.jpg">
                </div>
                <div class="flex justify-end gap-4"><button type="button" data-action="close-modal" class="neumorphic-btn">Cancelar</button><button type="submit" class="neumorphic-btn primary">Guardar</button></div>
            </form>
        </div>
    </div>
    <div id="parroquiano-modal" class="fixed inset-0 bg-gray-900 bg-opacity-25 flex items-center justify-center hidden z-50 p-4">
        <div class="neumorphic-card p-8 w-full max-w-lg">
            <h2 class="text-2xl font-bold mb-6"></h2>
            <form id="parroquiano-form" data-type="parroquiano">
                <input type="hidden" name="id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-[60vh] overflow-y-auto pr-2">
                    <div class="md:col-span-2"><label for="parroquiano-nombre" class="block text-sm font-medium mb-1">Nombre Completo</label><input type="text" id="parroquiano-nombre" name="nombre" class="neumorphic-input" required></div>
                    <div class="md:col-span-2"><label for="parroquiano-direccion" class="block text-sm font-medium mb-1">Dirección</label><input type="text" id="parroquiano-direccion" name="direccion" class="neumorphic-input"></div>
                    <div><label for="parroquiano-telefono" class="block text-sm font-medium mb-1">Teléfono</label><input type="tel" id="parroquiano-telefono" name="telefono" class="neumorphic-input"></div>
                    <div><label for="parroquiano-correo" class="block text-sm font-medium mb-1">Correo Electrónico</label><input type="email" id="parroquiano-correo" name="correo" class="neumorphic-input"></div>
                    <div><label for="parroquiano-nacimiento" class="block text-sm font-medium mb-1">Fecha de Nacimiento</label><input type="date" id="parroquiano-nacimiento" name="nacimiento" class="neumorphic-input"></div>
                    <div><label for="parroquiano-tipo-sangre" class="block text-sm font-medium mb-1">Tipo de Sangre</label><input type="text" id="parroquiano-tipo-sangre" name="tipo_sangre" class="neumorphic-input"></div>
                    <div class="md:col-span-2"><label for="parroquiano-alergias" class="block text-sm font-medium mb-1">Alergias</label><textarea id="parroquiano-alergias" name="alergias" rows="2" class="neumorphic-input"></textarea></div>
                    <div class="md:col-span-2"><label for="parroquiano-medicamentos" class="block text-sm font-medium mb-1">Medicamentos</label><textarea id="parroquiano-medicamentos" name="medicamentos" rows="2" class="neumorphic-input"></textarea></div>
                    <div class="md:col-span-2"><hr class="my-2 border-gray-300/50"></div>
                    <div><label for="parroquiano-emergencia-nombre" class="block text-sm font-medium mb-1">Llamar a (Emergencia)</label><input type="text" id="parroquiano-emergencia-nombre" name="emergencia_nombre" class="neumorphic-input"></div>
                    <div><label for="parroquiano-emergencia-telefono" class="block text-sm font-medium mb-1">Teléfono (Emergencia)</label><input type="tel" id="parroquiano-emergencia-telefono" name="emergencia_telefono" class="neumorphic-input"></div>
                    <div class="md:col-span-2"><label for="parroquiano-notas" class="block text-sm font-medium mb-1">Notas Adicionales</label><textarea id="parroquiano-notas" name="notas" rows="2" class="neumorphic-input"></textarea></div>
                </div>
                <div class="flex justify-end gap-4 mt-6"><button type="button" data-action="close-modal" class="neumorphic-btn">Cancelar</button><button type="submit" class="neumorphic-btn primary">Guardar</button></div>
            </form>
        </div>
    </div>
     <div id="news-modal" class="fixed inset-0 bg-gray-900 bg-opacity-25 flex items-center justify-center hidden z-50 p-4">
        <div class="neumorphic-card p-8 w-full max-w-lg">
            <h2 class="text-2xl font-bold mb-6"></h2>
            <form id="news-form" data-type="news">
                <input type="hidden" name="id">
                <div class="grid grid-cols-1 gap-4 max-h-[70vh] overflow-y-auto pr-2">
                    <div><label for="news-titulo" class="block text-sm font-medium mb-1">Título</label><input type="text" id="news-titulo" name="titulo" class="neumorphic-input" required></div>
                    <div>
                        <label for="news-imagenUrl" class="block text-sm font-medium mb-1">URL de la Imagen Principal</label>
                        <input type="url" id="news-imagenUrl" name="imagenUrl" class="neumorphic-input" placeholder="https://ejemplo.com/imagen.jpg">
                    </div>
                    <div><label for="news-resumen" class="block text-sm font-medium mb-1">Resumen</label><textarea id="news-resumen" name="resumen" rows="3" class="neumorphic-input" required></textarea></div>
                    <div><label for="news-contenido" class="block text-sm font-medium mb-1">Contenido Completo</label><textarea id="news-contenido" name="contenido" rows="6" class="neumorphic-input" required></textarea></div>
                    <div>
                        <label for="news-galleryUrls" class="block text-sm font-medium mb-1">URLs de la Galería (una por línea)</label>
                        <textarea id="news-galleryUrls" name="galleryUrls" rows="4" class="neumorphic-input" placeholder="https://ejemplo.com/imagen1.jpg\nhttps://ejemplo.com/imagen2.jpg"></textarea>
                    </div>
                </div>
                <div class="flex justify-end gap-4 mt-6">
                    <button type="button" data-action="close-modal" class="neumorphic-btn">Cancelar</button>
                    <button type="submit" class="neumorphic-btn primary">Guardar Noticia</button>
                </div>
            </form>
        </div>
    </div>
    <div id="news-detail-modal" class="fixed inset-0 bg-gray-900 bg-opacity-25 flex items-center justify-center hidden z-50 p-4">
        <div class="neumorphic-card p-6 sm:p-8 w-full max-w-3xl max-h-[90vh] flex flex-col">
            <h2 id="news-detail-title" class="text-2xl sm:text-3xl font-bold mb-2"></h2>
            <p id="news-detail-date" class="text-sm text-gray-500 mb-4"></p>
            <div class="flex-grow overflow-y-auto pr-2">
                <div id="news-gallery-container" class="relative mb-4">
                    <img id="news-detail-image" src="" alt="Imagen de la noticia" class="rounded-2xl w-full h-64 sm:h-80 object-cover transition-opacity duration-300">
                    <button id="gallery-prev-btn" class="absolute top-1/2 left-2 transform -translate-y-1/2 neumorphic-btn p-2 rounded-full hidden"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" /></svg></button>
                    <button id="gallery-next-btn" class="absolute top-1/2 right-2 transform -translate-y-1/2 neumorphic-btn p-2 rounded-full hidden"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" /></svg></button>
                </div>
                <div id="news-gallery-thumbnails" class="flex gap-2 overflow-x-auto pb-2 mb-4"></div>
                <div id="news-detail-content" class="prose max-w-none"></div>
            </div>
            <div class="flex justify-end gap-4 mt-6 flex-shrink-0"><button type="button" data-action="close-modal" class="neumorphic-btn">Cerrar</button></div>
        </div>
    </div>
    <div id="bloque-manual-modal" class="fixed inset-0 bg-gray-900 bg-opacity-25 flex items-center justify-center hidden z-50 p-4">
        <div class="neumorphic-card p-8 w-full max-w-md">
            <h2 class="text-2xl font-bold mb-6"></h2>
            <form id="bloque-manual-form" data-type="bloqueManual">
                <input type="hidden" name="id">
                <div class="mb-6"><label for="bloque-manual-nombre" class="block text-sm font-medium mb-1">Nombre del Bloque</label><input type="text" id="bloque-manual-nombre" name="nombre" class="neumorphic-input" required></div>
                <div class="flex justify-end gap-4"><button type="button" data-action="close-modal" class="neumorphic-btn">Cancelar</button><button type="submit" class="neumorphic-btn primary">Guardar</button></div>
            </form>
        </div>
    </div>
     <div id="bloque-archivo-modal" class="fixed inset-0 bg-gray-900 bg-opacity-25 flex items-center justify-center hidden z-50 p-4">
        <div class="neumorphic-card p-8 w-full max-w-md">
            <h2 class="text-2xl font-bold mb-6"></h2>
            <form id="bloque-archivo-form" data-type="bloqueArchivo">
                <input type="hidden" name="id">
                <div class="mb-6"><label for="bloque-archivo-nombre" class="block text-sm font-medium mb-1">Nombre del Bloque</label><input type="text" id="bloque-archivo-nombre" name="nombre" class="neumorphic-input" required></div>
                <div class="flex justify-end gap-4"><button type="button" data-action="close-modal" class="neumorphic-btn">Cancelar</button><button type="submit" class="neumorphic-btn primary">Guardar</button></div>
            </form>
        </div>
    </div>
    <div id="manual-modal" class="fixed inset-0 bg-gray-900 bg-opacity-25 flex items-center justify-center hidden z-50 p-4">
        <div class="neumorphic-card p-8 w-full max-w-md">
            <h2 class="text-2xl font-bold mb-6"></h2>
            <form id="manual-form" data-type="manual">
                <input type="hidden" name="id">
                <input type="hidden" name="blockId">
                <div class="mb-4"><label for="manual-nombre" class="block text-sm font-medium mb-1">Nombre del Manual</label><input type="text" id="manual-nombre" name="nombre" class="neumorphic-input" required></div>
                <div class="mb-6"><label for="manual-url" class="block text-sm font-medium mb-1">URL del Manual</label><input type="url" id="manual-url" name="url" class="neumorphic-input" required placeholder="https://ejemplo.com/documento.pdf"></div>
                <div class="flex justify-end gap-4"><button type="button" data-action="close-modal" class="neumorphic-btn">Cancelar</button><button type="submit" class="neumorphic-btn primary">Guardar</button></div>
            </form>
        </div>
    </div>
    <div id="archivo-modal" class="fixed inset-0 bg-gray-900 bg-opacity-25 flex items-center justify-center hidden z-50 p-4">
        <div class="neumorphic-card p-8 w-full max-w-md">
            <h2 class="text-2xl font-bold mb-6"></h2>
            <form id="archivo-form" data-type="archivo">
                <input type="hidden" name="id">
                <input type="hidden" name="blockId">
                <div class="mb-4"><label for="archivo-nombre" class="block text-sm font-medium mb-1">Nombre del Archivo</label><input type="text" id="archivo-nombre" name="nombre" class="neumorphic-input" required></div>
                <div class="mb-6"><label for="archivo-url" class="block text-sm font-medium mb-1">URL del Archivo</label><input type="url" id="archivo-url" name="url" class="neumorphic-input" required placeholder="https://ejemplo.com/documento.pdf"></div>
                <div class="flex justify-end gap-4"><button type="button" data-action="close-modal" class="neumorphic-btn">Cancelar</button><button type="submit" class="neumorphic-btn primary">Guardar</button></div>
            </form>
        </div>
    </div>
    <div id="confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-25 flex items-center justify-center hidden z-50 p-4">
        <div class="neumorphic-card p-8 w-full max-w-sm">
            <h2 class="text-xl font-bold mb-4">Confirmar Eliminación</h2>
            <p id="confirm-message" class="mb-6">¿Estás seguro?</p>
            <div class="flex justify-end gap-4"><button type="button" data-action="close-modal" class="neumorphic-btn">Cancelar</button><button type="button" id="confirm-delete-btn" class="neumorphic-btn danger">Eliminar</button></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const UI = {
            elements: {
                appLoading: document.getElementById('app-loading'),
                appContainer: document.getElementById('app-container'),
                tabsContainer: document.getElementById('tabs-container'),
                pagesContainer: document.getElementById('pages-container'),
                adminControlsContainer: document.getElementById('admin-controls-container'),
                edgeHandle: document.getElementById('edge-handle'),
                mobileSidenav: document.getElementById('mobile-sidenav'),
                mobileSidenavOverlay: document.getElementById('mobile-sidenav-overlay'),
                closeSidenavBtn: document.getElementById('close-sidenav-btn'),
                mobileNavLinks: document.getElementById('mobile-nav-links'),
                currentDate: document.getElementById('current-date'),
                currentTime: document.getElementById('current-time'),
                lockscreenTime: document.getElementById('lockscreen-time'),
                lockscreenDate: document.getElementById('lockscreen-date'),
                weatherTemp: document.getElementById('weather-temp'),
                weatherDesc: document.getElementById('weather-desc'),
                weatherLocation: document.getElementById('weather-location'),
                upcomingEventsList: document.getElementById('upcoming-events-list'),
                birthdayCard: document.getElementById('birthday-card'),
                birthdayList: document.getElementById('birthday-list'),
                agendaTableBody: document.getElementById('agenda-table-body'),
                directorioTableBody: document.getElementById('directorio-table-body'),
                newsGrid: document.getElementById('news-grid'),
                manualesContainer: document.getElementById('manuales-container'),
                archivosContainer: document.getElementById('archivos-container'),
                monthYearHeader: document.getElementById('month-year-header'),
                calendarGrid: document.getElementById('calendar-grid'),
                newsDetailImage: document.getElementById('news-detail-image'),
                galleryThumbnails: document.getElementById('news-gallery-thumbnails'),
                galleryPrevBtn: document.getElementById('gallery-prev-btn'),
                galleryNextBtn: document.getElementById('gallery-next-btn'),
                modals: {
                    adminLogin: document.getElementById('admin-login-modal'),
                    event: document.getElementById('event-modal'),
                    parroquiano: document.getElementById('parroquiano-modal'),
                    news: document.getElementById('news-modal'),
                    newsDetail: document.getElementById('news-detail-modal'),
                    bloqueManual: document.getElementById('bloque-manual-modal'),
                    manual: document.getElementById('manual-modal'),
                    bloqueArchivo: document.getElementById('bloque-archivo-modal'),
                    archivo: document.getElementById('archivo-modal'),
                    confirm: document.getElementById('confirm-modal'),
                },
                confirmMessage: document.getElementById('confirm-message'),
                confirmDeleteBtn: document.getElementById('confirm-delete-btn'),
            },
            initMobileNav() {
                const navTabs = this.elements.tabsContainer.querySelectorAll('.nav-tab');
                let linksHtml = '';
                navTabs.forEach(tab => {
                    const iconHTML = tab.querySelector('svg').outerHTML;
                    const text = tab.getAttribute('title');
                    linksHtml += `<div class="mobile-nav-link ${tab.classList.contains('active') ? 'active' : ''}" data-target="${tab.dataset.target}">${iconHTML}<span>${text}</span></div>`;
                });
                this.elements.mobileNavLinks.innerHTML = linksHtml;
            },
            showPage(pageId) {
                this.elements.pagesContainer.querySelectorAll('.page').forEach(page => page.classList.toggle('active', page.id === pageId));
                document.querySelectorAll(`[data-target]`).forEach(tab => tab.classList.toggle('active', tab.dataset.target === pageId));
            },
            renderGrid(container, data, cardRenderer, emptyMessage) {
                container.innerHTML = '';
                if (data.length === 0) {
                    container.innerHTML = `<p class="col-span-full text-center text-gray-500">${emptyMessage}</p>`;
                    return;
                }
                 const sortedData = [...data].sort((a, b) => new Date(b.fechaPublicacion) - new Date(a.fechaPublicacion));
                sortedData.forEach(item => container.insertAdjacentHTML('beforeend', cardRenderer(item)));
            },
            renderTable(tbody, data, rowRenderer, emptyMessage) {
                tbody.innerHTML = '';
                if (data.length === 0) {
                    const colSpan = tbody.closest('table')?.querySelector('thead tr').childElementCount || 1;
                    tbody.innerHTML = `<tr><td colspan="${colSpan}" class="p-4 text-center text-gray-500">${emptyMessage}</td></tr>`;
                    return;
                }
                const sortedData = [...data].sort((a, b) => (a.nombre || a.name || '').localeCompare(b.nombre || b.name || ''));
                sortedData.forEach(item => tbody.insertAdjacentHTML('beforeend', rowRenderer(item)));
            },
            createNewsCard(article) {
                const placeholderImage = 'https://placehold.co/600x400/eef0f4/4b5563?text=Noticia';
                return `
                    <div class="neumorphic-card flex flex-col">
                        <img src="${article.imagenUrl || placeholderImage}" alt="Imagen de la noticia" class="rounded-t-2xl h-48 w-full object-cover" onerror="this.src='${placeholderImage}'">
                        <div class="p-4 flex flex-col flex-grow">
                            <h3 class="text-lg font-bold mb-2 break-words">${article.titulo}</h3>
                            <p class="text-sm text-gray-500 mb-2">${new Date(article.fechaPublicacion).toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                            <p class="text-sm mb-4 flex-grow break-words">${article.resumen}</p>
                            <div class="flex justify-between items-center mt-auto">
                                <button data-action="read-more" data-type="news" data-id="${article.id}" class="neumorphic-btn primary btn-sm">Leer Más</button>
                                <div class="admin-only" style="gap: 0.5rem;">
                                    <button data-action="edit" data-type="news" data-id="${article.id}" class="neumorphic-btn btn-sm">Editar</button>
                                    <button data-action="delete" data-type="news" data-id="${article.id}" class="neumorphic-btn danger btn-sm">Eliminar</button>
                                </div>
                            </div>
                        </div>
                    </div>`;
            },
            createEventRow(event) {
                const date = new Date(event.date + 'T00:00:00Z').toLocaleDateString('es-ES', { day: '2-digit', month: 'short', year: 'numeric' });
                return `
                    <tr class="border-b border-gray-300/50">
                        <td class="p-3">${date}</td>
                        <td class="p-3 hidden sm:table-cell">${event.time}</td>
                        <td class="p-3 font-medium">${event.name}</td>
                        <td class="p-3 admin-only-table-cell">
                            <div class="flex gap-2">
                                <button data-action="edit" data-type="event" data-id="${event.id}" class="neumorphic-btn btn-sm">Editar</button>
                                <button data-action="delete" data-type="event" data-id="${event.id}" class="neumorphic-btn danger btn-sm">Eliminar</button>
                            </div>
                        </td>
                    </tr>`;
            },
            createParroquianoRow(p) {
                return `
                    <tr class="border-b border-gray-300/50">
                        <td class="p-3 font-medium">${p.nombre || ''}</td>
                        <td class="p-3 hidden md:table-cell">${p.telefono || ''}</td>
                        <td class="p-3 hidden lg:table-cell">${p.emergencia_nombre || ''}</td>
                        <td class="p-3 admin-only-table-cell">
                             <div class="flex gap-2">
                                <button data-action="edit" data-type="parroquiano" data-id="${p.id}" class="neumorphic-btn btn-sm">Editar</button>
                                <button data-action="delete" data-type="parroquiano" data-id="${p.id}" class="neumorphic-btn danger btn-sm">Eliminar</button>
                            </div>
                        </td>
                    </tr>`;
            },
             renderAccordionBlocks(container, blocks, emptyMessage, typeConfig) {
                container.innerHTML = '';
                if (blocks.length === 0) {
                    container.innerHTML = `<p class="text-center text-gray-500">${emptyMessage}</p>`;
                    return;
                }
                const sortedBlocks = [...blocks].sort((a, b) => (a.nombre || '').localeCompare(b.nombre || ''));
                sortedBlocks.forEach(block => {
                    const items = block.items || [];
                    const itemsHtml = items.length > 0 ? items.map(item => `
                        <li class="flex justify-between items-center p-3 rounded-lg neumorphic-inset">
                            <a href="${item.url}" target="_blank" rel="noopener noreferrer" class="flex-grow truncate hover:text-blue-600 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 flex-shrink-0"><path d="M12.232 4.232a2.5 2.5 0 013.536 3.536l-1.225 1.224a.75.75 0 001.061 1.06l1.224-1.224a4 4 0 00-5.656-5.656l-3 3a4 4 0 00.225 5.865.75.75 0 00.977-1.138 2.5 2.5 0 01-.142-3.665l3-3z" /><path d="M8.603 14.397a2.5 2.5 0 01-3.536-3.536l1.225-1.224a.75.75 0 00-1.061-1.06l-1.224 1.224a4 4 0 005.656 5.656l3-3a4 4 0 00-.225-5.865.75.75 0 00-.977 1.138 2.5 2.5 0 01.142 3.665l-3 3z" /></svg>
                                <span class="truncate">${item.nombre}</span>
                            </a>
                            <div class="admin-only flex-shrink-0 ml-4" style="gap: 0.5rem;">
                                <button data-action="edit" data-type="${typeConfig.item}" data-block-id="${block.id}" data-item-id="${item.id}" class="neumorphic-btn btn-sm">Editar</button>
                                <button data-action="delete" data-type="${typeConfig.item}" data-block-id="${block.id}" data-item-id="${item.id}" class="neumorphic-btn danger btn-sm">Eliminar</button>
                            </div>
                        </li>
                    `).join('') : `<li class="text-sm text-gray-500 p-2">No hay ${typeConfig.plural} en este bloque.</li>`;

                    container.insertAdjacentHTML('beforeend', `
                        <div class="neumorphic-card overflow-hidden">
                            <div class="flex justify-between items-center p-4 cursor-pointer accordion-toggle">
                                <h3 class="text-xl font-bold">${block.nombre}</h3>
                                <div class="flex items-center gap-4">
                                    <div class="admin-only" style="gap: 0.5rem;">
                                        <button data-action="add-${typeConfig.item}" data-modal-target="${typeConfig.item}-modal" data-block-id="${block.id}" class="neumorphic-btn primary btn-sm">Añadir</button>
                                        <button data-action="edit" data-type="${typeConfig.block}" data-id="${block.id}" class="neumorphic-btn btn-sm">Editar</button>
                                        <button data-action="delete" data-type="${typeConfig.block}" data-id="${block.id}" class="neumorphic-btn danger btn-sm">Eliminar</button>
                                    </div>
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor" class="accordion-icon w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" /></svg>
                                </div>
                            </div>
                            <div class="accordion-content">
                                <ul class="p-4 pt-0 space-y-3">${itemsHtml}</ul>
                            </div>
                        </div>`);
                });
            },
            renderCalendar(date, events, parroquianos) {
                const year = date.getFullYear();
                const month = date.getMonth();
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
                this.elements.monthYearHeader.textContent = `${monthNames[month]} ${year}`;
                this.elements.calendarGrid.innerHTML = '';
                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                for (let i = 0; i < firstDayOfMonth; i++) {
                    this.elements.calendarGrid.insertAdjacentHTML('beforeend', `<div class="calendar-cell not-current-month"></div>`);
                }
                for (let day = 1; day <= daysInMonth; day++) {
                    const cellDate = new Date(year, month, day);
                    const isToday = cellDate.getTime() === today.getTime();
                    const cellClasses = `calendar-cell ${isToday ? 'is-today' : ''}`;
                    const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const dailyEvents = events.filter(e => e.date === dateString);
                    const dailyBirthdays = parroquianos.filter(p => {
                        if (!p.nacimiento) return false;
                        const birthDate = new Date(p.nacimiento + 'T00:00:00Z');
                        return birthDate.getMonth() === month && birthDate.getDate() === day;
                    });
                    let itemsHtml = dailyEvents.map(e => `<div class="calendar-item event-item" title="${e.name} a las ${e.time}">${e.name}</div>`).join('');
                    itemsHtml += dailyBirthdays.map(p => `<div class="calendar-item birthday-item" title="Cumpleaños de ${p.nombre}">🎂 ${p.nombre.split(' ')[0]}</div>`).join('');
                    const cellHtml = `<div class="${cellClasses}"><div class="calendar-day-number">${day}</div><div class="calendar-items-container">${itemsHtml}</div></div>`;
                    this.elements.calendarGrid.insertAdjacentHTML('beforeend', cellHtml);
                }
            },
            renderUpcomingEvents(events) {
                this.elements.upcomingEventsList.innerHTML = '';
                const now = new Date();
                now.setHours(0, 0, 0, 0);
                const upcoming = events
                    .filter(event => new Date(event.date + 'T00:00:00Z') >= now)
                    .sort((a, b) => new Date(`${a.date}T${a.time}`) - new Date(`${b.date}T${b.time}`))
                    .slice(0, 5);

                if (upcoming.length === 0) {
                    this.elements.upcomingEventsList.innerHTML = '<li class="text-gray-500">No hay próximos eventos.</li>';
                    return;
                }
                upcoming.forEach(event => {
                    const placeholderImage = 'https://placehold.co/100x100/eef0f4/4b5563?text=Evento';
                    this.elements.upcomingEventsList.insertAdjacentHTML('beforeend', `
                        <li class="flex items-center gap-4 p-3 rounded-lg neumorphic-inset">
                            <img src="${event.imageUrl || placeholderImage}" alt="Imagen del evento" class="w-16 h-16 object-cover rounded-lg flex-shrink-0" onerror="this.src='${placeholderImage}'">
                            <div class="overflow-hidden">
                                <p class="font-semibold truncate">${event.name}</p>
                                <p class="text-sm text-gray-500">${new Date(event.date + 'T00:00:00Z').toLocaleDateString('es-ES', { month: 'long', day: 'numeric' })} - ${event.time}h</p>
                            </div>
                        </li>`);
                });
            },
            renderBirthdayReminders(parroquianos) {
                const today = new Date();
                const todayMonth = today.getMonth() + 1;
                const todayDay = today.getDate();
                const birthdayFolks = parroquianos.filter(p => {
                    if (!p.nacimiento) return false;
                    const birthDate = new Date(p.nacimiento + 'T00:00:00Z');
                    return (birthDate.getMonth() + 1 === todayMonth) && (birthDate.getDate() === todayDay);
                });
                this.elements.birthdayList.innerHTML = '';
                if (birthdayFolks.length === 0) {
                    this.elements.birthdayCard.style.display = 'none';
                } else {
                    this.elements.birthdayCard.style.display = 'block';
                    birthdayFolks.forEach(person => {
                        this.elements.birthdayList.insertAdjacentHTML('beforeend', `
                            <li class="flex items-center gap-4 p-3 rounded-lg neumorphic-inset">
                                <div class="text-amber-500"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-8 h-8"><path fill-rule="evenodd" d="M10.868 2.884c.321-.772 1.415-.772 1.736 0l1.681 4.06c.064.155.19.283.348.333l4.48.653c.84.123 1.171 1.157.536 1.748l-3.242 3.159c-.12.117-.175.284-.15.444l.764 4.463c.145.845-.733 1.493-1.488 1.085l-4.01-2.108a.75.75 0 00-.702 0l-4.01 2.108c-.755.408-1.633-.24-1.488-1.085l.764-4.463c.025-.16-.03-.327-.15-.444l-3.242-3.159c-.635-.591-.304-1.625.536-1.748l4.48-.653c.158-.023.284-.15.348-.333l1.681-4.06z" clip-rule="evenodd" /></svg></div>
                                <div><p class="font-semibold">${person.nombre}</p><p class="text-sm">¡Hoy es su cumpleaños!</p></div>
                            </li>`);
                    });
                }
            },
            updateDateTime() {
                const now = new Date();
                this.elements.currentDate.textContent = now.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
                this.elements.currentTime.textContent = now.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
            },
             updateLockscreenTime() {
                const now = new Date();
                if (this.elements.lockscreenTime) {
                    this.elements.lockscreenTime.textContent = now.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                }
                if (this.elements.lockscreenDate) {
                    this.elements.lockscreenDate.textContent = now.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
                }
            },
            updateWeatherUI(data) {
                if (data.temp !== undefined) {
                    this.elements.weatherTemp.textContent = `${Math.round(data.temp)}°C`;
                    this.elements.weatherDesc.textContent = data.description.charAt(0).toUpperCase() + data.description.slice(1);
                    this.elements.weatherLocation.textContent = data.location;
                } else {
                    this.elements.weatherTemp.textContent = '--°C';
                    this.elements.weatherDesc.textContent = data.description;
                    this.elements.weatherLocation.textContent = data.location || '';
                }
            },
            showGalleryImage(index) {
                const { newsDetailImage, galleryThumbnails } = this.elements;
                newsDetailImage.style.opacity = 0;
                setTimeout(() => {
                    newsDetailImage.src = App.state.currentGalleryImages[index] || 'https://placehold.co/800x600/eef0f4/4b5563?text=Imagen+no+disponible';
                    newsDetailImage.style.opacity = 1;
                }, 150);
                galleryThumbnails.querySelectorAll('.gallery-thumbnail').forEach((thumb, i) => {
                    thumb.classList.toggle('active', i === index);
                    if (i === index) thumb.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                });
                App.state.currentGalleryIndex = index;
            },
            updateAdminUI(isAdmin) {
                this.elements.appContainer.classList.toggle('admin-mode', isAdmin);
                this.elements.adminControlsContainer.innerHTML = isAdmin 
                    ? `<button id="logout-btn" class="neumorphic-btn danger p-3" title="Cerrar Sesión"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m-3 0l-3-3m0 0l3-3m-3 3H9" /></svg></button>` 
                    : `<button id="login-btn" class="neumorphic-btn p-3" title="Acceso de Administrador"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15m3 0l3-3m0 0l-3-3m3 3H9" /></svg></button>`;
            }
        };

        const FirebaseService = {
            db: null, auth: null, appIdPath: '', basePaths: {},
            async init(onAuthReadyCallback) {
                const firebaseConfig = {
                    apiKey: "AIzaSyATCd0jgG2Lo5q8K5bB15eNvkakJBb15RU", authDomain: "ibcgapp.firebaseapp.com",
                    projectId: "ibcgapp", storageBucket: "ibcgapp.appspot.com",
                    messagingSenderId: "548258029551", appId: "1:548258029551:web:9354e4cc79ce4f25f0201a",
                    measurementId: "G-RBN8KZPJ5X"
                };
                const app = initializeApp(firebaseConfig);
                this.db = getFirestore(app);
                this.auth = getAuth(app);
                this.appIdPath = `artifacts/${firebaseConfig.projectId}`;
                this.basePaths = { events: `public/data/events`, parroquianos: `public/data/parroquianos`, news: `public/data/news`, manuales: `public/data/manuales`, archivos: `public/data/archivos` };
                onAuthStateChanged(this.auth, (user) => onAuthReadyCallback());
                await signInAnonymously(this.auth);
            },
            _getCollectionPath(type) {
                const pathTemplate = this.basePaths[type];
                if (!pathTemplate) throw new Error(`Collection type "${type}" not defined.`);
                return `${this.appIdPath}/${pathTemplate}`;
            },
            onCollectionSnapshot(type, callback) {
                const path = this._getCollectionPath(type);
                if (!path) return () => {};
                return onSnapshot(collection(this.db, path), (snapshot) => {
                    callback(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                }, (error) => console.error(`Error en listener de ${type}: `, error));
            },
            async saveDoc(type, id, data) {
                const collectionPath = this._getCollectionPath(type);
                if (id) {
                    await updateDoc(doc(this.db, collectionPath, id), data);
                } else {
                    if (type === 'news' && !data.fechaPublicacion) data.fechaPublicacion = new Date().toISOString();
                    await addDoc(collection(this.db, collectionPath), data);
                }
            },
            async deleteDoc(type, id) {
                const path = this._getCollectionPath(type);
                return deleteDoc(doc(this.db, path, id));
            }
        };

        const WeatherService = {
            API_KEY: '9a11de307931b3ba88e6af9048b7f3b1',
            async fetch() {
                const lat = 19.5437, lon = -96.91;
                const url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${this.API_KEY}&units=metric&lang=es`;
                try {
                    const response = await fetch(url);
                    const data = await response.json();
                    if (response.status === 401) throw new Error('Invalid API key');
                    if (!response.ok || !data.main) throw new Error(data.message || 'Respuesta inválida de la API');
                    return { temp: data.main.temp, description: data.weather[0].description, location: data.name };
                } catch (error) {
                    console.error("Error al obtener el clima:", error);
                    return { description: error.message === 'Invalid API key' ? 'Clave API inválida' : 'Error de red' };
                }
            }
        };
        
        const App = {
            state: { isAdmin: false, events: [], parroquianos: [], news: [], manuales: [], archivos: [], currentGalleryImages: [], currentGalleryIndex: 0, },
            currentCalendarDate: new Date(),
            async init() {
                try {
                    UI.elements.appLoading.style.display = 'flex';
                    this.checkAdminSession();
                    UI.initMobileNav();
                    this.setupEventListeners();
                    UI.updateDateTime();
                    UI.updateLockscreenTime();
                    setInterval(() => {
                        UI.updateDateTime();
                        UI.updateLockscreenTime();
                    }, 60000);
                    await FirebaseService.init(this.onAuthReady.bind(this));
                } catch (error) {
                     console.error("Error fatal durante la inicialización:", error);
                    document.body.innerHTML = `<div class="fixed inset-0 bg-red-100 text-red-800 p-8 flex flex-col justify-center items-center text-center"><h1 class="text-3xl font-bold mb-4">¡Ups! Ocurrió un error crítico.</h1><p class="mb-4">${error.message}</p></div>`;
                }
            },
            onAuthReady() {
                this.setupDataListeners();
                this.loadWeather();
                UI.renderCalendar(this.currentCalendarDate, this.state.events, this.state.parroquianos);
                UI.elements.appLoading.style.display = 'none';
                UI.elements.appContainer.classList.add('loaded');
            },
            setupDataListeners() {
                FirebaseService.onCollectionSnapshot('events', d => { this.state.events = d; UI.renderTable(UI.elements.agendaTableBody, d, UI.createEventRow, 'No hay eventos.'); UI.renderUpcomingEvents(d); UI.renderCalendar(this.currentCalendarDate, d, this.state.parroquianos); });
                FirebaseService.onCollectionSnapshot('parroquianos', d => { this.state.parroquianos = d; UI.renderTable(UI.elements.directorioTableBody, d, UI.createParroquianoRow, 'No hay registros.'); UI.renderBirthdayReminders(d); UI.renderCalendar(this.currentCalendarDate, this.state.events, d); });
                FirebaseService.onCollectionSnapshot('news', d => { this.state.news = d; UI.renderGrid(UI.elements.newsGrid, d, UI.createNewsCard, 'No hay noticias.'); });
                FirebaseService.onCollectionSnapshot('manuales', d => { this.state.manuales = d; UI.renderAccordionBlocks(UI.elements.manualesContainer, d, 'No hay manuales disponibles.', {plural: 'manuales', block: 'bloqueManual', item: 'manual'}); });
                FirebaseService.onCollectionSnapshot('archivos', d => { this.state.archivos = d; UI.renderAccordionBlocks(UI.elements.archivosContainer, d, 'No hay archivos disponibles.', {plural: 'archivos', block: 'bloqueArchivo', item: 'archivo'}); });
            },
            toggleSidenav(open, isFinal) {
                const sidenav = UI.elements.mobileSidenav;
                if (isFinal) {
                    sidenav.classList.add('is-transitioning');
                    sidenav.style.transform = open ? 'translateX(0)' : 'translateX(-100%)';
                    UI.elements.mobileSidenavOverlay.classList.toggle('active', open);
                } else {
                    sidenav.classList.remove('is-transitioning');
                    sidenav.style.transform = `translateX(${open ? 0 : -sidenav.offsetWidth}px)`;
                }
            },
            setupEventListeners() {
                const unlockSwitch = document.getElementById('unlock-switch');
                if (unlockSwitch) {
                    const unlock = () => {
                        const lockscreenEl = document.getElementById('app-lockscreen');
                        if (lockscreenEl) {
                            lockscreenEl.classList.add('fade-out');
                            lockscreenEl.addEventListener('transitionend', () => {
                                lockscreenEl.style.display = 'none';
                            }, { once: true });
                        }
                    };
                    unlockSwitch.addEventListener('change', () => {
                        if (unlockSwitch.checked) {
                            setTimeout(unlock, 300); // Esperar la animación del switch
                        }
                    });
                }

                UI.elements.tabsContainer.addEventListener('click', e => { const t = e.target.closest('.nav-tab'); if (t) UI.showPage(t.dataset.target); });
                const sidenav = UI.elements.mobileSidenav; let touchStartX=0,touchCurrentX=0,isDraggingSidenav=false; const sidenavWidth=280;
                const handleDragStart = cX => { touchStartX=cX; isDraggingSidenav=true; sidenav.classList.remove('is-transitioning'); };
                const handleDragMove = cX => { if (!isDraggingSidenav) return; touchCurrentX=cX; const dX=touchCurrentX-touchStartX; const cT=sidenav.classList.contains('active')?0:-sidenavWidth; let nT=Math.min(0,Math.max(-sidenavWidth,cT+dX)); sidenav.style.transform=`translateX(${nT}px)`; };
                const handleDragEnd = () => { if (!isDraggingSidenav) return; isDraggingSidenav=false; const dX=touchCurrentX-touchStartX; const isOpen=sidenav.classList.contains('active'); if(Math.abs(dX)>50||Math.abs(dX)>sidenavWidth/3) { if(dX>0&&!isOpen){sidenav.classList.add('active');this.toggleSidenav(true,true);}else if(dX<0&&isOpen){sidenav.classList.remove('active');this.toggleSidenav(false,true);}else{this.toggleSidenav(isOpen,true);}}else{this.toggleSidenav(isOpen,true);} touchStartX=0; touchCurrentX=0; };
                document.body.addEventListener('touchstart', e => { if (e.touches[0].clientX < 40 && !e.target.closest('.fixed.inset-0:not(.hidden)')) handleDragStart(e.touches[0].clientX); }, { passive: true });
                document.body.addEventListener('touchmove', e => { if (isDraggingSidenav) handleDragMove(e.touches[0].clientX); }, { passive: true });
                document.body.addEventListener('touchend', handleDragEnd);
                UI.elements.edgeHandle.addEventListener('click', () => { const o = sidenav.classList.toggle('active'); this.toggleSidenav(o, true); });
                UI.elements.closeSidenavBtn.addEventListener('click', () => { sidenav.classList.remove('active'); this.toggleSidenav(false, true); });
                UI.elements.mobileSidenavOverlay.addEventListener('click', () => { sidenav.classList.remove('active'); this.toggleSidenav(false, true); });
                UI.elements.mobileNavLinks.addEventListener('click', e => { const l = e.target.closest('.mobile-nav-link'); if (l) { UI.showPage(l.dataset.target); sidenav.classList.remove('active'); this.toggleSidenav(false, true); } });
                document.getElementById('prev-month-btn').addEventListener('click', () => { this.currentCalendarDate.setMonth(this.currentCalendarDate.getMonth() - 1); UI.renderCalendar(this.currentCalendarDate, this.state.events, this.state.parroquianos); });
                document.getElementById('next-month-btn').addEventListener('click', () => { this.currentCalendarDate.setMonth(this.currentCalendarDate.getMonth() + 1); UI.renderCalendar(this.currentCalendarDate, this.state.events, this.state.parroquianos); });
                UI.elements.galleryPrevBtn.addEventListener('click', () => { let n = this.state.currentGalleryIndex-1; if(n<0)n=this.state.currentGalleryImages.length-1; UI.showGalleryImage(n); });
                UI.elements.galleryNextBtn.addEventListener('click', () => { let n = this.state.currentGalleryIndex+1; if(n>=this.state.currentGalleryImages.length)n=0; UI.showGalleryImage(n); });
                document.addEventListener('click', e => {
                    const b = e.target.closest('button, .gallery-thumbnail, .accordion-toggle'); if (!b) return;
                    if (b.matches('.accordion-toggle')) {
                        b.classList.toggle('active');
                        const content = b.nextElementSibling;
                        if (content.style.maxHeight) {
                            content.style.maxHeight = null;
                        } else {
                            content.style.maxHeight = content.scrollHeight + "px";
                        }
                        return;
                    }
                    if (b.id==='login-btn')this.openModal('adminLogin');
                    if(b.id==='logout-btn')this.handleLogout();
                    if(b.dataset.modalTarget) {
                        const blockId = b.dataset.blockId;
                        this.openModal(b.dataset.modalTarget, null, blockId);
                    }
                    if(b.matches('.gallery-thumbnail')){UI.showGalleryImage(parseInt(b.dataset.index,10));return;}
                    const a=b.dataset.action;
                    if(a==='close-modal'){const m=b.closest('.fixed.inset-0'); if(m)this.closeModal(m.id);}
                    if(a==='add-manual') { this.openModal('manual-modal', null, b.dataset.blockId); }
                    if(a==='add-archivo') { this.openModal('archivo-modal', null, b.dataset.blockId); }
                    if(['edit','delete','read-more'].includes(a)){const{type,id,blockId,itemId}=b.dataset; if(a==='edit')this.handleEdit(type,id,blockId,itemId); if(a==='delete')this.handleDelete(type,id,blockId,itemId); if(a==='read-more')this.handleReadMore(type,id);}
                });
                Object.values(UI.elements.modals).forEach(m => m.addEventListener('click', e => { if (e.target === m) this.closeModal(m.id); }));
                document.addEventListener('submit', e => { e.preventDefault(); if (e.target.id === 'admin-login-form') this.handleAdminLoginAttempt(e.target); else if (e.target.matches('form')) this.handleFormSubmit(e.target); });
            },
            async loadWeather() { UI.updateWeatherUI(await WeatherService.fetch()); },
            checkAdminSession() { if(sessionStorage.getItem('isAdmin')==='true')this.state.isAdmin=true; UI.updateAdminUI(this.state.isAdmin); },
            handleAdminLoginAttempt(form) {
                const pass = form.querySelector('#admin-password').value;
                const err = form.querySelector('#login-error-msg');
                if (pass === 'parroquia2024') { this.state.isAdmin=true; sessionStorage.setItem('isAdmin','true'); UI.updateAdminUI(true); this.closeModal('adminLogin'); form.reset(); err.classList.add('hidden'); }
                else { err.classList.remove('hidden'); }
            },
            handleLogout() { this.state.isAdmin=false; sessionStorage.removeItem('isAdmin'); UI.updateAdminUI(false); },
            async handleFormSubmit(form) {
                if (!this.state.isAdmin) return;
                const submitButton = form.querySelector('button[type="submit"]');
                if (submitButton) submitButton.disabled = true;

                try {
                    const type = form.dataset.type;
                    const data = Object.fromEntries(new FormData(form).entries());
                    const id = data.id;
                    delete data.id;
                    
                    const blockTypes = {
                        bloqueManual: 'manuales',
                        bloqueArchivo: 'archivos'
                    };
                    const itemTypes = {
                        manual: { collection: 'manuales', state: 'manuales' },
                        archivo: { collection: 'archivos', state: 'archivos' }
                    };

                    if (blockTypes[type]) {
                        if (!id) data.items = [];
                        await FirebaseService.saveDoc(blockTypes[type], id, data);
                        this.closeModal(`${type}-modal`);
                    } else if (itemTypes[type]) {
                        const config = itemTypes[type];
                        const { blockId, ...itemData } = data;
                        const block = this.state[config.state].find(b => b.id === blockId);
                        if (!block) throw new Error("Block not found");

                        const items = block.items || [];
                        if (itemData.id) {
                            const index = items.findIndex(item => item.id === itemData.id);
                            if (index > -1) items[index] = { ...items[index], ...itemData };
                        } else {
                             itemData.id = crypto.randomUUID();
                             items.push(itemData);
                        }
                        await FirebaseService.saveDoc(config.collection, blockId, { items });
                        this.closeModal(`${type}-modal`);

                    } else if (type === 'news') {
                         if (data.galleryUrls) data.galleryUrls = data.galleryUrls.split('\n').map(url => url.trim()).filter(Boolean); else data.galleryUrls = [];
                        await FirebaseService.saveDoc('news', id, data);
                        this.closeModal('news-modal');
                    } else {
                        const serviceType = type + 's';
                        await FirebaseService.saveDoc(serviceType, id, data);
                        this.closeModal(`${type}-modal`);
                    }
                } catch (err) {
                    console.error(`Error al guardar:`, err);
                } finally {
                    if (submitButton) submitButton.disabled = false;
                }
            },
            handleReadMore(type, id) {
                if(type!=='news')return; const item=this.state.news.find(i=>i.id===id); if(!item)return;
                const modal=UI.elements.modals.newsDetail; const{galleryThumbnails,galleryPrevBtn,galleryNextBtn}=UI.elements;
                modal.querySelector('#news-detail-title').textContent=item.titulo;
                modal.querySelector('#news-detail-date').textContent=new Date(item.fechaPublicacion).toLocaleDateString('es-ES',{year:'numeric',month:'long',day:'numeric'});
                modal.querySelector('#news-detail-content').innerHTML=item.contenido.replace(/\n/g,'<br>');
                this.state.currentGalleryImages=[item.imagenUrl, ...(item.galleryUrls||[])].filter(Boolean); this.state.currentGalleryIndex=0;
                galleryThumbnails.innerHTML='';
                if(this.state.currentGalleryImages.length > 0){ this.state.currentGalleryImages.forEach((url,index)=>{galleryThumbnails.insertAdjacentHTML('beforeend',`<img src="${url}" data-index="${index}" class="gallery-thumbnail ${index===0?'active':''}">`);}); UI.showGalleryImage(0);}else{UI.elements.newsDetailImage.src='https://placehold.co/800x600/eef0f4/4b5563?text=Sin+Imagen';}
                const showBtns = this.state.currentGalleryImages.length > 1;
                galleryPrevBtn.classList.toggle('hidden',!showBtns); galleryNextBtn.classList.toggle('hidden',!showBtns);
                this.openModal('newsDetail');
            },
            handleEdit(type, id, blockId, itemId) {
                if(!this.state.isAdmin) return;
                const itemTypes = {
                    manual: { state: 'manuales', modal: 'manual-modal' },
                    archivo: { state: 'archivos', modal: 'archivo-modal' }
                };
                const blockTypes = {
                    bloqueManual: { state: 'manuales', modal: 'bloque-manual-modal' },
                    bloqueArchivo: { state: 'archivos', modal: 'bloque-archivo-modal' },
                }

                if (itemTypes[type]) {
                    const config = itemTypes[type];
                    const block = this.state[config.state].find(b => b.id === blockId);
                    const item = block?.items.find(i => i.id === itemId);
                    if (item) this.openModal(config.modal, { ...item, blockId });
                } else {
                    const collectionName = blockTypes[type]?.state || (type === 'news' ? 'news' : type + 's');
                    const modalId = blockTypes[type]?.modal || `${type}-modal`;
                    const item = this.state[collectionName].find(i => i.id === id);
                    if (item) this.openModal(modalId, item);
                }
            },
            handleDelete(type, id, blockId, itemId) {
                if (!this.state.isAdmin) return;
                const modal = UI.elements.modals.confirm;
                modal.querySelector('#confirm-message').textContent = `¿Seguro de eliminar este registro?`;
                this.openModal('confirm');

                UI.elements.confirmDeleteBtn.onclick = async () => {
                    try {
                         const itemTypes = {
                            manual: { collection: 'manuales', state: 'manuales' },
                            archivo: { collection: 'archivos', state: 'archivos' }
                        };
                        const blockTypes = {
                            bloqueManual: 'manuales',
                            bloqueArchivo: 'archivos'
                        };

                        if (itemTypes[type]) {
                            const config = itemTypes[type];
                            const block = this.state[config.state].find(b => b.id === blockId);
                            if (block) {
                                const items = (block.items || []).filter(item => item.id !== itemId);
                                await FirebaseService.saveDoc(config.collection, blockId, { items });
                            }
                        } else {
                            const serviceType = blockTypes[type] || (type === 'news' ? 'news' : type + 's');
                            await FirebaseService.deleteDoc(serviceType, id);
                        }
                        this.closeModal('confirm');
                    } catch (err) {
                        console.error(`Error al eliminar ${type}:`, err);
                    }
                };
            },
            openModal(modalId, data = null, blockId = null) {
                const modal = UI.elements.modals[modalId.replace('-modal','')] || document.getElementById(modalId);
                if (!modal) return;
                const form = modal.querySelector('form');
                if (form) {
                    form.reset();
                    const titleEl = modal.querySelector('h2'); 
                    const type = form.dataset.type;
                    let typeName = {
                        'bloqueManual': 'Bloque de Manual', 'manual': 'Manual',
                        'bloqueArchivo': 'Bloque de Archivo', 'archivo': 'Archivo',
                        'news': 'Noticia', 'event': 'Evento', 'parroquiano': 'Parroquiano'
                    }[type] || type;

                    if (modalId !== 'admin-login-modal') {
                        if (titleEl) titleEl.textContent = data ? `Editar ${typeName}` : `Agregar ${typeName}`;
                    }

                    if (data) {
                        Object.keys(data).forEach(key => {
                            const input = form.querySelector(`[name="${key}"]`);
                            if (input) {
                                if (key === 'galleryUrls' && Array.isArray(data[key])) input.value = data[key].join('\n');
                                else input.value = data[key];
                            }
                        });
                    }
                    if (blockId) {
                         const blockIdInput = form.querySelector('input[name="blockId"]');
                         if (blockIdInput) blockIdInput.value = blockId;
                    }
                }
                modal.classList.remove('hidden');
            },
            closeModal(modalId) { const modal = UI.elements.modals[modalId.replace('-modal','')] || document.getElementById(modalId); if (modal) modal.classList.add('hidden'); },
        };

        App.init();
    </script>
</body>
</html>
